<<<<<<< HEAD
{"version":3,"file":"index.esm.js","sources":["../lib/schemas/config.js","../lib/logger.js","../lib/utils.js","../lib/server/rate_limit.js","../lib/fetch.js","../lib/cache.js","../lib/browser.js","../lib/export.js","../lib/benchmark.js","../templates/svg_export/svg_export.js","../lib/config.js","../lib/chart.js","../lib/pool.js","../lib/server/routes/health.js","../lib/server/routes/export.js","../lib/server/server.js","../lib/server/routes/ui.js","../lib/server/routes/change-hc-version.js","../lib/index.js"],"sourcesContent":["/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\n// Load .env into environment variables\nimport dotenv from 'dotenv';\n\ndotenv.config();\n\n// This is the configuration object with all options and their default values,\n// also from the .env file if one exists\nexport const defaultConfig = {\n  puppeteer: {\n    args: {\n      value: [],\n      type: 'string[]',\n      description: 'Array of arguments to send to puppeteer.'\n    }\n  },\n  highcharts: {\n    version: {\n      value: 'latest',\n      envLink: 'HIGHCHARTS_VERSION',\n      type: 'string',\n      description: 'Highcharts version to use.'\n    },\n    cdnURL: {\n      value: 'https://code.highcharts.com/',\n      envLink: 'HIGHCHARTS_CDN',\n      type: 'string',\n      description: 'The CDN URL of Highcharts scripts to use.'\n    },\n    coreScripts: {\n      envLink: 'HIGHCHARTS_CORE_SCRIPTS',\n      value: ['highcharts', 'highcharts-more', 'highcharts-3d'],\n      type: 'string[]',\n      description: 'Highcharts core scripts to fetch.'\n    },\n    modules: {\n      envLink: 'HIGHCHARTS_MODULES',\n      value: [\n        'stock',\n        'map',\n        'gantt',\n        'exporting',\n        'export-data',\n        'parallel-coordinates',\n        'accessibility',\n        'annotations-advanced',\n        'boost-canvas',\n        'boost',\n        'data',\n        'draggable-points',\n        'static-scale',\n        'broken-axis',\n        'heatmap',\n        'tilemap',\n        'timeline',\n        'treemap',\n        'item-series',\n        'drilldown',\n        'histogram-bellcurve',\n        'bullet',\n        'funnel',\n        'funnel3d',\n        'pyramid3d',\n        'networkgraph',\n        'pareto',\n        'pattern-fill',\n        'pictorial',\n        'price-indicator',\n        'sankey',\n        'arc-diagram',\n        'dependency-wheel',\n        'series-label',\n        'solid-gauge',\n        'sonification',\n        'stock-tools',\n        'streamgraph',\n        'sunburst',\n        'variable-pie',\n        'variwide',\n        'vector',\n        'venn',\n        'windbarb',\n        'wordcloud',\n        'xrange',\n        'no-data-to-display',\n        'drag-panes',\n        'debugger',\n        'dumbbell',\n        'lollipop',\n        'cylinder',\n        'organization',\n        'dotplot',\n        'marker-clusters',\n        'hollowcandlestick',\n        'heikinashi'\n      ],\n      type: 'string[]',\n      description: 'Highcharts modules to fetch.'\n    },\n    indicators: {\n      envLink: 'HIGHCHARTS_INDICATORS',\n      value: ['indicators-all'],\n      type: 'string[]',\n      description: 'Highcharts indicators to fetch.'\n    },\n    scripts: {\n      value: [\n        'https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js'\n      ],\n      type: 'string[]',\n      description:\n        'Additional direct scripts/optional dependencies (e.g. moment.js).'\n    }\n  },\n  export: {\n    infile: {\n      value: false,\n      type: 'string',\n      description:\n        'The input file name along with a type (json or svg). It can be a correct JSON or SVG file.'\n    },\n    instr: {\n      value: false,\n      type: 'string',\n      description:\n        'An input in a form of a stringified JSON or SVG file. Overrides the --infile.'\n    },\n    options: {\n      value: false,\n      type: 'string',\n      description: 'An alias for the --instr option.'\n    },\n    outfile: {\n      value: false,\n      type: 'string',\n      description:\n        'The output filename along with a type (jpeg, png, pdf or svg). Ignores the --type flag.'\n    },\n    type: {\n      envLink: 'EXPORT_DEFAULT_TYPE',\n      value: 'png',\n      type: 'string',\n      description:\n        'The format of the file to export to. Can be jpeg, png, pdf or svg.'\n    },\n    constr: {\n      envLink: 'EXPORT_DEFAULT_CONSTR',\n      value: 'chart',\n      type: 'string',\n      description:\n        'The constructor to use. Can be chart, stockChart, mapChart or ganttChart.'\n    },\n    defaultHeight: {\n      envLink: 'EXPORT_DEFAULT_HEIGHT',\n      value: 400,\n      type: 'number',\n      description:\n        'The default height of the exported chart. Used when not found any value set.'\n    },\n    defaultWidth: {\n      envLink: 'EXPORT_DEFAULT_WIDTH',\n      value: 600,\n      type: 'number',\n      description:\n        'The default width of the exported chart. Used when not found any value set.'\n    },\n    defaultScale: {\n      envLink: 'EXPORT_DEFAULT_SCALE',\n      value: 1,\n      type: 'number',\n      description:\n        'The default scale of the exported chart. Ranges between 1 and 5.'\n    },\n    height: {\n      type: 'number',\n      value: false,\n      description:\n        'The default height of the exported chart. Overrides the option in the chart settings.'\n    },\n    width: {\n      type: 'number',\n      value: false,\n      description:\n        'The width of the exported chart. Overrides the option in the chart settings.'\n    },\n    scale: {\n      value: false,\n      type: 'number',\n      description: 'The scale of the exported chart. Ranges between 1 and 5.'\n    },\n    globalOptions: {\n      value: false,\n      type: 'string',\n      description:\n        'A stringified JSON or a filename with options to be passed into the Highcharts.setOptions.'\n    },\n    themeOptions: {\n      value: false,\n      type: 'string',\n      description:\n        'A stringified JSON or a filename with theme options to be passed into the Highcharts.setOptions.'\n    },\n    batch: {\n      value: false,\n      type: 'string',\n      description:\n        'Starts a batch job. A string that contains input/output pairs: \"in=out;in=out;..\".'\n    }\n  },\n  customCode: {\n    allowCodeExecution: {\n      envLink: 'HIGHCHARTS_ALLOW_CODE_EXECUTION',\n      value: false,\n      type: 'boolean',\n      description:\n        'If set to true, allow for the execution of arbitrary code when exporting.'\n    },\n    allowFileResources: {\n      envLink: 'HIGHCHARTS_ALLOW_FILE_RESOURCES',\n      value: true,\n      type: 'boolean',\n      description:\n        'Allow injecting resources from the filesystem. Has no effect when running as a server.'\n    },\n    customCode: {\n      value: false,\n      type: 'string',\n      description:\n        'A function to be called before chart initialization. Can be a filename with the js extension.'\n    },\n    callback: {\n      value: false,\n      type: 'string',\n      description: 'A JavaScript file with a function to run on construction.'\n    },\n    resources: {\n      value: false,\n      type: 'string',\n      description:\n        'An additional resource in a form of stringified JSON. It can contain files, js and css sections.'\n    },\n    loadConfig: {\n      value: false,\n      type: 'string',\n      description: 'A file that contains a pre-defined config to use.'\n    },\n    createConfig: {\n      value: false,\n      type: 'string',\n      description:\n        'Allows to set options through a prompt and save in a provided config file.'\n    }\n  },\n  server: {\n    enable: {\n      envLink: 'HIGHCHARTS_SERVER_ENABLE',\n      value: false,\n      type: 'boolean',\n      cliName: 'enableServer',\n      description: 'If set to true, starts a server on 0.0.0.0.'\n    },\n    host: {\n      envLink: 'HIGHCHARTS_SERVER_HOST',\n      value: '0.0.0.0',\n      type: 'string',\n      description:\n        'The hostname of the server. Also starts a server listening on the supplied hostname.'\n    },\n    port: {\n      envLink: 'HIGHCHARTS_SERVER_PORT',\n      value: 7801,\n      type: 'number',\n      description: 'The port to use for the server. Defaults to 7801.'\n    },\n    ssl: {\n      enable: {\n        envLink: 'HIGHCHARTS_SERVER_SSL_ENABLE',\n        value: false,\n        type: 'boolean',\n        cliName: 'enableSsl',\n        description: 'Enables the SSL protocol.'\n      },\n      force: {\n        envLink: 'HIGHCHARTS_SERVER_SSL_FORCE',\n        value: false,\n        type: 'boolean',\n        cliName: 'sslForced',\n        description:\n          'If set to true, forces the server to only serve over HTTPS.'\n      },\n      port: {\n        envLink: 'HIGHCHARTS_SERVER_SSL_PORT',\n        value: 443,\n        type: 'number',\n        cliName: 'sslPort',\n        description: 'The port on which to run the SSL server.'\n      },\n      certPath: {\n        envLink: 'HIGHCHARTS_SSL_CERT_PATH',\n        value: '',\n        type: 'string',\n        description: 'The path to the SSL certificate/key.'\n      }\n    },\n    rateLimiting: {\n      enable: {\n        envLink: 'HIGHCHARTS_RATE_LIMIT_ENABLE',\n        value: false,\n        type: 'boolean',\n        cliName: 'enableRateLimiting',\n        description: 'Enables rate limiting.'\n      },\n      maxRequests: {\n        envLink: 'HIGHCHARTS_RATE_LIMIT_MAX',\n        value: 10,\n        type: 'number',\n        description: 'Max requests allowed in a one minute.'\n      },\n      window: {\n        envLink: 'HIGHCHARTS_RATE_LIMIT_WINDOW',\n        value: 1,\n        type: 'number',\n        description: 'The time window in minutes for rate limiting.'\n      },\n      delay: {\n        envLink: 'HIGHCHARTS_RATE_LIMIT_DELAY',\n        value: 0,\n        type: 'number',\n        description: 'The amount to delay each successive request before hitting the max.'\n      },\n      trustProxy: {\n        envLink: 'HIGHCHARTS_RATE_LIMIT_TRUST_PROXY',\n        value: false,\n        type: 'boolean',\n        description: 'Set this to true if behind a load balancer.'\n      },\n      skipKey: {\n        envLink: 'HIGHCHARTS_RATE_LIMIT_SKIP_KEY',\n        value: '',\n        type: 'number|string',\n        description:\n          'Allows bypassing the rate limiter and should be provided with skipToken argument.'\n      },\n      skipToken: {\n        envLink: 'HIGHCHARTS_RATE_LIMIT_SKIP_TOKEN',\n        value: '',\n        type: 'number|string',\n        description:\n          'Allows bypassing the rate limiter and should be provided with skipKey argument.'\n      }\n    }\n  },\n  pool: {\n    initialWorkers: {\n      envLink: 'HIGHCHARTS_POOL_MIN_WORKERS',\n      value: 4,\n      type: 'number',\n      description: 'The number of initial workers to spawn.'\n    },\n    maxWorkers: {\n      envLink: 'HIGHCHARTS_POOL_MAX_WORKERS',\n      value: 8,\n      type: 'number',\n      description: 'The number of max workers to spawn.'\n    },\n    workLimit: {\n      envLink: 'HIGHCHARTS_POOL_WORK_LIMIT',\n      value: 40,\n      type: 'number',\n      description:\n        'The pieces of work that can be performed before restarting process.'\n    },\n    queueSize: {\n      envLink: 'HIGHCHARTS_POOL_QUEUE_SIZE',\n      value: 5,\n      type: 'number',\n      description: 'The size of the request overflow queue.'\n    },\n    timeoutThreshold: {\n      envLink: 'HIGHCHARTS_POOL_TIMEOUT',\n      value: 5000,\n      type: 'number',\n      description: 'The number of milliseconds before timing out.'\n    },\n    acquireTimeout: {\n      envLink: 'HIGHCHARTS_POOL_ACQUIRE_TIMEOUT',\n      value: 5000,\n      type: 'number',\n      description: 'The number of milliseconds to wait for acquiring a resource.'\n    },\n    reaper: {\n      envLink: 'HIGHCHARTS_POOL_ENABLE_REAPER',\n      value: true,\n      type: 'boolean',\n      description:\n        'Whether or not to evict workers after a certain time period.'\n    },\n    benchmarking: {\n      envLink: 'HIGHCHARTS_POOL_BENCHMARKING',\n      value: false,\n      type: 'boolean',\n      description: 'Enable benchmarking.'\n    },\n    listenToProcessExits: {\n      envLink: 'HIGHCHARTS_POOL_LISTEN_TO_PROCESS_EXITS',\n      value: true,\n      type: 'boolean',\n      description:\n        'Set to false in order to skip attaching process.exit handlers.'\n    }\n  },\n  payload: {},\n  logging: {\n    level: {\n      envLink: 'HIGHCHARTS_LOG_LEVEL',\n      value: 4,\n      type: 'number',\n      cliName: 'logLevel',\n      description:\n        'The log level (0: silent, 1: error, 2: warning, 3: notice, 4: verbose).'\n    },\n    file: {\n      envLink: 'HIGHCHARTS_LOG_FILE',\n      value: 'highcharts-export-server.log',\n      type: 'string',\n      cliName: 'logFile',\n      description:\n        'A name of a log file. The --logDest also needs to be set to enable file logging.'\n    },\n    dest: {\n      envLink: 'HIGHCHARTS_LOG_DEST',\n      value: 'log/',\n      type: 'string',\n      cliName: 'logDest',\n      description: 'The path to store log files. Also enables file logging.'\n    }\n  },\n  ui: {\n    enable: {\n      envLink: 'HIGHCHARTS_UI_ENABLE',\n      value: false,\n      type: 'boolean',\n      cliName: 'enableUi',\n      description: 'Enables the UI for the export server.'\n    },\n    route: {\n      envLink: 'HIGHCHARTS_UI_ROUTE',\n      value: '/',\n      type: 'string',\n      cliName: 'uiRoute',\n      description: 'The route to attach the UI to.'\n    }\n  },\n  other: {\n    noLogo: {\n      envLink: 'HIGHCHARTS_NO_LOGO',\n      value: false,\n      type: 'boolean',\n      description:\n        'Skip printing the logo on a startup. Will be replaced by a simple text.'\n    }\n  }\n};\n\n// The config descriptions object for the prompts functionality. It contains\n// information like:\n// * Type of a prompt\n// * Name of an option\n// * Short description of a chosen option\n// * Initial value\nexport const promptsConfig = {\n  puppeteer: [\n    {\n      type: 'list',\n      name: 'args',\n      message: 'Puppeteer arguments',\n      initial: defaultConfig.puppeteer.args.value.join(','),\n      separator: ','\n    }\n  ],\n  highcharts: [\n    {\n      type: 'text',\n      name: 'version',\n      message: 'Highcharts version',\n      initial: defaultConfig.highcharts.version.value\n    },\n    {\n      type: 'text',\n      name: 'cdnURL',\n      message: 'The url of CDN',\n      initial: defaultConfig.highcharts.cdnURL.value\n    },\n    {\n      type: 'multiselect',\n      name: 'modules',\n      message: 'Available modules',\n      instructions: 'Space: Select specific, A: Select all, Enter: Confirm.',\n      choices: defaultConfig.highcharts.modules.value\n    },\n    {\n      type: 'list',\n      name: 'scripts',\n      message: 'Custom scripts',\n      initial: defaultConfig.highcharts.scripts.value.join(','),\n      separator: ','\n    }\n  ],\n  export: [\n    {\n      type: 'select',\n      name: 'type',\n      message: 'The default type of a file to export to',\n      hint: `Default: ${defaultConfig.export.type.value}`,\n      initial: 0,\n      choices: ['png', 'jpeg', 'pdf', 'svg']\n    },\n    {\n      type: 'select',\n      name: 'constr',\n      message: 'The default constructor for Highcharts to use',\n      hint: `Default: ${defaultConfig.export.constr.value}`,\n      initial: 0,\n      choices: ['chart', 'stockChart', 'mapChart', 'ganttChart']\n    },\n    {\n      type: 'number',\n      name: 'defaultHeight',\n      message: 'The default fallback height of the exported chart',\n      initial: defaultConfig.export.defaultHeight.value\n    },\n    {\n      type: 'number',\n      name: 'defaultWidth',\n      message: 'The default fallback width of the exported chart',\n      initial: defaultConfig.export.defaultWidth.value\n    },\n    {\n      type: 'number',\n      name: 'defaultScale',\n      message: 'The default fallback scale of the exported chart',\n      initial: defaultConfig.export.defaultScale.value,\n      min: 0.1,\n      max: 5\n    }\n  ],\n  customCode: [\n    {\n      type: 'toggle',\n      name: 'allowCodeExecution',\n      message: 'Allow to execute custom code',\n      initial: defaultConfig.customCode.allowCodeExecution.value\n    },\n    {\n      type: 'toggle',\n      name: 'allowFileResources',\n      message: 'Allow file resources',\n      initial: defaultConfig.customCode.allowFileResources.value\n    }\n  ],\n  server: [\n    {\n      type: 'toggle',\n      name: 'enable',\n      message: 'Starts a server on 0.0.0.0',\n      initial: defaultConfig.server.enable.value\n    },\n    {\n      type: 'text',\n      name: 'host',\n      message: 'A hostname of a server',\n      initial: defaultConfig.server.host.value\n    },\n    {\n      type: 'number',\n      name: 'port',\n      message: 'A port of a server',\n      initial: defaultConfig.server.port.value\n    },\n    {\n      type: 'toggle',\n      name: 'ssl.enable',\n      message: 'Enable SSL protocol',\n      initial: defaultConfig.server.ssl.enable.value\n    },\n    {\n      type: 'toggle',\n      name: 'ssl.force',\n      message: 'Force to only serve over HTTPS',\n      initial: defaultConfig.server.ssl.force.value\n    },\n    {\n      type: 'number',\n      name: 'ssl.port',\n      message: 'Port on which to run the SSL server',\n      initial: defaultConfig.server.ssl.port.value\n    },\n    {\n      type: 'text',\n      name: 'ssl.certPath',\n      message: 'A path where to find the SSL certificate/key',\n      initial: defaultConfig.server.ssl.certPath.value\n    },\n    {\n      type: 'toggle',\n      name: 'rateLimiting.enable',\n      message: 'Enable rate limiting',\n      initial: defaultConfig.server.rateLimiting.enable.value\n    },\n    {\n      type: 'number',\n      name: 'rateLimiting.maxRequests',\n      message: 'Max requests allowed in a one minute',\n      initial: defaultConfig.server.rateLimiting.maxRequests.value\n    },\n    {\n      type: 'number',\n      name: 'rateLimiting.window',\n      message: 'The time window in minutes for rate limiting',\n      initial: defaultConfig.server.rateLimiting.window.value\n    },\n    {\n      type: 'number',\n      name: 'rateLimiting.delay',\n      message: 'The amount to delay each successive request before hitting the max',\n      initial: defaultConfig.server.rateLimiting.delay.value\n    },\n    {\n      type: 'toggle',\n      name: 'rateLimiting.trustProxy',\n      message: 'Set this to true if behind a load balancer',\n      initial: defaultConfig.server.rateLimiting.trustProxy.value\n    },\n    {\n      type: 'text',\n      name: 'rateLimiting.skipKey',\n      message:\n        'Allows bypassing the rate limiter and should be provided with skipToken argument',\n      initial: defaultConfig.server.rateLimiting.skipKey.value\n    },\n    {\n      type: 'text',\n      name: 'rateLimiting.skipToken',\n      message:\n        'Allows bypassing the rate limiter and should be provided with skipKey argument',\n      initial: defaultConfig.server.rateLimiting.skipToken.value\n    }\n  ],\n  pool: [\n    {\n      type: 'number',\n      name: 'initialWorkers',\n      message: 'The number of initial workers to spawn',\n      initial: defaultConfig.pool.initialWorkers.value\n    },\n    {\n      type: 'number',\n      name: 'maxWorkers',\n      message: 'The number of max workers to spawn',\n      initial: defaultConfig.pool.maxWorkers.value\n    },\n    {\n      type: 'number',\n      name: 'workLimit',\n      message:\n        'The pieces of work that can be performed before restarting a puppeteer process',\n      initial: defaultConfig.pool.workLimit.value\n    },\n    {\n      type: 'number',\n      name: 'queueSize',\n      message: 'The size of the request overflow queue',\n      initial: defaultConfig.pool.queueSize.value\n    },\n    {\n      type: 'number',\n      name: 'timeoutThreshold',\n      message: 'The number of seconds before timing out',\n      initial: defaultConfig.pool.timeoutThreshold.value\n    },\n    {\n      type: 'number',\n      name: 'acquireTimeout',\n      message: 'The number of milliseconds to wait for acquiring a resource',\n      initial: defaultConfig.pool.acquireTimeout.value\n    },\n    {\n      type: 'toggle',\n      name: 'reaper',\n      message: 'The reaper to remove hanging processes',\n      initial: defaultConfig.pool.reaper.value\n    },\n    {\n      type: 'toggle',\n      name: 'benchmarking',\n      message: 'Set benchmarking',\n      initial: defaultConfig.pool.benchmarking.value\n    },\n    {\n      type: 'toggle',\n      name: 'listenToProcessExits',\n      message: 'Set to false in order to skip attaching process.exit handlers',\n      initial: defaultConfig.pool.listenToProcessExits.value\n    }\n  ],\n  logging: [\n    {\n      type: 'number',\n      name: 'level',\n      message:\n        'The log level (0: silent, 1: error, 2: warning, 3: notice, 4: verbose)',\n      initial: defaultConfig.logging.level.value,\n      round: 0,\n      min: 0,\n      max: 4\n    },\n    {\n      type: 'text',\n      name: 'file',\n      message:\n        'A name of a log file. The --logDest also needs to be set to enable file logging',\n      initial: defaultConfig.logging.file.value\n    },\n    {\n      type: 'text',\n      name: 'dest',\n      message: 'A path to log files. It enables file logging',\n      initial: defaultConfig.logging.dest.value\n    }\n  ],\n  ui: [\n    {\n      type: 'toggle',\n      name: 'enable',\n      message: 'Enable UI for the export server',\n      initial: defaultConfig.ui.enable.value\n    },\n    {\n      type: 'text',\n      name: 'route',\n      message: 'A route to attach the UI to',\n      initial: defaultConfig.ui.route.value\n    }\n  ],\n  other: [\n    {\n      type: 'toggle',\n      name: 'noLogo',\n      message:\n        'Skip printing the logo on a startup. Will be replaced by a simple text',\n      initial: defaultConfig.other.noLogo.value\n    }\n  ]\n};\n\n// Argument nesting level of all export server options\nconst nestedArgs = {};\n\n// Map of properties from envs\nconst envVars = [];\n\n/**\n * Builds maps and load env vars.\n *\n * @param {object} obj - The object based on which the initial configuration be\n * made.\n * @param {string } propChain - Required for creating a string chain of\n * properties for nested arguments.\n */\nconst initConfig = (obj, propChain = '') => {\n  const toBoolean = (item) =>\n    ['false', 'undefined', 'null', 'NaN', '0', ''].includes(item)\n      ? false\n      : !!item;\n\n  Object.keys(obj).forEach((k) => {\n    if (!['puppeteer', 'highcharts'].includes(k)) {\n      const entry = obj[k];\n      let numEnvVal;\n\n      if (typeof entry.value === 'undefined') {\n        initConfig(entry, `${propChain}.${k}`);\n      } else {\n        if (entry.envLink) {\n          // Load the env var\n          if (entry.type === 'boolean') {\n            entry.value = toBoolean(\n              [process.env[entry.envLink], entry.value].find(\n                (el) => el || el === 'false'\n              )\n            );\n          } else if (entry.type === 'number') {\n            numEnvVal = +process.env[entry.envLink];\n            entry.value = numEnvVal >= 0 ? numEnvVal : entry.value;\n          } else if (\n            entry.type.indexOf(']') >= 0 &&\n            process.env[entry.envLink]\n          ) {\n            entry.value = process.env[entry.envLink].split(',');\n          } else {\n            entry.value = process.env[entry.envLink] || entry.value;\n          }\n\n          // Add to list of env vars\n          envVars.push({\n            name: entry.envLink,\n            description: entry.description,\n            type: entry.type\n          });\n        }\n\n        // Create the chain of nested arguments\n        nestedArgs[entry.cliName || k] = `${propChain}.${k}`.substring(1);\n      }\n    }\n  });\n};\n\ninitConfig(defaultConfig);\n\nexport default {\n  defaultConfig,\n  promptsConfig,\n  envVars,\n  nestedArgs\n};\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport { appendFile, existsSync, mkdirSync } from 'fs';\n\nimport { defaultConfig } from './schemas/config.js';\n\n// The default logging config\nlet logging = {\n  // Flags for logging status\n  toConsole: true,\n  toFile: false,\n  pathCreated: false,\n  // Log levels\n  levelsDesc: [\n    {\n      title: 'error',\n      color: 'red'\n    },\n    {\n      title: 'warning',\n      color: 'yellow'\n    },\n    {\n      title: 'notice',\n      color: 'blue'\n    },\n    {\n      title: 'verbose',\n      color: 'gray'\n    }\n  ],\n  // Log listeners\n  listeners: []\n};\n\n// Gather init logging options\nfor (const [key, option] of Object.entries(defaultConfig.logging)) {\n  logging[key] = option.value;\n}\n\n/**\n * Logs a message. Accepts a variable amount of arguments. Arguments after\n * `level` will be passed directly to console.log, and/or will be joined\n * and appended to the log file.\n *\n * @param {any} args - An array of arguments where the first is the log level\n * and the rest are strings to build a message with.\n */\nexport const log = (...args) => {\n  const [newLevel, ...texts] = args;\n\n  // Current logging options\n  const { level, levelsDesc } = logging;\n\n  // Check if log level is within a correct range\n  if (newLevel === 0 || newLevel > level || level > levelsDesc.length) {\n    return;\n  }\n\n  // Get rid of the GMT text information\n  const newDate = new Date().toString().split('(')[0].trim();\n\n  // Create a message's prefix\n  const prefix = `${newDate} [${levelsDesc[newLevel - 1].title}] -`;\n\n  // Call available log listeners\n  logging.listeners.forEach((fn) => {\n    fn(prefix, texts.join(' '));\n  });\n\n  // Log to file\n  if (logging.toFile) {\n    if (!logging.pathCreated) {\n      // Create if does not exist\n      !existsSync(logging.dest) && mkdirSync(logging.dest);\n\n      // We now assume the path is available, e.g. it's the responsibility\n      // of the user to create the path with the correct access rights.\n      logging.pathCreated = true;\n    }\n\n    // Add the content to a file\n    appendFile(\n      `${logging.dest}${logging.file}`,\n      [prefix].concat(texts).join(' ') + '\\n',\n      (error) => {\n        if (error) {\n          console.log(`[logger] Unable to write to log file: ${error}`);\n          logging.toFile = false;\n        }\n      }\n    );\n  }\n\n  // Log to console\n  if (logging.toConsole) {\n    console.log.apply(\n      undefined,\n      [prefix.toString()[logging.levelsDesc[newLevel - 1].color]].concat(texts)\n    );\n  }\n};\n\n/**\n * Sets the file logging configuration.\n *\n * @param {string} logDest - A path to log to.\n * @param {string} logFile - The name of the log file.\n */\nexport const enableFileLogging = (logDest, logFile) => {\n  // Update logging options\n  logging = {\n    ...logging,\n    dest: logDest || logging.dest,\n    file: logFile || logging.file,\n    toFile: true\n  };\n\n  if (logging.dest.length === 0) {\n    return log(1, '[logger] File logging init: no path supplied.');\n  }\n\n  if (!logging.dest.endsWith('/')) {\n    logging.dest += '/';\n  }\n};\n\n/**\n * Adds a log listener.\n *\n * @param {function} fn - The function to call when getting a log event.\n */\nexport const listen = (fn) => {\n  logging.listeners.push(fn);\n};\n\n/**\n * Sets the current log level. Log levels are:\n * - 0 = no logging\n * - 1 = error\n * - 2 = warning\n * - 3 = notice\n * - 4 = verbose\n *\n * @param {number} newLevel - The new log level (0 - 4).\n */\nexport const setLogLevel = (newLevel) => {\n  if (newLevel >= 0 && newLevel <= logging.levelsDesc.length) {\n    logging.level = newLevel;\n  }\n};\n\n/**\n * Enables or disables logging to the stdout.\n *\n * @param {boolean} enabled - Whether log to console or not.\n */\nexport const toggleSTDOut = (enabled) => {\n  logging.toConsole = enabled;\n};\n\nexport default {\n  log,\n  enableFileLogging,\n  listen,\n  setLogLevel,\n  toggleSTDOut\n};\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport { readFileSync } from 'fs';\nimport { fileURLToPath } from 'url';\n\nimport { log } from './logger.js';\n\nconst MAX_BACKOFF_ATTEMPTS = 6;\n\nexport const __dirname = fileURLToPath(new URL('../.', import.meta.url));\n\n/**\n * Clears text from whitespaces with a regex rule.\n *\n * @param {string} rule - The rule for clearing a string, default to /\\s\\s+/g.\n * @return {string} - Cleared text.\n */\nexport const clearText = (text, rule = /\\s\\s+/g, replacer = ' ') =>\n  text.replaceAll(rule, replacer).trim();\n\n/**\n * Delays calling the function by time calculated based on the backoff\n * algorithm.\n *\n * @param {function} fn - A function to try to call with the backoff algorithm\n * on.\n * @param {number} attempt - The number of an attempt, where the first one is 0.\n */\nexport const expBackoff = async (fn, attempt = 0, ...args) => {\n  try {\n    // Try to call the function\n    return await fn(...args);\n  } catch (error) {\n    // Calculate delay in ms\n    const delayInMs = 2 ** attempt * 1000;\n\n    // If the attempt exceeds the maximum attempts of reapeat, throw an error\n    if (++attempt >= MAX_BACKOFF_ATTEMPTS) {\n      throw error;\n    }\n\n    // Wait given amount of time\n    await new Promise((response) => setTimeout(response, delayInMs));\n    log(\n      3,\n      `[pool] Waited ${delayInMs}ms until next call for the resource id: ${args[0]}.`\n    );\n\n    // Try again\n    return expBackoff(fn, attempt, ...args);\n  }\n};\n\n/**\n * Fixes to supported type format if MIME.\n *\n * @param {string} type - Type to be corrected.\n * @param {string} outfile - Name of the outfile.\n */\nexport const fixType = (type, outfile) => {\n  // MIME types\n  const mimeTypes = {\n    'image/png': 'png',\n    'image/jpeg': 'jpeg',\n    'application/pdf': 'pdf',\n    'image/svg+xml': 'svg'\n  };\n\n  // Formats\n  const formats = ['png', 'jpeg', 'pdf', 'svg'];\n\n  // Check if type and outfile's extensions are the same\n  if (outfile) {\n    const outType = outfile.split('.').pop();\n\n    // Check if extension has a correct type\n    if (formats.includes(outType) && type !== outType) {\n      type = outType;\n    }\n  }\n\n  // Return a correct type\n  return mimeTypes[type] || formats.find((t) => t === type) || 'png';\n};\n\n/**\n * Handles the provided resources.\n *\n * @param {string} resources - The stringified resources.\n * @param {string} allowFileResources - Decide if resources from file are\n * allowed.\n */\nexport const handleResources = (resources = false, allowFileResources) => {\n  const allowedProps = ['js', 'css', 'files'];\n\n  let handledResources = resources;\n  let correctResources = false;\n\n  // Try to load resources from a file\n  if (allowFileResources && resources.endsWith('.json')) {\n    try {\n      if (!resources) {\n        handledResources = isCorrectJSON(\n          readFileSync('resources.json', 'utf8')\n        );\n      } else if (resources && resources.endsWith('.json')) {\n        handledResources = isCorrectJSON(readFileSync(resources, 'utf8'));\n      } else {\n        handledResources = isCorrectJSON(resources);\n        if (handledResources === true) {\n          handledResources = isCorrectJSON(\n            readFileSync('resources.json', 'utf8')\n          );\n        }\n      }\n    } catch (notice) {\n      return log(3, `[cli] No resources found.`);\n    }\n  } else {\n    // Try to get JSON\n    handledResources = isCorrectJSON(resources);\n\n    // Get rid of the files section\n    if (!allowFileResources) {\n      delete handledResources.files;\n    }\n  }\n\n  // Filter from unnecessary properties\n  for (const propName in handledResources) {\n    if (!allowedProps.includes(propName)) {\n      delete handledResources[propName];\n    } else if (!correctResources) {\n      correctResources = true;\n    }\n  }\n\n  // Check if at least one of allowed properties is present\n  if (!correctResources) {\n    return log(3, `[cli] No resources found.`);\n  }\n\n  // Handle files section\n  if (handledResources.files) {\n    handledResources.files = handledResources.files.map((item) => item.trim());\n    if (!handledResources.files || handledResources.files.length <= 0) {\n      delete handledResources.files;\n    }\n  }\n\n  // Return resources\n  return handledResources;\n};\n\n/**\n * Checks if provided data is or can be a correct JSON.\n *\n * @param {any} data - Data to be checked.\n * @param {boolean} toString - If true, return stringified representation.\n */\nexport function isCorrectJSON(data, toString) {\n  try {\n    // Get the string representation if not already before parsing\n    const parsedData = JSON.parse(\n      typeof data !== 'string' ? JSON.stringify(data) : data\n    );\n\n    // Return a stringified representation of a JSON if required\n    if (typeof parsedData !== 'string' && toString) {\n      return JSON.stringify(parsedData);\n    }\n\n    // Return a JSON\n    return parsedData;\n  } catch (error) {\n    return false;\n  }\n}\n\n/**\n * Checks if item is an object.\n *\n * @param {any} item - Item to be checked.\n */\nexport const isObject = (item) =>\n  typeof item === 'object' && !Array.isArray(item) && item !== null;\n\n/**\n * Checks if string contains private range urls.\n *\n * @export utils\n * @param item {string} item to be checked\n */\nexport const isPrivateRangeUrlFound = (item) => {\n  return [\n    'localhost',\n    '(10).(.*).(.*).(.*)',\n    '(127).(.*).(.*).(.*)',\n    '(172).(1[6-9]|2[0-9]|3[0-1]).(.*).(.*)',\n    '(192).(168).(.*).(.*)'\n  ].some((ipRegEx) =>\n    item.match(`xlink:href=\"(?:(http://|https://))?${ipRegEx}`)\n  );\n};\n\n/**\n * Maps the old options to the new config structure.\n *\n * @param {object} oldOptions - Options to be mapped.\n */\nexport const mapToNewConfig = async (oldOptions) => {\n  const newOptions = {};\n  const { default: defaultSchemaConfig } = await import('./schemas/config.js');\n  const nestedArgs = defaultSchemaConfig.nestedArgs;\n\n  // Cycle through old-structured options\n  for (const [key, value] of Object.entries(oldOptions)) {\n    const propertiesChain = nestedArgs[key] ? nestedArgs[key].split('.') : [];\n\n    // Populate object in correct properties levels\n    propertiesChain.reduce(\n      (obj, prop, index) =>\n        (obj[prop] =\n          propertiesChain.length - 1 === index ? value : obj[prop] || {}),\n      newOptions\n    );\n  }\n  return newOptions;\n};\n\n/**\n * Creates and returns a deep copy of the given object.\n *\n * @param {object} object - Object to copy.\n * @return {object} - Deep copy of the object.\n */\nexport const deepCopy = (obj) => {\n  if (obj === null || typeof obj !== 'object') {\n    return obj;\n  }\n\n  const copy = Array.isArray(obj) ? [] : {};\n\n  for (const key in obj) {\n    if (Object.prototype.hasOwnProperty.call(obj, key)) {\n      copy[key] = deepCopy(obj[key]);\n    }\n  }\n\n  return copy;\n}\n\n/**\n * Merges the new options to the options object. It omits undefined values.\n *\n * @param {object} options - Old options.\n * @param {object} newOptions - New options.\n * @param {string[]} absoluteProps - Array of object names that should be force\n * merged.\n */\nexport const mergeConfigOptions = (options, newOptions, absoluteProps = []) => {\n  const mergedOptions = deepCopy(options);\n\n  for (const [key, value] of Object.entries(newOptions)) {\n    mergedOptions[key] =\n      isObject(value) &&\n      !absoluteProps.includes(key) &&\n      mergedOptions[key] !== undefined\n        ? mergeConfigOptions(mergedOptions[key], value, absoluteProps)\n        : value !== undefined\n        ? value\n        : mergedOptions[key];\n  }\n\n  return mergedOptions;\n};\n\n/**\n * Stringifies object with options. Possible to preserve functions with\n * allowFunctions flag.\n *\n * @param {object} options - Options to stringify.\n * @param {boolean} allowFunctions - Flag for keeping functions.\n */\nexport const optionsStringify = (options, allowFunctions) => {\n  const replacerCallback = (name, value) => {\n    if (typeof value === 'string') {\n      value = value.trim();\n\n      // If allowFunctions is set to true, preserve functions\n      if (\n        (value.startsWith('function(') || value.startsWith('function (')) &&\n        value.endsWith('}')\n      ) {\n        value = allowFunctions\n          ? `EXP_FUN${(value + '').replaceAll(/\\n|\\t|\\r/g, ' ')}EXP_FUN`\n          : undefined;\n      }\n    }\n\n    return typeof value === 'function'\n      ? `EXP_FUN${(value + '').replaceAll(/\\n|\\t|\\r/g, ' ')}EXP_FUN`\n      : value;\n  };\n\n  // Stringify options and if required, replace special functions marks\n  return JSON.stringify(options, replacerCallback).replaceAll(\n    /\"EXP_FUN|EXP_FUN\"/g,\n    ''\n  );\n};\n\n/**\n * Pairs argument with a corresponding value.\n *\n * @param {object} options - All server options.\n * @param {string[]} args - Array of arguments from a user.\n * @param {object} defaultConfig - The default config object.\n */\nexport const pairArgumentValue = async (options, args, defaultConfig) => {\n  const { default: defaultSchemaConfig } = await import('./schemas/config.js');\n  const nestedArgs = defaultSchemaConfig.nestedArgs;\n\n  for (let i = 0; i < args.length; i++) {\n    let option = args[i].replace(/-/g, '');\n\n    // Find the right place for property's value\n    const propertiesChain = nestedArgs[option]\n      ? nestedArgs[option].split('.')\n      : [];\n\n    propertiesChain.reduce((obj, prop, index) => {\n      if (propertiesChain.length - 1 === index) {\n        // Finds an option and set a corresponding value\n        if (typeof obj[prop] !== 'undefined') {\n          if (args[++i]) {\n            obj[prop] = args[i] || obj[prop];\n          } else {\n            console.log(`Missing argument value for ${option}!`.red, '\\n');\n            options = printUsage(defaultConfig);\n          }\n        }\n      }\n      return obj[prop];\n    }, options);\n  }\n\n  return options;\n};\n\n/**\n * Prints the export server logo.\n *\n * @param {boolean} noLogo - Whether to display logo or text.\n */\nexport const printLogo = (noLogo) => {  \n\n  // Get package version either from env or from package.json  \n  const packageVersion = process.env.npm_package_version ||\n    JSON.parse(readFileSync(new URL('../package.json', import.meta.url))).version;\n\n  // Print text only\n  if (noLogo) {\n    console.log(`Starting highcharts export server v${packageVersion}...`);\n    return;\n  }\n\n  // Print the logo\n  console.log(\n    readFileSync(__dirname + '/msg/startup.msg').toString().bold.yellow,\n    `v${packageVersion}`\n  );\n};\n\n/**\n * Prints the CLI usage. If required, it can list properties recursively\n *\n * @param {object} defaultConfig - The default config object.\n */\nexport function printUsage(defaultConfig) {\n  const pad = 48;\n  const readme = 'https://github.com/highcharts/node-export-server#readme';\n\n  // Display readme information\n  console.log(\n    'Usage of CLI arguments:'.bold,\n    '\\n------',\n    `\\nFor more detailed information visit readme at: ${readme.bold.yellow}.`\n  );\n\n  const cycleCategories = (categories) => {\n    for (const [name, option] of Object.entries(categories)) {\n      // If category has more levels, go further\n      if (!Object.prototype.hasOwnProperty.call(option, 'value')) {\n        cycleCategories(option);\n      } else {\n        let descName = `  --${option.cliName || name} ${\n          ('<' + option.type + '>').green\n        } `;\n        if (descName.length < pad) {\n          for (let i = descName.length; i < pad; i++) {\n            descName += '.';\n          }\n        }\n\n        // Display correctly aligned messages\n        console.log(\n          descName,\n          option.description,\n          `[Default: ${option.value.toString().bold}]`.blue\n        );\n      }\n    }\n  };\n\n  // Cycle through options of each categories and display the usage info\n  Object.keys(defaultConfig).forEach((category) => {\n    // Only puppeteer and highcharts categories cannot be configured through CLI\n    if (!['puppeteer', 'highcharts'].includes(category)) {\n      console.log(`\\n${category.toUpperCase()}`.red);\n      cycleCategories(defaultConfig[category]);\n    }\n  });\n  console.log('\\n');\n}\n\n/**\n * Rounds number to passed precision.\n *\n * @param {number} value - Number to round.\n * @param {number} precision - A precision of rounding.\n */\nexport const roundNumber = (value, precision = 1) => {\n  const multiplier = Math.pow(10, precision || 0);\n  return Math.round(+value * multiplier) / multiplier;\n};\n\n/**\n * Casts the item to boolean.\n *\n * @param {any} item - Item to be cast.\n */\nexport const toBoolean = (item) =>\n  ['false', 'undefined', 'null', 'NaN', '0', ''].includes(item)\n    ? false\n    : !!item;\n\n/**\n * If necessary, places a custom code inside a function.\n *\n * @param {any} customCode - The customCode.\n */\nexport const wrapAround = (customCode, allowFileResources) => {\n  if (customCode && typeof customCode === 'string') {\n    customCode = customCode.trim();\n\n    if (customCode.endsWith('.js')) {\n      return allowFileResources\n        ? wrapAround(readFileSync(customCode, 'utf8'))\n        : false;\n    } else if (\n      customCode.startsWith('function()') ||\n      customCode.startsWith('function ()') ||\n      customCode.startsWith('()=>') ||\n      customCode.startsWith('() =>')\n    ) {\n      return `(${customCode})()`;\n    }\n    return customCode.replace(/;$/, '');\n  }\n};\n\n/**\n * Utility to measure time.\n */\nexport const measureTime = () => {\n  const start = process.hrtime.bigint();\n  return () => Number(process.hrtime.bigint() - start) / 1000000;\n};\n\nexport default {\n  __dirname,\n  clearText,\n  expBackoff,\n  fixType,\n  handleResources,\n  isCorrectJSON,\n  isObject,\n  isPrivateRangeUrlFound,\n  mapToNewConfig,\n  mergeConfigOptions,\n  optionsStringify,\n  pairArgumentValue,\n  printLogo,\n  printUsage,\n  roundNumber,\n  toBoolean,\n  wrapAround,\n  measureTime\n};\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport rateLimit from 'express-rate-limit';\n\nimport { clearText } from '../utils.js';\nimport { log } from '../logger.js';\n\n/**\n * Enables rate limiting for a given app.\n *\n * @param {object} app - The express app.\n * @param {object} limitConfig - The options for the rate limiting.\n */\nexport default (app, limitConfig) => {\n  const msg =\n    'Too many requests, you have been rate limited. Please try again later.';\n\n  // Options for the rate limiter\n  const rateOptions = {\n    max: limitConfig.maxRequests || 30,\n    window: limitConfig.window || 1,\n    delay: limitConfig.delay || 0,\n    trustProxy: limitConfig.trustProxy || false,\n    skipKey: limitConfig.skipKey || false,\n    skipToken: limitConfig.skipToken || false\n  };\n\n  // Set if behind a proxy\n  if (rateOptions.trustProxy) {\n    app.enable('trust proxy');\n  }\n\n  // Create a limiter\n  const limiter = rateLimit({\n    windowMs: rateOptions.window * 60 * 1000,\n    // Limit each IP to 100 requests per windowMs\n    max: rateOptions.max,\n    // Disable delaying, full speed until the max limit is reached\n    delayMs: rateOptions.delay,\n    handler: (request, response) => {\n      response.format({\n        json: () => {\n          response.status(429).send({ message: msg });\n        },\n        default: () => {\n          response.status(429).send(msg);\n        }\n      });\n    },\n    skip: (request) => {\n      // Allow bypassing the limiter if a valid key/token has been sent\n      if (\n        rateOptions.skipKey !== false &&\n        rateOptions.skipToken !== false &&\n        request.query.key === rateOptions.skipKey &&\n        request.query.access_token === rateOptions.skipToken\n      ) {\n        log(4, '[rate-limiting] Skipping rate limiter.');\n        return true;\n      }\n      return false;\n    }\n  });\n\n  // Use a limiter as a middleware\n  app.use(limiter);\n\n  log(\n    3,\n    clearText(\n      `[rate-limiting] Enabled rate limiting: ${rateOptions.max} requests\n      per ${rateOptions.window} minute per IP, trusting proxy:\n      ${rateOptions.trustProxy}.`\n    )\n  );\n};\n","/**\n * This module exports two functions: fetch (for GET requests) and post (for POST requests).\n */\n\nimport http from 'http';\nimport https from 'https';\n\n/**\n * Determines the protocol of the given URL (either `http` or `https`).\n *\n * @function\n * @param {string} url - The URL whose protocol needs to be determined.\n * @returns {Object} Returns the `https` module if the URL starts with 'https',\n * otherwise returns the `http` module.\n * @private\n *\n * @example\n *\n * const protocol = getProtocol('https://example.com');\n * console.log(protocol); // Outputs the 'https' module\n */\nconst getProtocol = (url) => {\n  return url.startsWith('https') ? https : http;\n}\n\n/**\n * Sends a GET request to the specified URL with optional request options.\n *\n * @function\n * @async\n * @param {string} url - The URL to fetch.\n * @param {Object} [requestOptions={}] - Optional request options and headers.\n * @returns {Promise<Object>} Returns a promise that resolves with the response object.\n * The response object contains a `.text` property with the raw response data.\n * @throws {Error} Throws an error if the request fails or if no data is fetched from the URL.\n *\n * @example\n *\n * async function getData() {\n *   try {\n *     const response = await fetch('https://api.example.com/data');\n *     console.log(response.text);\n *   } catch (error) {\n *     console.error('Error fetching data:', error);\n *   }\n * }\n *\n * getData();\n */\nasync function fetch(url, requestOptions = {}) {\n  return new Promise((resolve, reject) => {\n    const protocol = getProtocol(url);\n\n    protocol.get(url, requestOptions, (res) => {\n      let data = '';\n\n      // A chunk of data has been received.\n      res.on('data', (chunk) => {\n        data += chunk;\n      });\n\n      // The whole response has been received.\n      res.on('end', () => {\n        if (!data) {\n          reject('Nothing was fetched from the URL.');\n        }\n\n        res.text = data;\n        resolve(res);\n      });\n\n    }).on('error', (error) => {\n      reject(error);\n    });\n  });\n}\n\n/**\n * Sends a POST request to the specified URL with the given body and request options.\n *\n * @function\n * @async\n * @param {string} url - The URL to which the request should be sent.\n * @param {Object} [body={}] - The data to be sent as the request body, in JSON format.\n * @param {Object} [requestOptions={}] - Optional request options and headers.\n * @returns {Promise<Object>} - Returns a promise that resolves with the parsed JSON response.\n * @throws {Error} Throws an error if the request fails or if the response cannot be parsed.\n *\n * @example\n *\n * async function sendData() {\n *   const dataToSend = {\n *     key1: 'value1',\n *     key2: 'value2',\n *   };\n *   try {\n *     const response = await post('https://api.example.com/data', dataToSend);\n *     console.log(response);\n *   } catch (error) {\n *     console.error('Error sending data:', error);\n *   }\n * }\n *\n * sendData();\n */\nasync function post(url, body = {}, requestOptions = {}) {\n  return new Promise((resolve, reject) => {\n    const protocol = getProtocol(url);\n    const data = JSON.stringify(body);\n\n    // Set default headers and merge with requestOptions\n    const options = Object.assign({\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Content-Length': data.length,\n      },\n    }, requestOptions);\n\n    const req = protocol.request(url, options, (res) => {\n      let responseData = '';\n\n      // A chunk of data has been received.\n      res.on('data', (chunk) => {\n        responseData += chunk;\n      });\n\n      // The whole response has been received.\n      res.on('end', () => {\n        try {\n          res.text = responseData;\n          resolve(res);\n        } catch (error) {\n          reject(error);\n        }\n      });\n\n    }).on('error', (error) => {\n      reject(error);\n    });\n\n    // Write the request body and end the request.\n    req.write(data);\n    req.end();\n  });\n}\n\nexport default fetch;\nexport { fetch, post };","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\n// The cache manager manages the Highcharts library and its dependencies.\n// The cache itself is stored in .cache, and is checked by the config system\n// before starting the service\n\nimport { existsSync, mkdirSync, readFileSync, writeFileSync } from 'fs';\nimport { join } from 'path';\n\nimport dotenv from 'dotenv';\nimport HttpsProxyAgent from 'https-proxy-agent';\nimport fetch from './fetch.js';\n\nimport { log } from './logger.js';\nimport { __dirname } from '../lib/utils.js';\n\ndotenv.config();\n\nconst cachePath = join(__dirname, '.cache');\n\nconst cache = {\n  cdnURL: 'https://code.highcharts.com/',\n  activeManifest: {},\n  sources: '',\n  hcVersion: ''\n};\n\n// TODO: The config should be accesssible globally so we don't have to do this sort of thing..\nlet appliedConfig = false;\n\n/**\n * Extracts the Highcharts version from the cache\n */\nconst extractVersion = () =>\n  (cache.hcVersion = cache.sources\n    .substr(0, cache.sources.indexOf('*/'))\n    .replace('/*', '')\n    .replace('*/', '')\n    .replace(/\\n/g, '')\n    .trim());\n\n/**\n * Saves the Highcharts part of a config to a manifest file in the cache\n *\n * @param {object} config - Highcarts related configuration object.\n * @param {object} fetchedModules - An object that contains mapped names of\n * fetched Highcharts modules to use.\n */\nconst saveConfigToManifest = async (config, fetchedModules) => {\n  const newManifest = {\n    version: config.version,\n    modules: fetchedModules || {}\n  };\n\n  // Update cache object with the current modules\n  cache.activeManifest = newManifest;\n\n  log(4, '[cache] writing new manifest');\n\n  try {\n    writeFileSync(\n      join(cachePath, 'manifest.json'),\n      JSON.stringify(newManifest),\n      'utf8'\n    );\n  } catch (error) {\n    log(1, `[cache] Error writing cache manifest: ${error}.`);\n  }\n};\n\n/**\n * Fetches a single script.\n *\n * @param {string} script - A path to script to get.\n * @param {object} proxyAgent - The proxy agent to use for a request.\n */\nconst fetchScript = async (script, proxyAgent) => {\n  try {\n    // Get rid of the .js from the custom strings\n    if (script.endsWith('.js')) {\n        script = script.substring(0, script.length - 3);\n    }\n\n    log(4, `[cache] Fetching script - ${script}.js`);\n\n    // If exists, add proxy agent to request options\n    const requestOptions = proxyAgent\n      ? {\n          agent: proxyAgent,\n          timeout: +process.env['PROXY_SERVER_TIMEOUT'] || 5000\n        }\n      : {};\n\n    // Fetch the script\n    const response = await fetch(`${script}.js`, requestOptions);\n\n    // If OK, return its text representation\n    if (response.statusCode === 200) {\n      return response.text;\n    }\n\n    throw `${response.statusCode}`;\n  } catch (error) {\n    log(1, `[cache] Error fetching script ${script}.js: ${error}.`);\n    throw error;\n  }\n};\n\n/**\n * Updates the Highcharts cache.\n *\n * @param {object} config - Highcarts related configuration object.\n * @param {string} sourcePath - A path to the file where save updated sources.\n * @return {object} An object that contains mapped names of fetched Highcharts\n * modules to use.\n */\nconst updateCache = async (config, sourcePath) => {\n  const { coreScripts, modules, indicators, scripts: customScripts } = config;\n  const hcVersion =\n    config.version === 'latest' || !config.version ? '' : `${config.version}/`;\n\n  log(3, '[cache] Updating cache to Highcharts ', hcVersion);\n\n  // Gather all scripts to fetch\n  const allScripts = [\n    ...coreScripts.map((c) => `${hcVersion}${c}`),\n    ...modules.map((m) =>\n      m === 'map' ? `maps/${hcVersion}modules/${m}` : `${hcVersion}modules/${m}`\n    ),\n    ...indicators.map((i) => `stock/${hcVersion}indicators/${i}`)\n  ];\n\n  // Configure proxy if exists\n  let proxyAgent;\n  const proxyHost = process.env['PROXY_SERVER_HOST'];\n  const proxyPort = process.env['PROXY_SERVER_PORT'];\n\n  if (proxyHost && proxyPort) {\n    proxyAgent = new HttpsProxyAgent({\n      host: proxyHost,\n      port: +proxyPort\n    });\n  }\n\n  const fetchedModules = {};\n  try {\n    cache.sources = // TODO: convert to for loop\n      (\n        await Promise.all([\n          ...allScripts.map(async (script) => {\n            const text = await fetchScript(\n              `${config.cdnURL || cache.cdnURL}${script}`,\n              proxyAgent\n            );\n\n            // If fetched correctly, set it\n            if (typeof text === 'string') {\n              fetchedModules[\n                script.replace(\n                  /(.*)\\/|(.*)modules\\/|stock\\/(.*)indicators\\/|maps\\/(.*)modules\\//gi,\n                  ''\n                )\n              ] = 1;\n            }\n\n            return text;\n          }),\n          ...customScripts.map((script) => fetchScript(script, proxyAgent))\n        ])\n      ).join(';\\n');\n    extractVersion();\n\n    // Save the fetched modules into caches' source JSON\n    writeFileSync(sourcePath, cache.sources);\n    return fetchedModules;\n  } catch (error) {\n    log(1, '[cache] Unable to update local Highcharts cache.');\n  }\n};\n\nexport const updateVersion = async (newVersion) =>\n  appliedConfig\n    ? await checkCache(\n        Object.assign(appliedConfig, {\n          version: newVersion\n        })\n      )\n    : false;\n\n/**\n * Fetches any missing Highcharts and dependencies\n *\n * @param {object} config - Highcarts related configuration object.\n */\nexport const checkCache = async (config) => {\n  let fetchedModules;\n  // Prepare paths to manifest and sources from the .cache folder\n  const manifestPath = join(cachePath, 'manifest.json');\n  const sourcePath = join(cachePath, 'sources.js');\n\n  // TODO: deal with trying to switch to the running version\n  // const activeVersion = appliedConfig ? appliedConfig.version : false;\n\n  appliedConfig = config;\n\n  // Create the .cache destination if it doesn't exist already\n  !existsSync(cachePath) && mkdirSync(cachePath);\n\n  // Load the .cache manifest\n  if (existsSync(manifestPath)) {\n    let requestUpdate = false;\n\n    // Read the manifest JSON\n    const manifest = JSON.parse(readFileSync(manifestPath));\n\n    // Check if the modules is an array, if so, we rewrite it to a map to make\n    // it easier to resolve modules.\n    if (manifest.modules && Array.isArray(manifest.modules)) {\n      const moduleMap = {};\n      manifest.modules.forEach((m) => (moduleMap[m] = 1));\n      manifest.modules = moduleMap;\n    }\n\n    const { modules, coreScripts, indicators } = config;\n    const numberOfModules =\n      modules.length + coreScripts.length + indicators.length;\n\n    // Compare the loaded config with the contents in .cache.\n    // If there are changes, fetch requested modules and products,\n    // and bake them into a giant blob. Save the blob.\n    if (manifest.version !== config.version) {\n      log(3, '[cache] Highcharts version mismatch in cache, need to re-fetch.');\n      requestUpdate = true;\n    } else if (Object.keys(manifest.modules || {}).length !== numberOfModules) {\n      log(\n        3,\n        '[cache] Cache and requested modules does not match, need to re-fetch.'\n      );\n      requestUpdate = true;\n    } else {\n      // Check each module, if anything is missing refetch everything\n      requestUpdate = (config.modules || []).some((moduleName) => {\n        if (!manifest.modules[moduleName]) {\n          log(\n            3,\n            `[cache] The ${moduleName} missing in cache, need to re-fetch.`\n          );\n          return true;\n        }\n      });\n    }\n\n    if (requestUpdate) {\n      fetchedModules = await updateCache(config, sourcePath);\n    } else {\n      log(3, '[cache] Dependency cache is up to date, proceeding.');\n\n      // Load the sources\n      cache.sources = readFileSync(sourcePath, 'utf8');\n\n      // Get current modules map\n      fetchedModules = manifest.modules;\n      extractVersion();\n    }\n  } else {\n    // So we don't have one yet, which means we need to fetch everything\n    log(3, '[cache] Fetching and caching Highcharts dependencies.');\n    fetchedModules = await updateCache(config, sourcePath);\n  }\n\n  // Finally, save the new manifest, which is basically our current config\n  // in a slightly different format\n  await saveConfigToManifest(config, fetchedModules);\n};\n\nexport default {\n  checkCache,\n  updateVersion,\n  getCache: () => cache,\n  highcharts: () => cache.sources,\n  version: () => cache.hcVersion\n};\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport puppeteer from 'puppeteer';\nimport fs from 'fs';\nimport * as url from 'url';\nimport { log } from './logger.js';\nimport path from 'node:path';\n\n// Workaround for https://bugs.chromium.org/p/chromium/issues/detail?id=1463328\n// Not ideal - leaves trash in the FS\nimport { randomBytes } from 'node:crypto';\nconst RANDOM_PID = randomBytes(64).toString('base64url');\nconst PUPPETEER_DIR = path.join('tmp', `puppeteer-${RANDOM_PID}`);\nconst DATA_DIR = path.join(PUPPETEER_DIR, 'profile');\n\n// The minimal args to speed up the browser\nconst minimalArgs = [\n  `--user-data-dir=${DATA_DIR}`,\n  '--autoplay-policy=user-gesture-required',\n  '--disable-background-networking',\n  '--disable-background-timer-throttling',\n  '--disable-backgrounding-occluded-windows',\n  '--disable-breakpad',\n  '--disable-client-side-phishing-detection',\n  '--disable-component-update',\n  '--disable-default-apps',\n  '--disable-dev-shm-usage',\n  '--disable-domain-reliability',\n  '--disable-extensions',\n  '--disable-features=AudioServiceOutOfProcess',\n  '--disable-hang-monitor',\n  '--disable-ipc-flooding-protection',\n  '--disable-notifications',\n  '--disable-offer-store-unmasked-wallet-cards',\n  '--disable-popup-blocking',\n  '--disable-print-preview',\n  '--disable-prompt-on-repost',\n  '--disable-renderer-backgrounding',\n  '--disable-session-crashed-bubble',\n  '--disable-setuid-sandbox',\n  '--disable-speech-api',\n  '--disable-sync',\n  '--hide-crash-restore-bubble',\n  '--hide-scrollbars',\n  '--ignore-gpu-blacklist',\n  '--metrics-recording-only',\n  '--mute-audio',\n  '--no-default-browser-check',\n  '--no-first-run',\n  '--no-pings',\n  '--no-sandbox',\n  '--no-zygote',\n  '--password-store=basic',\n  '--use-mock-keychain'\n];\n\nconst __dirname = url.fileURLToPath(new URL('.', import.meta.url));\n\nconst template = fs.readFileSync(\n  __dirname + '/../templates/template.html',\n  'utf8'\n);\n\nlet browser;\n\nexport const newPage = async () => {\n  if (!browser) return false;\n\n  const p = await browser.newPage();\n\n  await p.setContent(template);\n  await p.addScriptTag({ path: __dirname + '/../.cache/sources.js' });\n  // eslint-disable-next-line no-undef\n  await p.evaluate(() => window.setupHighcharts());\n\n  p.on('pageerror', async (err) => {\n    // TODO: Consider adding a switch here that turns on log(0) logging\n    // on page errors.\n    log(1, '[page error]', err);\n    await p.$eval(\n      '#container',\n      (element, errorMessage) => {\n        // eslint-disable-next-line no-undef\n        if (window._displayErrors) {\n          element.innerHTML = errorMessage;\n        }\n      },\n      `<h1>Chart input data error</h1>${err.toString()}`\n    );\n  });\n\n  return p;\n};\n\nexport const create = async (puppeteerArgs) => {\n  const allArgs = [...minimalArgs, ...(puppeteerArgs || [])];\n\n  // Create a browser\n  if (!browser) {\n    let tryCount = 0;\n\n    const open = async () => {\n      try {\n        log(\n          3,\n          '[browser] attempting to get a browser instance (try',\n          tryCount + ')'\n        );\n\n        browser = await puppeteer.launch({\n          headless: 'new',\n          args: allArgs,\n          userDataDir: './tmp/'\n        });\n      } catch (e) {\n        log(0, '[browser]', e);\n        if (++tryCount < 25) {\n          log(3, '[browser] failed:', e);\n          await new Promise((response) => setTimeout(response, 4000));\n          await open();\n        } else {\n          log(0, 'Max retries reached');\n        }\n      }\n    };\n\n    try {\n      await open();\n    } catch (e) {\n      log(0, '[browser] Unable to open browser');\n      return false;\n    }\n\n    if (!browser) {\n      log(0, '[browser] Unable to open browser');\n      return false;\n    }\n  }\n\n  // Return a browser promise\n  return browser;\n};\n\nexport const get = async () => {\n  if (!browser) {\n    throw 'no valid browser has been created';\n  }\n\n  return browser;\n};\n\nexport const close = async () => {\n  return await browser.close();\n};\n\nexport default {\n  get,\n  close,\n  newPage\n};\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\n// TODO: remove this temp benchmark stuff. I had this idea of doing a general benchmarking\n// system, but it adds so much bloat in the code that it shouldn't be there.\n\nimport benchmark from './benchmark.js';\nimport cache from './cache.js';\nimport { log } from './logger.js';\nimport svgTemplate from './../templates/svg_export/svg_export.js';\n\nimport { readFileSync } from 'fs';\nimport path from 'path';\nimport * as url from 'url';\n\nconst __basedir = url.fileURLToPath(new URL('.', import.meta.url));\n\n// const jsonTemplate = require('./../templates/json_export/json_export.js');\n\n/**\n * Gets the clip region for the chart DOM node.\n *\n * @param {object} page - A page of a browser instance.\n * @return {object} - A clipped region.\n */\nconst getClipRegion = (page) =>\n  page.$eval('#chart-container', (element) => {\n    const { x, y, width, height } = element.getBoundingClientRect();\n    return {\n      x,\n      y,\n      width,\n      height: Math.trunc(height > 1 ? height : 500)\n    };\n  });\n\n/**\n * Rasterizes the page to an image (PNG or JPEG)\n *\n * @param {object} page - A page of a browser instance.\n * @param {string} type - The type of a result image.\n * @param {string} encoding - The type of encoding used.\n * @param {string} clip - The clip region.\n * @returns {string} - A string representation of a screenshot.\n */\nconst createImage = async (page, type, encoding, clip) =>\n  await Promise.race([\n    page.screenshot({\n      type,\n      encoding,\n      clip\n    }),\n    new Promise((resolve, reject) =>\n      setTimeout(() => reject(new Error('Rasterization timeout')), 1500)\n    )\n  ]);\n\n/**\n * Turns page into a PDF.\n *\n * @param {object} page - A page of a browser instance.\n * @param {number} height - The height of a chart.\n * @param {number} width - The width of a chart.\n * @param {string} encoding - The type of encoding used.\n * @return {object} - A buffer with PDF representation.\n */\nconst createPDF = async (page, height, width, encoding) =>\n  await page.pdf({\n    // This will remove an extra empty page in PDF exports\n    height: height + 1,\n    width,\n    encoding\n  });\n\n/**\n * Exports as a SVG.\n *\n * @param {object} page - A page of a browser instance.\n * @return {object} - The outerHTML element with the SVG representation.\n */\nconst createSVG = async (page) =>\n  await page.$eval(\n    '#container svg:first-of-type',\n    (element) => element.outerHTML\n  );\n\n/** Load config into a page and render a chart */\nconst setAsConfig = async (page, chart, options) =>\n  await page.evaluate(\n    // eslint-disable-next-line no-undef\n    (chart, options) => window.triggerExport(chart, options),\n    chart,\n    options\n  );\n\n/** Load SVG into a page */\n// const setAsSVG = async (page, svgStr) => true;\n\n/**\n * Does an export for a given browser.\n *\n * @param {object} browser - A browser instance.\n * @param {object} chart - Chart's options.\n * @param {object} options - All options object.\n * @return {object} - The data returned from one of the methods for exporting\n * a specific type of an image.\n */\nexport default async (page, chart, options) => {\n  /**\n   * Keeps track of all resources added on the page with addXXXTag. etc\n   * It's VITAL that all added resources ends up here so we can clear things\n   * out when doing a new export in the same page!\n   */\n  const injectedResources = [];\n\n  /** Clear out all state set on the page with addScriptTag/addStyleTag. */\n  const clearInjected = async (page) => {\n    for (const res of injectedResources) {\n      await res.dispose();\n    }\n\n    // Reset all CSS and script tags\n    await page.evaluate(() => {\n      ///\n      // // eslint-disable-next-line no-undef\n      // Highcharts.setOptionsObj = {};\n      ///\n      // eslint-disable-next-line no-undef\n      const [, ...scriptsToRemove] = document.getElementsByTagName('script');\n      // eslint-disable-next-line no-undef\n      const [, ...stylesToRemove] = document.getElementsByTagName('style');\n      // eslint-disable-next-line no-undef\n      const [...linksToRemove] = document.getElementsByTagName('link');\n\n      // Remove tags\n      for (const element of [\n        ...scriptsToRemove,\n        ...stylesToRemove,\n        ...linksToRemove\n      ]) {\n        element.remove();\n      }\n    });\n  };\n\n  try {\n    const exportBench = benchmark('Puppeteer');\n\n    log(4, '[export] Determining export path.');\n\n    const exportOptions = options.export;\n\n    // Force a rAF\n    // See https://github.com/puppeteer/puppeteer/issues/7507\n    // eslint-disable-next-line no-undef\n    await page.evaluate(() => requestAnimationFrame(() => {}));\n\n    // Decide whether display error or debbuger wrapper around it\n    const displayErrors =\n      exportOptions?.options?.chart?.displayErrors &&\n      cache.getCache().activeManifest.modules.debugger;\n\n    // eslint-disable-next-line no-undef\n    await page.evaluate((d) => (window._displayErrors = d), displayErrors);\n\n    const svgBench = benchmark('SVG handling');\n\n    let isSVG;\n\n    if (\n      chart.indexOf &&\n      (chart.indexOf('<svg') >= 0 || chart.indexOf('<?xml') >= 0)\n    ) {\n      // SVG INPUT HANDLING\n\n      log(4, '[export] Treating as SVG.');\n\n      // If input is also svg, just return it\n      if (exportOptions.type === 'svg') {\n        return chart;\n      }\n\n      isSVG = true;\n      const setPageBench = benchmark('Setting content');\n      await page.setContent(svgTemplate(chart));\n      setPageBench();\n    } else {\n      // JSON Config handling\n\n      log(4, '[export] Treating as config.');\n\n      // Need to perform straight inject\n      if (exportOptions.strInj) {\n        // Injection based configuration export\n        const setPageBench = benchmark('Setting page content (inject)');\n\n        await setAsConfig(\n          page,\n          {\n            chart: {\n              height: exportOptions.height,\n              width: exportOptions.width\n            }\n          },\n          options\n        );\n\n        setPageBench();\n      } else {\n        // Basic configuration export\n\n        chart.chart.height = exportOptions.height;\n        chart.chart.width = exportOptions.width;\n\n        const setContentBench = benchmark('Setting page content (config)');\n        await setAsConfig(page, chart, options);\n        setContentBench();\n      }\n    }\n\n    svgBench();\n    const resBench = benchmark('Applying resources');\n\n    // Use resources\n    const resources = options.customCode.resources;\n    if (resources) {\n      // Load custom JS code\n      if (resources.js) {\n        injectedResources.push(\n          await page.addScriptTag({\n            content: resources.js\n          })\n        );\n      }\n\n      // Load scripts from all custom files\n      if (resources.files) {\n        for (const file of resources.files) {\n          try {\n            const isLocal = !file.startsWith('http') ? true : false;\n\n            // Add each custom script from resources' files\n            injectedResources.push(\n              await page.addScriptTag(\n                isLocal\n                  ? {\n                      content: readFileSync(file, 'utf8')\n                    }\n                  : {\n                      url: file\n                    }\n              )\n            );\n          } catch (notice) {\n            log(4, '[export] JS file not found.');\n          }\n        }\n      }\n\n      const cssBench = benchmark('Loading css');\n\n      // Load CSS\n      if (resources.css) {\n        let cssImports = resources.css.match(/@import\\s*([^;]*);/g);\n        if (cssImports) {\n          // Handle css section\n          for (let cssImportPath of cssImports) {\n            if (cssImportPath) {\n              cssImportPath = cssImportPath\n                .replace('url(', '')\n                .replace('@import', '')\n                .replace(/\"/g, '')\n                .replace(/'/g, '')\n                .replace(/;/, '')\n                .replace(/\\)/g, '')\n                .trim();\n\n              // Add each custom css from resources\n              if (cssImportPath.startsWith('http')) {\n                injectedResources.push(\n                  await page.addStyleTag({\n                    url: cssImportPath\n                  })\n                );\n              } else if (options.customCode.allowFileResources) {\n                injectedResources.push(\n                  await page.addStyleTag({\n                    path: path.join(__basedir, cssImportPath)\n                  })\n                );\n              }\n            }\n          }\n        }\n\n        // The rest of the CSS section will be content by now\n        injectedResources.push(\n          await page.addStyleTag({\n            content: resources.css.replace(/@import\\s*([^;]*);/g, '') || ' '\n          })\n        );\n      }\n\n      cssBench();\n    }\n\n    resBench();\n\n    // Get the real chart size\n    const size = isSVG\n      ? await page.$eval(\n          '#chart-container svg:first-of-type',\n          async (element, scale) => {\n            return {\n              chartHeight: element.height.baseVal.value * scale,\n              chartWidth: element.width.baseVal.value * scale\n            };\n          },\n          parseFloat(exportOptions.scale)\n        )\n      : await page.evaluate(async () => {\n          // eslint-disable-next-line no-undef\n          const { chartHeight, chartWidth } = window.Highcharts.charts[0];\n          return {\n            chartHeight,\n            chartWidth\n          };\n        });\n\n    const vpBench = benchmark('Setting viewport');\n\n    // Set final height and width for viewport\n    const viewportHeight = Math.ceil(size?.chartHeight || exportOptions.height);\n    const viewportWidth = Math.ceil(size?.chartWidth || exportOptions.width);\n\n    // Set the viewport for the first time\n    // NOTE: the call to setViewport is expensive - can we get away with only\n    // calling it once, e.g. moving this one into the isSVG condition below?\n    await page.setViewport({\n      height: viewportHeight,\n      width: viewportWidth,\n      deviceScaleFactor: isSVG ? 1 : parseFloat(exportOptions.scale)\n    });\n\n    // Prepare a zoom callback for the next evaluate call\n    const zoomCallback = isSVG\n      ? // In case of SVG the zoom must be set directly for body\n        (scale) => {\n          // Set the zoom as scale\n          // eslint-disable-next-line no-undef\n          document.body.style.zoom = scale;\n\n          // Set the margin to 0px\n          // eslint-disable-next-line no-undef\n          document.body.style.margin = '0px';\n        }\n      : // No need for such scale manipulation in case of other types of exports\n        () => {\n          // Reset the zoom for other exports than to SVGs\n          // eslint-disable-next-line no-undef\n          document.body.style.zoom = 1;\n        };\n\n    // Set the zoom accordingly\n    await page.evaluate(zoomCallback, parseFloat(exportOptions.scale));\n\n    // Get the clip region for the page\n    const { height, width, x, y } = await getClipRegion(page);\n\n    if (!isSVG) {\n      // Set the final viewport now that we have the real height\n      await page.setViewport({\n        width: Math.round(width),\n        height: Math.round(height),\n        deviceScaleFactor: parseFloat(exportOptions.scale)\n      });\n    }\n\n    vpBench();\n\n    let data;\n\n    const expBenchmark = benchmark('Rasterizing chart');\n\n    // RASTERIZATION\n    if (exportOptions.type === 'svg') {\n      // SVG\n      data = await createSVG(page);\n    } else if (exportOptions.type === 'png' || exportOptions.type === 'jpeg') {\n      // PNG or JPEG\n      data = await createImage(page, exportOptions.type, 'base64', {\n        width: viewportWidth,\n        height: viewportHeight,\n        x,\n        y\n      });\n    } else if (exportOptions.type === 'pdf') {\n      // PDF\n      data = await createPDF(page, viewportHeight, viewportWidth, 'base64');\n    } else {\n      throw `Unsupported output format ${exportOptions.type}`;\n    }\n\n    // Destroy old charts after the export is done\n    await page.evaluate(() => {\n      // eslint-disable-next-line no-undef\n      const oldCharts = Highcharts.charts;\n\n      // Check in any already existing charts\n      if (oldCharts.length) {\n        // Destroy old charts\n        for (const oldChart of oldCharts) {\n          oldChart && oldChart.destroy();\n          // eslint-disable-next-line no-undef\n          Highcharts.charts.shift();\n        }\n      }\n    });\n\n    expBenchmark();\n    exportBench();\n\n    await clearInjected(page);\n\n    return data;\n  } catch (error) {\n    await clearInjected(page);\n    log(1, `[export] Error encountered during export: ${error}`);\n\n    return error;\n  }\n};\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2022, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport { log } from './logger.js';\nconst timers = {};\n\n// TODO: Read from config\nlet enabled = false;\n\nexport default (id) => {\n  if (!enabled) {\n    return () => {};\n  }\n\n  timers[id] = new Date();\n  return () => {\n    log(\n      3,\n      `[benchmark] - ${id}: ${new Date().getTime() - timers[id].getTime()}ms`\n    );\n  };\n};\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport cssTemplate from './css.js';\n\nexport default (chart) => `\n<!DOCTYPE html>\n<html lang='en-US'>\n  <head>\n    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n    <title>Highcarts Export</title>\n  </head>\n  <style>\n    ${cssTemplate()}\n  </style>\n  <body>\n    <div id=\"chart-container\">\n      ${chart}\n    </div>\n  </body>\n</html>\n\n`;\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport { existsSync, readFileSync, promises as fsPromises } from 'fs';\n\nimport prompts from 'prompts';\n\nimport { log } from './logger.js';\n\nimport { mergeConfigOptions } from './utils.js';\nimport { promptsConfig } from './schemas/config.js';\n\n/**\n * Loads the configuration from JSON file.\n *\n * @param {object} options - All options object.\n * @return {object} - Updated options object.\n */\nexport const loadConfigFile = async (options) => {\n  const configFile = options.customCode && options.customCode.loadConfig;\n  try {\n    // An additional config file\n    if (configFile) {\n      // Return options updated with the properties from the loaded JSON file\n      options = mergeConfigOptions(\n        options,\n        JSON.parse(readFileSync(configFile))\n      );\n    }\n\n    // Return updated options\n    return options;\n  } catch (error) {\n    log(1, `[config] Unable to load config from the ${configFile}: ${error}`);\n  }\n};\n\n/**\n * Recursively sets a property in a correct indentation level based on the\n * array of nested properties names.\n *\n * @param {object} objectToUpdate - Object where a property must be set on a\n * correct level.\n * @param  {string[]}nestedNames - Array of nasted names that indicates\n * indentation level.\n * @param {any} value - A value to assign to the property.\n * @return {object} - Updated options object.\n */\nconst recursiveProps = (objectToUpdate, nestedNames, value) => {\n  while (nestedNames.length > 1) {\n    const propName = nestedNames.shift();\n\n    // Create a property in object if it doesn't exist\n    if (!Object.prototype.hasOwnProperty.call(objectToUpdate, propName)) {\n      objectToUpdate[propName] = {};\n    }\n\n    // Call function again if there still names to go\n    objectToUpdate[propName] = recursiveProps(\n      Object.assign({}, objectToUpdate[propName]),\n      nestedNames,\n      value\n    );\n\n    return objectToUpdate;\n  }\n\n  // Assign the final value\n  objectToUpdate[nestedNames[0]] = value;\n  return objectToUpdate;\n};\n\n/**\n * Displays a prompt for the manual configuration.\n *\n * @param {string} configFileName - The name of a configuration file.\n */\nexport const manualConfiguration = async (configFileName) => {\n  // Prepare a config object\n  let configFile = {};\n\n  // Check if provided config file exists\n  if (existsSync(configFileName)) {\n    configFile = JSON.parse(readFileSync(configFileName, 'utf8'));\n  }\n\n  // Question about a configuration category\n  const onSubmit = async (p, categories) => {\n    let questionsCounter = 0;\n    let allQuestions = [];\n\n    // Create a corresponding property in the manualConfig object\n    for (const section of categories) {\n      // Mark each option with a section\n      promptsConfig[section] = promptsConfig[section].map((option) => ({\n        ...option,\n        section\n      }));\n\n      // Collect the questions\n      allQuestions = [...allQuestions, ...promptsConfig[section]];\n    }\n\n    await prompts(allQuestions, {\n      onSubmit: async (prompt, answer) => {\n        // Get the default modules\n        if (prompt.name === 'modules') {\n          answer = answer.length\n            ? answer.map((module) => prompt.choices[module])\n            : prompt.choices;\n\n          configFile[prompt.section][prompt.name] = answer;\n        } else {\n          configFile[prompt.section] = recursiveProps(\n            Object.assign({}, configFile[prompt.section] || {}),\n            prompt.name.split('.'),\n            answer\n          );\n        }\n\n        if (++questionsCounter === allQuestions.length) {\n          try {\n            await fsPromises.writeFile(\n              configFileName,\n              JSON.stringify(configFile, null, 2),\n              'utf8'\n            );\n          } catch (error) {\n            log(1, `[config] Error while creating config.json: ${error}`);\n          }\n          return true;\n        }\n      }\n    });\n\n    return true;\n  };\n\n  // Find the categories\n  const choices = Object.keys(promptsConfig).map((choice) => ({\n    title: `${choice} options`,\n    value: choice\n  }));\n\n  // Category prompt\n  return prompts(\n    {\n      type: 'multiselect',\n      name: 'category',\n      message: 'Which category do you want to configure?',\n      hint: 'Space: Select specific, A: Select all, Enter: Confirm.',\n      instructions: '',\n      choices\n    },\n    { onSubmit }\n  );\n};\n\n/**\n * Inits default options recursively.\n *\n * @param {any} items - Items to update options from.\n * @return {object} - Updated options object.\n */\nexport const initDefaultOptions = (items) => {\n  let options = {};\n  for (const [name, item] of Object.entries(items)) {\n    options[name] = Object.prototype.hasOwnProperty.call(item, 'value')\n      ? item.value\n      : initDefaultOptions(item);\n  }\n  return options;\n};\n\n/**\n * Initializes options for the `startExport` method by merging user options\n * with the default options and pool options.\n *\n * @param {any} exportOptions - User options for exporting.\n * @param {any} poolOptions - Options of the pool which is used for export.\n * @return {object} - User options merged with default options.\n */\nexport const initExportSettings = (exportOptions, poolOptions = {}) => {\n  let options = {};\n\n  if (exportOptions.svg) {\n    options = poolOptions; // default poolOptions\n    options.export.type = exportOptions.type || exportOptions.export.type;\n    options.export.scale = exportOptions.scale || exportOptions.export.scale;\n    options.export.outfile = exportOptions.outfile || exportOptions.export.outfile;\n    options.payload = {\n      svg: exportOptions.svg\n    };\n  } else {\n    options = mergeConfigOptions(\n      poolOptions,\n      exportOptions,\n      // Omit going down recursively with the belows\n      ['options', 'globalOptions', 'themeOptions', 'resources']\n    );\n  }\n\n  options.export.outfile = options.export?.outfile || `chart.${options.export?.type || 'png'}`;\n  return options;\n}\n\nexport default {\n  loadConfigFile,\n  manualConfiguration,\n  initDefaultOptions,\n  initExportSettings\n};\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport { readFile, readFileSync } from 'fs';\n\nimport { log } from './logger.js';\nimport { postWork } from './pool.js';\nimport {\n  clearText,\n  fixType,\n  handleResources,\n  isCorrectJSON,\n  optionsStringify,\n  roundNumber,\n  toBoolean,\n  wrapAround\n} from './utils.js';\nimport { initExportSettings } from './config.js';\n\nlet allowCodeExecution = false;\n\nlet poolOptions = {};\n\n/**\n * Function for choosing chart size and scale based on options prioritization.\n *\n * @param {object} options - All options object.\n * @return {object} - An object with updated size and scale for a chart.\n */\nexport const findChartSize = (options) => {\n  const { chart, exporting } =\n    options.export?.options || isCorrectJSON(options.export?.instr);\n\n  // See if globalOptions holds chart or exporting size\n  const globalOptions = isCorrectJSON(options.export?.globalOptions);\n\n  // Secure scale value\n  let scale = roundNumber(\n    options.export?.scale ||\n      exporting?.scale ||\n      globalOptions?.exporting?.scale ||\n      options.export?.defaultScale ||\n      1\n  );\n\n  if (scale > 5) {\n    scale = 5;\n  } else if (scale < 0.1) {\n    scale = 1;\n  }\n\n  // Find chart size and scale\n  return {\n    height:\n      options.export?.height ||\n      exporting?.sourceHeight ||\n      chart?.height ||\n      globalOptions?.exporting?.sourceHeight ||\n      globalOptions?.chart?.height ||\n      options.export?.defaultHeight ||\n      400,\n    width:\n      options.export?.width ||\n      exporting?.sourceWidth ||\n      chart?.width ||\n      globalOptions?.exporting?.sourceWidth ||\n      globalOptions?.chart?.width ||\n      options.export?.defaultWidth ||\n      600,\n    scale\n  };\n};\n\n/**\n * Function for final options preparation before export.\n *\n * @param {object} options - All options object.\n * @param {object} chartJson - Chart JSON.\n * @param {function} endCallback - The end callback.\n * @param {string} svg - The SVG representation.\n */\nconst doExport = (options, chartJson, endCallback, svg) => {\n  let { export: exportOptions, customCode: customCodeOptions } = options;\n\n    const allowCodeExecutionScoped = (\n        typeof customCodeOptions.allowCodeExecution === 'boolean' ?\n            customCodeOptions.allowCodeExecution : allowCodeExecution\n    );\n\n  if (!customCodeOptions) {\n    customCodeOptions = options.customCode = {};\n  } else if (typeof options.customCode.resources === 'string') {\n    // Process resources\n    options.customCode.resources = handleResources(\n      options.customCode.resources,\n      toBoolean(options.customCode.allowFileResources)\n    );\n  } else if (!options.customCode.resources) {\n    try {\n      const resources = readFileSync('resources.json', 'utf8');\n      options.customCode.resources = handleResources(\n        resources,\n        toBoolean(options.customCode.allowFileResources)\n      );\n    } catch (err) {\n      log(3, `[chart] The default resources.json file not found.`);\n    }\n  }\n\n  // If the allowCodeExecution flag isn't set, we should refuse the usage\n  // of callback, resources, and custom code. Additionally, the worker will\n  // refuse to run arbitrary JavaScript. Prioritized should be the scoped\n  // option, then we should take a look at the overall pool option.\n  if (!allowCodeExecutionScoped && customCodeOptions) {\n    if (\n      customCodeOptions.callback ||\n      customCodeOptions.resources ||\n      customCodeOptions.customCode\n    ) {\n      // Send back a friendly message saying that the exporter does not support\n      // these settings.\n      return (\n        endCallback &&\n        endCallback(false, {\n          error: true,\n          message: clearText(\n            `The callback, resources and customCode have been disabled for this\n            server.`\n          )\n        })\n      );\n    }\n\n    // Reset all additional custom code\n    customCodeOptions.callback = false;\n    customCodeOptions.resources = false;\n    customCodeOptions.customCode = false;\n  }\n\n  // Clean properties to keep it lean and mean\n  if (chartJson) {\n    chartJson.chart = chartJson.chart || {};\n    chartJson.exporting = chartJson.exporting || {};\n    chartJson.exporting.enabled = false;\n  }\n\n  exportOptions.constr = exportOptions.constr || 'chart';\n  exportOptions.type = fixType(exportOptions.type, exportOptions.outfile);\n  if (exportOptions.type === 'svg') {\n    exportOptions.width = false;\n  }\n\n  // Prepare global and theme options\n  ['globalOptions', 'themeOptions'].forEach((optionsName) => {\n    try {\n      if (exportOptions && exportOptions[optionsName]) {\n        if (\n          typeof exportOptions[optionsName] === 'string' &&\n          exportOptions[optionsName].endsWith('.json')\n        ) {\n          exportOptions[optionsName] = isCorrectJSON(\n            readFileSync(exportOptions[optionsName], 'utf8'),\n            true\n          );\n        } else {\n          exportOptions[optionsName] = isCorrectJSON(\n            exportOptions[optionsName],\n            true\n          );\n        }\n      }\n    } catch (error) {\n      exportOptions[optionsName] = {};\n      log(1, `[chart] The ${optionsName} not found.`);\n    }\n  });\n\n  // Prepare customCode\n  if (customCodeOptions.allowCodeExecution) {\n    customCodeOptions.customCode = wrapAround(\n      customCodeOptions.customCode,\n      customCodeOptions.allowFileResources\n    );\n  }\n\n  // Get the callback\n  if (\n    customCodeOptions &&\n    customCodeOptions.callback &&\n    customCodeOptions.callback?.indexOf('{') < 0\n  ) {\n    // The allowFileResources is always set to false for HTTP requests to avoid\n    // injecting arbitrary files from the fs\n    if (customCodeOptions.allowFileResources) {\n      try {\n        customCodeOptions.callback = readFileSync(\n          customCodeOptions.callback,\n          'utf8'\n        );\n      } catch (error) {\n        log(2, `[chart] Error loading callback: ${error}.`);\n        customCodeOptions.callback = false;\n      }\n    } else {\n      customCodeOptions.callback = false;\n    }\n  }\n\n  // Size search\n  options.export = {\n    ...options.export,\n    ...findChartSize(options)\n  };\n\n  // Post the work to the pool\n  postWork(exportOptions.strInj || chartJson || svg, options)\n    .then((result) => endCallback(result))\n    .catch((error) => {\n      log(0, '[chart] When posting work:', error);\n      return endCallback(false, error);\n    });\n};\n\n/**\n * Function for straight injecting the code.\n * Dangerous and must be used deliberately by someone who sets up a server\n * (see  --allowCodeExecution).\n *\n * @param {object} options - All options object.\n * @param {function} endCallback - The function to call when exporting is done.\n */\nconst doStraightInject = (options, endCallback) => {\n  try {\n    let strInj;\n    let instr = options.export.instr || options.export.options;\n\n    if (typeof instr !== 'string') {\n      // Try to stringify options\n      strInj = instr = optionsStringify(\n        instr,\n        options.customCode?.allowCodeExecution\n      );\n    }\n    strInj = instr.replaceAll(/\\t|\\n|\\r/g, '').trim();\n\n    // Get rid of the ;\n    if (strInj[strInj.length - 1] === ';') {\n      strInj = strInj.substring(0, strInj.length - 1);\n    }\n\n    // Save as stright inject string\n    options.export.strInj = strInj;\n    return doExport(options, false, endCallback);\n  } catch (error) {\n    const message = clearText(\n      `Malformed input detected for ${options.export?.requestId || '?'}:\n      Please make sure that your JSON/JavaScript options\n      are sent using the \"options\" attribute, and that if you're using\n      SVG, it is unescaped.`\n    );\n\n    log(1, message);\n    return (\n      endCallback &&\n      endCallback(\n        false,\n        JSON.stringify({\n          error: true,\n          message\n        })\n      )\n    );\n  }\n};\n\n/**\n * Prepares an input before exporting.\n *\n * @param {string} stringToExport - String representation of SVG/export options.\n * @param {object} options - All options object.\n * @param {function} endCallback - The function to call when exporting is done.\n */\nconst exportAsString = (stringToExport, options, endCallback) => {\n  const { allowCodeExecution } = options.customCode;\n\n  // Check if it is SVG\n  if (\n    stringToExport.indexOf('<svg') >= 0 ||\n    stringToExport.indexOf('<?xml') >= 0\n  ) {\n    log(4, '[chart] Parsing input as SVG.');\n    return doExport(options, false, endCallback, stringToExport);\n  }\n\n  try {\n    // Try to parse to JSON and call the doExport function\n    const chartJSON = JSON.parse(stringToExport.replaceAll(/\\t|\\n|\\r/g, ' '));\n\n    // If a correct JSON, do the export\n    return doExport(options, chartJSON, endCallback);\n  } catch (error) {\n    // Not a valid JSON\n    if (toBoolean(allowCodeExecution)) {\n      return doStraightInject(options, endCallback);\n    } else {\n      // Do not allow straight injection without the allowCodeExecution flag\n      return (\n        endCallback &&\n        endCallback(false, {\n          error: true,\n          message: clearText(\n            `Only JSON configurations and SVG is allowed for this server. If\n            this is your server, JavaScript exporting can be enabled by starting\n            the server with the --allowCodeExecution flag.`\n          )\n        })\n      );\n    }\n  }\n};\n\n/**\n * Starts an exporting process\n *\n * @param {object} settings - Settings for export.\n * @param {function} endCallback - The function to call when exporting is done.\n */\nexport default {\n  startExport: async (settings, endCallback) => {\n    // Starting exporting process message\n    log(4, '[chart] Starting exporting process.');\n\n    // Initialize options\n    const options = initExportSettings(settings, poolOptions);\n\n    // Get the export options\n    const exportOptions = options.export;\n\n    // If SVG is an input (argument can be sent only by the request)\n    if (options.payload?.svg && options.payload.svg !== '') {\n      return exportAsString(options.payload.svg.trim(), options, endCallback);\n    }\n\n    // Export using options from the file\n    if (exportOptions.infile && exportOptions.infile.length) {\n      log(4, '[chart] Attempting to export from an input file.');\n\n      // Try to read the file\n      return readFile(exportOptions.infile, 'utf8', (error, infile) => {\n        if (error) {\n          return log(1, `[chart] Error loading input file: ${error}.`);\n        }\n\n        // Get the string representation\n        options.export.instr = infile;\n        return exportAsString(\n          options.export.instr.trim(),\n          options,\n          endCallback\n        );\n      });\n    }\n\n    // Export with options from the raw representation\n    if (\n      (exportOptions.instr && exportOptions.instr !== '') ||\n      (exportOptions.options && exportOptions.options !== '')\n    ) {\n      log(4, '[chart] Attempting to export from a raw input.');\n\n      // Perform a direct inject when forced\n      if (toBoolean(options.customCode?.allowCodeExecution)) {\n        return doStraightInject(options, endCallback);\n      }\n\n      // Either try to parse to JSON first or do the direct export\n      return typeof exportOptions.instr === 'string'\n        ? exportAsString(exportOptions.instr.trim(), options, endCallback)\n        : doExport(\n            options,\n            exportOptions.instr || exportOptions.options,\n            endCallback\n          );\n    }\n\n    // No input specified, pass an error message to the callback\n    log(\n      1,\n      clearText(\n        `[chart] No input specified.\n        ${JSON.stringify(exportOptions, undefined, '  ')}.`\n      )\n    );\n\n    return (\n      endCallback &&\n      endCallback(false, {\n        error: true,\n        message: 'No input specified.'\n      })\n    );\n  },\n  getAllowCodeExecution: () => allowCodeExecution,\n  setAllowCodeExecution: (value) => {\n    allowCodeExecution = toBoolean(value);\n  },\n  setPoolOptions: (options) => {\n    poolOptions = options;\n  },\n  findChartSize\n};\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport { v4 as uuid } from 'uuid';\nimport { Pool } from 'tarn';\nimport {\n  close,\n  newPage as browserNewPage,\n  create as createBrowser\n} from './browser.js';\nimport { log } from './logger.js';\n\nimport puppeteerExport from './export.js';\nimport chart from './chart.js';\n\nlet performedExports = 0;\nlet exportAttempts = 0;\nlet timeSpent = 0;\nlet droppedExports = 0;\nlet spentAverage = 0;\nlet poolConfig = {};\n\n// The pool instance\nlet pool = false;\n\n// Custom puppeteer arguments\nlet puppeteerArgs;\n\nconst factory = {\n  /**\n   * Creates a new worker.\n   *\n   * @return {object} - An object with the id of a resource, the work count and\n   * a reference to the browser page.\n   */\n  create: async () => {\n    const id = uuid();\n    let page = false;\n\n    const s = new Date().getTime();\n\n    try {\n      page = await browserNewPage();\n\n      if (!page || page.isClosed()) {\n        throw 'invalid page';\n      }\n\n      log(\n        3,\n        `[pool] Successfully created a worker ${id} - took ${\n          new Date().getTime() - s\n        } ms.`\n      );\n    } catch (error) {\n      log(\n        1,\n        `[pool] Error creating a new page in pool entry creation! ${error}`\n      );\n\n      throw 'Error creating page';\n    }\n\n    return {\n      id,\n      page,\n      // Try to distribute the initial work count\n      workCount: Math.round(Math.random() * (poolConfig.workLimit / 2))\n    };\n  },\n\n  /**\n   * Validates a worker.\n   *\n   * @param {object} workerHandle - A browser's instance.\n   *\n   * @return {boolean} - Bool that indicates if a resource is valid or not.\n   */\n  validate: (workerHandle) => {\n    if (\n      poolConfig.workLimit &&\n      ++workerHandle.workCount > poolConfig.workLimit\n    ) {\n      log(\n        3,\n        `[pool] Worker failed validation:`,\n        `exceeded work limit (limit is ${poolConfig.workLimit})`\n      );\n      return false;\n    }\n    return true;\n  },\n\n  /**\n   * Destroys a worker.\n   *\n   * @param {object} workerHandle - A browser's instance.\n   */\n  destroy: (workerHandle) => {\n    log(3, `[pool] Destroying pool entry ${workerHandle.id}.`);\n\n    if (workerHandle.page) {\n      // We don't really need to wait around for this.\n      workerHandle.page.close();\n    }\n  },\n\n  // Logger function\n  log: (message, logLevel) => console.log(`${logLevel}: ${message}`)\n}\n\n/**\n * Inits the pool of resources.\n *\n * @param {object} config - Pool configuration along with custom puppeteer\n * arguments for the puppeteer.launch function.\n */\nexport const init = async (config) => {\n  // The newest puppeteer arguments for the browser creation\n  puppeteerArgs = config.puppeteerArgs;\n\n  // Wait until we've sucessfully created a browser instance.\n  try {\n    await createBrowser(puppeteerArgs);\n  } catch (e) {\n    log(0, '[pool|browser]', e);\n  }\n\n  // For the module scope usage\n  poolConfig = config && config.pool ? { ...config.pool } : {};\n\n  log(\n    3,\n    '[pool] Initializing pool:',\n    `min ${poolConfig.initialWorkers}, max ${poolConfig.maxWorkers}.`\n  );\n\n  if (pool) {\n    return log(\n      4,\n      '[pool] Already initialized, please kill it before creating a new one.'\n    );\n  }\n\n  // Attach process' exit listeners\n  if (poolConfig.listenToProcessExits) {\n    attachProcessExitListeners();\n  }\n\n  try {\n    // Create a pool along with a minimal number of resources\n    pool = new Pool({\n      // Get the create/validate/destroy/log functions\n      ...factory,\n      min: poolConfig.initialWorkers,\n      max: poolConfig.maxWorkers,\n      createRetryIntervalMillis: 200,\n      createTimeoutMillis: poolConfig.acquireTimeout,\n      acquireTimeoutMillis: poolConfig.acquireTimeout,\n      destroyTimeoutMillis: poolConfig.acquireTimeout,\n      idleTimeoutMillis: poolConfig.timeoutThreshold,\n      reapIntervalMillis: 1000, // poolConfig.reaper ? 120000 : 0, for now\n      propagateCreateError: false\n    });\n\n    // Set events\n    pool.on('createFail', (eventId, err) => {\n      log(1, `[pool] Error when creating worker of an event id ${eventId}:`, err);\n    });\n\n    pool.on('acquireFail', (eventId, err) => {\n      log(1, `[pool] Error when acquiring worker of an event id ${eventId}:`, err);\n    });\n\n    pool.on('destroyFail', (eventId, resource, err) => {\n      log(1, `[pool] Error when destroying worker of an id ${resource.id}, event id ${eventId}:`, err);\n    });\n\n    pool.on('release', (resource) => {\n      log(4, `[pool] Releasing a worker of an id ${resource.id}`);\n    });\n\n    pool.on('destroySuccess', (eventId, resource) => {\n      log(4, `[pool] Destroyed a worker of an id ${resource.id}`);\n    });\n\n    const initialResources = [];\n    // Create an initial number of resources\n    for (let i = 0; i < poolConfig.initialWorkers; i++) {\n      initialResources.push(await pool.acquire().promise);\n    }\n\n    // Release the initial number of resources back to the pool\n    initialResources.forEach((resource) => {\n      pool.release(resource);\n    });\n\n    log(\n      3,\n      `[pool] The pool is ready with ${poolConfig.initialWorkers} initial resources waiting.`\n    );\n  } catch (error) {\n    log(1, `[pool] Couldn't create the worker pool ${error}`);\n    throw error;\n  }\n};\n\n/**\n * Attaches process' exit listeners.\n */\nexport function attachProcessExitListeners() {\n  log(4, '[pool] Attaching exit listeners to the process.');\n\n  // Kill all pool resources on exit\n  process.on('exit', async () => {\n    await killAll();\n  });\n\n  // Handler for the SIGINT\n  process.on('SIGINT', (name, code) => {\n    log(4, `The ${name} event with code: ${code}.`);\n    process.exit(1);\n  });\n\n  // Handler for the SIGTERM\n  process.on('SIGTERM', (name, code) => {\n    log(4, `The ${name} event with code: ${code}.`);\n    process.exit(1);\n  });\n\n  // Handler for the uncaughtException\n  process.on('uncaughtException', async (error, name) => {\n    log(4, `The ${name} error, message: ${error.message}.`);\n  });\n}\n\n/**\n * Kills the pool and flush the browser instance.\n */\nexport async function killAll() {\n  log(3, '[pool] Killing all workers.');\n\n  chart.setPoolOptions({});\n\n  // Close browser instance\n  try {\n    await close();\n  } catch {\n    // if the browser has already been closed,\n    // skip the rest of this function\n    log(4, \"[pool] Worker has already been killed.\");\n    return;\n  }\n\n  // Return true when pool is already dead\n  if (!pool) {\n    return true;\n  }\n\n  // Destroy the pool\n  return pool.destroy();\n}\n\n/**\n * Posts work to the pool.\n *\n * @param {object} chart - Chart's options.\n * @param {object} options - All options object.\n */\nexport const postWork = async (chart, options) => {\n  let workerHandle;\n\n  // Handle fail conditions\n  const fail = (msg) => {\n    ++droppedExports;\n\n    if (workerHandle) {\n      pool.release(workerHandle);\n    }\n\n    throw 'In pool.postWork: ' + msg;\n  };\n\n  log(4, '[pool] Work received, starting to process.');\n\n  if (poolConfig.benchmarking) {\n    getPoolInfo();\n  }\n\n  ++exportAttempts;\n\n  if (!pool) {\n    log(1, '[pool] Work received, but pool has not been started.');\n    return fail('Pool is not inited but work was posted to it!');\n  }\n\n  // Acquire the worker along with the id of resource and work count\n  try {\n    log(4, '[pool] Acquiring worker');\n    workerHandle = await pool.acquire().promise;\n  } catch (error) {\n    return fail(`[pool] Error when acquiring available entry: ${error}`);\n  }\n\n  log(4, '[pool] Acquired worker handle');\n\n  if (!workerHandle.page) {\n    return fail('Resolved worker page is invalid: pool setup is wonky');\n  }\n\n  try {\n    // Save the start time\n    let workStart = new Date().getTime();\n\n    log(4, `[pool] Starting work on pool entry ${workerHandle.id}.`);\n\n    // Perform an export on a puppeteer level\n    const result = await puppeteerExport(workerHandle.page, chart, options);\n\n    // Check if it's an error\n    if (result instanceof Error) {\n      // TODO: If the export failed because puppeteer timed out, we need to force kill the worker so we get a new page. That needs to be handled better than this hack.\n      if (result.message === 'Rasterization timeout') {\n        workerHandle.page.close();\n        workerHandle.page = await browserNewPage();\n      }\n\n      return fail(result);\n    }\n\n    // Release the resource back to the pool\n    pool.release(workerHandle);\n\n    // Used for statistics in averageTime and processedWorkCount, which\n    // in turn is used by the /health route.\n    const workEnd = new Date().getTime();\n    const exportTime = workEnd - workStart;\n    timeSpent += exportTime;\n    spentAverage = timeSpent / ++performedExports;\n\n    log(4, `[pool] Work completed in ${exportTime} ms.`);\n\n    // Otherwise return the result\n    return {\n      data: result,\n      options\n    };\n  } catch (error) {\n    fail(`Error trying to perform puppeteer export: ${error}.`);\n  }\n};\n\n/**\n * Gets the pool.\n */\nexport function getPool() {\n  return pool;\n}\n\nexport const getPoolInfoJSON = () => ({\n  min: pool.min,\n  max: pool.max,\n  size: pool.size,\n  available: pool.available,\n  borrowed: pool.borrowed,\n  pending: pool.pending,\n  spareResourceCapacity: pool.spareResourceCapacity\n});\n\n/**\n * Gets the pool's information.\n */\nexport function getPoolInfo() {\n  const {\n    min,\n    max,\n    size,\n    available,\n    borrowed,\n    pending,\n    spareResourceCapacity\n  } = pool;\n\n  log(4, `[pool] The minimum number of resources allowed by pool: ${min}.`);\n  log(4, `[pool] The maximum number of resources allowed by pool: ${max}.`);\n  log(\n    4,\n    `[pool] The number of all resources in pool (free or in use): ${size}.`\n  );\n  log(\n    4,\n    `[pool] The number of resources that are currently available: ${available}.`\n  );\n  log(\n    4,\n    `[pool] The number of resources that are currently acquired: ${borrowed}.`\n  );\n  log(\n    4,\n    `[pool] The number of callers waiting to acquire a resource: ${pending}.`\n  );\n  log(\n    4,\n    `[pool] The number of how many more resources can the pool manage/create: ${spareResourceCapacity}.`\n  );\n}\n\nexport default {\n  init,\n  killAll,\n  postWork,\n  getPool,\n  getPoolInfo,\n  getPoolInfoJSON,\n  workAttempts: () => exportAttempts,\n  droppedWork: () => droppedExports,\n  averageTime: () => spentAverage,\n  processedWorkCount: () => performedExports\n};\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport cache from '../../cache.js';\nimport pool from '../../pool.js';\n\nconst packageVersion = process.env.npm_package_version;\nconst serverStartTime = new Date();\n\n/**\n * Adds the /health route which outputs basic stats for the server\n */\nexport default (app) =>\n  !app\n    ? false\n    : app.get('/health', (request, response) => {\n        response.send({\n          status: 'OK',\n          bootTime: serverStartTime,\n          uptime:\n            Math.floor(\n              (new Date().getTime() - serverStartTime.getTime()) / 1000 / 60\n            ) + ' minutes',\n          version: packageVersion,\n          highchartsVersion: cache.version(),\n          averageProcessingTime: pool.averageTime(),\n          performedExports: pool.processedWorkCount(),\n          failedExports: pool.droppedWork(),\n          exportAttempts: pool.workAttempts(),\n          sucessRatio: (pool.processedWorkCount() / pool.workAttempts()) * 100,\n          // eslint-disable-next-line import/no-named-as-default-member\n          pool: pool.getPoolInfoJSON()\n        });\n      });\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport { v4 as uuid } from 'uuid';\n\nimport chart from '../../chart.js';\nimport { initDefaultOptions } from '../../config.js';\nimport { log } from '../../logger.js';\nimport {\n  clearText,\n  fixType,\n  isCorrectJSON,\n  isPrivateRangeUrlFound,\n  mergeConfigOptions,\n  optionsStringify,\n  measureTime\n} from '../../utils.js';\nimport { defaultConfig } from '../../schemas/config.js';\n\n// Reversed MIME types\nconst reversedMime = {\n  png: 'image/png',\n  jpeg: 'image/jpeg',\n  gif: 'image/gif',\n  pdf: 'application/pdf',\n  svg: 'image/svg+xml'\n};\n\n// The requests counter\nlet requestsCounter = 0;\n\nconst benchmark = false;\n\n// The array of callbacks to call before a request\nconst beforeRequest = [];\n\n// The array of callbacks to call after a request\nconst afterRequest = [];\n\n/**\n * Calls callbacks.\n *\n * @param {Array} callbacks - An array of callbacks.\n * @param {object} request - The request.\n * @param {object} response - The response.\n * @param {object} data - The data to send to callbacks.\n * @return {object} - The result from a callback.\n */\nconst doCallbacks = (callbacks, request, response, data) => {\n  let result = true;\n  const { id, uniqueId, type, body } = data;\n\n  callbacks.some((callback) => {\n    if (callback) {\n      let callResponse = callback(request, response, id, uniqueId, type, body);\n\n      if (callResponse !== undefined && callResponse !== true) {\n        result = callResponse;\n      }\n\n      return true;\n    }\n  });\n\n  return result;\n};\n\n/**\n * Handles an export.\n *\n * @param {object} request - The request.\n * @param {object} response - The response.\n */\nconst exportHandler = (request, response) => {\n  // Start counting time\n  const stopCounter = measureTime();\n\n  // Get default options from the config\n  const defaultOptions = initDefaultOptions(defaultConfig);\n\n  // Init default options\n  if (benchmark) {\n    console.log('Init default options:', stopCounter(), 'ms.');\n  }\n\n  const body = request.body;\n  const id = ++requestsCounter;\n  const uniqueId = uuid().replace(/-/g, '');\n  let type = fixType(body.type);\n\n  // Fix type\n  if (benchmark) {\n    console.log('Fix type:', stopCounter(), 'ms.');\n  }\n\n  // Throw 'Bad Request' if there's no body\n  if (!body) {\n    return response.status(400).send(\n      clearText(\n        `Body is required. Sending a body? Make sure your Content-type header\n        is correct. Accepted is application/json and multipart/form-data.`\n      )\n    );\n  }\n\n  // All of the below can be used\n  let instr = isCorrectJSON(body.infile || body.options || body.data);\n\n  // Is correct JSON\n  if (benchmark) {\n    console.log('Is correct JSON:', stopCounter(), 'ms.');\n  }\n\n  // Throw 'Bad Request' if there's no JSON or SVG to export\n  if (!instr && !body.svg) {\n    log(\n      2,\n      clearText(\n        `Request ${uniqueId} from ${\n          request.headers['x-forwarded-for'] || request.connection.remoteAddress\n        } was incorrect. Check your payload.`\n      )\n    );\n\n    return response.status(400).send(\n      clearText(\n        `No correct chart data found. Please make sure you are using\n        application/json or multipart/form-data headers, and that the chart\n        data is in the 'infile', 'options' or 'data' attribute if sending\n        JSON or in the 'svg' if sending SVG.`\n      )\n    );\n  }\n\n  let callResponse = false;\n\n  // Call the before request functions\n  callResponse = doCallbacks(beforeRequest, request, response, {\n    id,\n    uniqueId,\n    type,\n    body\n  });\n\n  // Do callbacks\n  if (benchmark) {\n    console.log('Do callbacks:', stopCounter(), 'ms.');\n  }\n\n  // Block the request if one of a callbacks failed\n  if (callResponse !== true) {\n    return response.send(callResponse);\n  }\n\n  let connectionAborted = false;\n\n  // In case the connection is closed, force to abort further actions\n  request.socket.on('close', () => {\n    connectionAborted = true;\n  });\n\n  log(4, `[export] Got an incoming HTTP request ${uniqueId}.`);\n\n  body.constr = (typeof body.constr === 'string' && body.constr) || 'chart';\n\n  // Gather and organize options from the payload\n  const requestOptions = {\n    export: {\n      instr,\n      type,\n      constr: body.constr[0].toLowerCase() + body.constr.substr(1),\n      height: body.height,\n      width: body.width,\n      scale: body.scale || defaultOptions.export.scale,\n      globalOptions: isCorrectJSON(body.globalOptions, true),\n      themeOptions: isCorrectJSON(body.themeOptions, true)\n    },\n    customCode: {\n      allowCodeExecution: chart.getAllowCodeExecution(),\n      allowFileResources: false,\n      resources: isCorrectJSON(body.resources, true),\n      callback: body.callback,\n      customCode: body.customCode\n    }\n  };\n\n  // Organize options\n  if (benchmark) {\n    console.log('Organize options:', stopCounter(), 'ms.');\n  }\n\n  if (instr) {\n    // Stringify JSON with options\n    requestOptions.export.instr = optionsStringify(\n      instr,\n      requestOptions.customCode.allowCodeExecution\n    );\n\n    // Stringify JSON with options\n    if (benchmark) {\n      console.log('Stringify JSON with options:', stopCounter(), 'ms.');\n    }\n  }\n\n  // Merge the request options into default ones\n  const options = mergeConfigOptions(defaultOptions, requestOptions);\n\n  // Merge config options\n  if (benchmark) {\n    console.log('Merge config options:', stopCounter(), 'ms.');\n  }\n\n  // Save the JSON if exists\n  options.export.options = instr;\n\n  // Lastly, add the server specific arguments into options as payload\n  options.payload = {\n    svg: body.svg || false,\n    b64: body.b64 || false,\n    dataOptions: isCorrectJSON(body.dataOptions, true),\n    noDownload: body.noDownload || false,\n    requestId: uniqueId\n  };\n\n  // Setting payload\n  if (benchmark) {\n    console.log('Setting payload:', stopCounter(), 'ms.');\n  }\n\n  // Test xlink:href elements from payload's SVG\n  if (body.svg && isPrivateRangeUrlFound(options.payload.svg)) {\n    return response\n      .status(400)\n      .send(\n        'SVG potentially contain at least one forbidden URL in xlink:href element.'\n      );\n  }\n\n  // Check URL range\n  if (benchmark) {\n    console.log('Check URL range:', stopCounter(), 'ms.');\n  }\n\n  // Start the export process\n  chart.startExport(options, (info, error) => {\n    // Remove the close event from the socket\n    request.socket.removeAllListeners('close');\n\n    // After Puppeteer exporting\n    if (benchmark) {\n      console.log('After Puppeteer exporting:', stopCounter(), 'ms.', '\\n');\n    }\n\n    // If the connection was closed, do nothing\n    if (connectionAborted) {\n      return log(\n        3,\n        clearText(\n          `[export] The client closed the connection before the chart was done\n          processing.`\n        )\n      );\n    }\n\n    // If error, return it\n    if (error) {\n      log(\n        1,\n        clearText(\n          `[export] Work: ${uniqueId} could not be completed, sending:\n          ${error}`\n        )\n      );\n      return response.status(400).send(error.message);\n    }\n\n    // If data is missing, return the error\n    if (!info || !info.data) {\n      log(\n        1,\n        clearText(\n          `[export] Unexpected return from chart generation, please check your\n          data Request: ${uniqueId} is ${info.data}.`\n        )\n      );\n      return response\n        .status(400)\n        .send(\n          'Unexpected return from chart generation, please check your data.'\n        );\n    }\n\n    // Get the type from options\n    type = info.options.export.type;\n\n    // The after request callbacks\n    doCallbacks(afterRequest, request, response, { id, body: info.data });\n\n    if (info.data) {\n      // If only base64 is required, return it\n      if (body.b64) {\n        // Check if it is already base64 or a raw SVG\n        if (type === 'pdf') {\n          return response.send(\n            Buffer.from(info.data, 'utf8').toString('base64')\n          );\n        }\n        return response.send(info.data);\n      }\n\n      // Set correct content type\n      response.header('Content-Type', reversedMime[type] || 'image/png');\n\n      // Decide whether to download or not chart file\n      if (!body.noDownload) {\n        response.attachment(\n          `${request.params.filename || 'chart'}.${type || 'png'}`\n        );\n      }\n\n      // If SVG, return plain content\n      return type === 'svg'\n        ? response.send(info.data)\n        : response.send(Buffer.from(info.data, 'base64'));\n    }\n  });\n};\n\nexport default (app) => {\n  app.post('/', exportHandler);\n  app.post('/:filename', exportHandler);\n};\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport { promises as fsPromises } from 'fs';\nimport { posix } from 'path';\n\nimport bodyParser from 'body-parser';\nimport cors from 'cors';\nimport express from 'express';\nimport multer from 'multer';\nimport http from 'http';\nimport https from 'https';\n\nimport { log } from '../logger.js';\nimport rateLimit from './rate_limit.js';\nimport { __dirname } from '../utils.js';\n\nimport healthRoute from './routes/health.js';\nimport exportRoutes from './routes/export.js';\nimport vswitchRoute from './routes/change-hc-version.js';\nimport uiRoute from './routes/ui.js';\n\n// Create express app\nconst app = express();\n\n// Disable the X-Powered-By header\napp.disable('x-powered-by');\n\n// Enable CORS support\napp.use(cors());\n\n// Enable parsing of form data (files) with Multer package\nconst storage = multer.memoryStorage();\nconst upload = multer({\n    storage,\n    limits: {\n        fieldsSize: '50MB'\n    }\n});\n\napp.use(upload.any());\n\n// Enable body parser\napp.use(bodyParser.json({ limit: '50mb' }));\napp.use(bodyParser.urlencoded({ extended: true, limit: '50mb' }));\napp.use(bodyParser.urlencoded({ extended: false, limit: '50mb' }));\n\n/**\n * Error handler function.\n *\n * @param {object} error - An error object.\n * @return {string} - An error message.\n */\nconst errorHandler = (error) => log(1, `[server] Socket error: ${error}`);\n\n/**\n * Attaches error handlers for a server.\n *\n * @param {object} server - The http/https server.\n */\nconst attachErrorHandlers = (server) => {\n  server.on('clientError', errorHandler);\n  server.on('error', errorHandler);\n  server.on('connection', (socket) =>\n    socket.on('error', (error) => errorHandler(error, socket))\n  );\n};\n\nexport const start = async (serverConfig) => {\n  // Stop if not enabled\n  if (!serverConfig.enable) {\n    return false;\n  }\n\n  // // Get the pool\n  // const pool = getPool();\n\n  // // Try to create browser instance before starting the server\n  // const resource = await pool.acquire();\n\n  // // If not found, throw an error\n  // if (!resource.browser) {\n  //   log(1, `[s:erver] Could not acquire browser instance.`);\n  //   process.exit(1);\n  // }\n\n  // // Release the resource\n  // pool.release(resource);\n\n  // Listen HTTP server\n  if (!serverConfig.ssl.enable && !serverConfig.ssl.force) {\n    // Main server instance (HTTP)\n    const httpServer = http.createServer(app);\n    // Attach error handlers and listen to the server\n    attachErrorHandlers(httpServer);\n    // Listen\n    httpServer.listen(serverConfig.port, serverConfig.host);\n\n    log(\n      3,\n      `[server] Started HTTP server on ${serverConfig.host}:${serverConfig.port}.`\n    );\n  }\n\n  // Listen HTTPS server\n  if (serverConfig.ssl.enable) {\n    // Set up an SSL server also\n    let key, cert;\n\n    try {\n      // Get the SSL key\n      key = await fsPromises.readFile(\n        posix.join(serverConfig.ssl.certPath, 'server.key'),\n        'utf8'\n      );\n\n      // Get the SSL certificate\n      cert = await fsPromises.readFile(\n        posix.join(serverConfig.ssl.certPath, 'server.crt'),\n        'utf8'\n      );\n    } catch (error) {\n      log(\n        1,\n        `[server] Unable to load key/certificate from ${serverConfig.ssl.certPath}.`\n      );\n    }\n\n    if (key && cert) {\n      // Main server instance (HTTPS)\n      const httpsServer = https.createServer(app);\n      // Attach error handlers and listen to the server\n      attachErrorHandlers(httpsServer);\n      // Listen\n      httpsServer.listen(serverConfig.ssl.port, serverConfig.host);\n\n      log(\n        3,\n        `[server] Started HTTPS server on ${serverConfig.host}:${serverConfig.ssl.port}.`\n      );\n    }\n  }\n\n  // Enable the rate limiter if config says so\n  if (\n    serverConfig.rateLimiting &&\n    serverConfig.rateLimiting.enable &&\n    ![0, NaN].includes(serverConfig.rateLimiting.maxRequests)\n  ) {\n    rateLimit(app, serverConfig.rateLimiting);\n  }\n\n  // Set up static folder's route\n  app.use(express.static(posix.join(__dirname, 'public')));\n\n  // Set up routes\n  healthRoute(app);\n  exportRoutes(app);\n  uiRoute(app);\n  vswitchRoute(app);\n};\n\n/**\n * Returns the express instance.\n */\nexport const getExpress = () => {\n  return express;\n};\n\n/**\n * Returns the app instance.\n */\nexport const getApp = () => {\n  return app;\n};\n\n/**\n * Adds a middleware to the server.\n *\n * @param {object} path - An endpoint path to add middlewares to.\n * @param {Array} middlewares - An unlimited number of middlewares to use\n * against the specific endpoint.\n */\nexport const use = (path, ...middlewares) => {\n  app.use(path, ...middlewares);\n};\n\n/**\n * Adds a get route to the server.\n *\n * @param {object} path - An endpoint path to add middlewares to.\n * @param {Array} middlewares - An unlimited number of middlewares to use\n * against the specific endpoint for GET method.\n */\nexport const get = (path, ...middlewares) => {\n  app.get(path, ...middlewares);\n};\n\n/**\n * Adds a post route to the server.\n *\n * @param {object} path - An endpoint path to add middlewares to.\n * @param {Array} middlewares - An unlimited number of middlewares to use\n * against the specific endpoint for POST method.\n */\nexport const post = (path, ...middlewares) => {\n  app.post(path, ...middlewares);\n};\n\n/**\n * Forcefully enables rate limiting.\n *\n * @param {object} limitConfig - The options object for the rate limiter\n * configuration.\n */\nexport const enableRateLimiting = (limitConfig) => {\n  return rateLimit(app, limitConfig);\n};\n\nexport default {\n  start,\n  getExpress,\n  getApp,\n  use,\n  get,\n  post,\n  enableRateLimiting\n};\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport { join } from 'path';\n\nimport { __dirname } from '../../utils.js';\n/**\n * Adds the / route for a UI when enabled for the export server\n */\nexport default (app) =>\n  !app\n    ? false\n    : app.get('/', (request, response) => {\n        response.sendFile(join(__dirname, 'public', 'index.html'));\n      });\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\nimport cache from '../../cache.js';\n\n/**\n * Adds a route that can be used to change the HC version on the server\n * TODO: Add auth token and connect to API\n */\nexport default (app) =>\n  !app\n    ? false\n    : app.post('/change-hc-version/:newVersion', async (request, response) => {\n        const ctoken = process.env.HIGHCHARTS_ADMIN_TOKEN;\n\n        if (!ctoken || !ctoken.length) {\n          return response.send({\n            error: true,\n            message:\n              'Server not configured to do run-time version changes: HIGHCHARTS_ADMIN_TOKEN not set'\n          });\n        }\n\n        const token = request.get('hc-auth');\n\n        if (!token || token !== ctoken) {\n          return response.send({\n            error: true,\n            message: 'Invalid or missing token: set token in the hc-auth header'\n          });\n        }\n\n        const newVersion = request.params.newVersion;\n\n        if (newVersion) {\n          try {\n            // eslint-disable-next-line import/no-named-as-default-member\n            await cache.updateVersion(newVersion);\n          } catch (e) {\n            response.send({\n              error: true,\n              message: e\n            });\n          }\n\n          response.send({\n            version: cache.version()\n          });\n        } else {\n          response.send({\n            error: true,\n            message: 'No new version supplied'\n          });\n        }\n      });\n","/*******************************************************************************\n\nHighcharts Export Server\n\nCopyright (c) 2016-2023, Highsoft\n\nLicenced under the MIT licence.\n\nAdditionally a valid Highcharts license is required for use.\n\nSee LICENSE file in root for details.\n\n*******************************************************************************/\n\n// Add the main directory in the global object\nimport 'colors';\n\nimport server, { start } from './server/server.js';\nimport chart from './chart.js';\nimport { log, setLogLevel, enableFileLogging } from './logger.js';\nimport { killAll, init } from './pool.js';\nimport { initDefaultOptions, loadConfigFile } from './config.js';\nimport { checkCache } from './cache.js';\nimport { mergeConfigOptions } from './utils.js';\nimport { defaultConfig } from './schemas/config.js';\n\nexport default {\n  log,\n  server,\n  startExport: chart.startExport,\n  startServer: start,\n  killPool: killAll,\n  initPool: async (options = {}) => {\n    const defaultOptions = initDefaultOptions(defaultConfig);\n\n    // Load an optional config file\n    options = await loadConfigFile(mergeConfigOptions(defaultOptions, options));\n\n    // Set the allowCodeExecution per export module scope\n    chart.setAllowCodeExecution(\n      options.customCode && options.customCode.allowCodeExecution\n    );\n\n    // Set the log level\n    setLogLevel(options.logging && parseInt(options.logging.level));\n\n    // Set the log file path and name\n    if (options.logging && options.logging.dest) {\n      enableFileLogging(\n        options.logging.dest,\n        options.logging.file || 'highcharts-export-server.log'\n      );\n    }\n\n    // Check if cache needs to be updated\n    await checkCache(options.highcharts || { version: 'latest' });\n\n    // Init the pool\n    await init({\n      pool: options.pool || {\n        initialWorkers: 1,\n        maxWorkers: 1\n      },\n      puppeteerArgs: options.puppeteer?.args || []\n    });\n\n    chart.setPoolOptions(options);\n\n    // Return updated options\n    return options;\n  }\n};\n"],"names":["dotenv","config","defaultConfig","puppeteer","args","value","type","description","highcharts","version","envLink","cdnURL","coreScripts","modules","indicators","scripts","export","infile","instr","options","outfile","constr","defaultHeight","defaultWidth","defaultScale","height","width","scale","globalOptions","themeOptions","batch","customCode","allowCodeExecution","allowFileResources","callback","resources","loadConfig","createConfig","server","enable","cliName","host","port","ssl","force","certPath","rateLimiting","maxRequests","window","delay","trustProxy","skipKey","skipToken","pool","initialWorkers","maxWorkers","workLimit","queueSize","timeoutThreshold","acquireTimeout","reaper","benchmarking","listenToProcessExits","payload","logging","level","file","dest","ui","route","other","noLogo","join","nestedArgs","envVars","initConfig","obj","propChain","Object","keys","forEach","k","includes","entry","numEnvVal","item","process","env","find","el","indexOf","split","push","name","substring","toConsole","toFile","pathCreated","levelsDesc","title","color","listeners","key","option","entries","log","newLevel","texts","length","prefix","Date","toString","trim","fn","existsSync","mkdirSync","appendFile","concat","error","console","apply","undefined","__dirname","fileURLToPath","URL","url","clearText","text","rule","replacer","replaceAll","fixType","formats","outType","pop","t","handleResources","allowedProps","handledResources","correctResources","endsWith","isCorrectJSON","readFileSync","notice","files","propName","map","data","parsedData","JSON","parse","stringify","deepCopy","copy","Array","isArray","prototype","hasOwnProperty","call","mergeConfigOptions","newOptions","absoluteProps","mergedOptions","optionsStringify","allowFunctions","startsWith","toBoolean","wrapAround","replace","rateLimit","app","limitConfig","msg","rateOptions","max","limiter","windowMs","delayMs","handler","request","response","format","json","status","send","message","default","skip","query","access_token","use","async","fetch","requestOptions","Promise","resolve","reject","protocol","https","http","getProtocol","get","res","on","chunk","cachePath","cache","activeManifest","sources","hcVersion","appliedConfig","extractVersion","substr","fetchScript","script","proxyAgent","agent","timeout","statusCode","updateCache","sourcePath","customScripts","allScripts","c","m","i","proxyHost","proxyPort","HttpsProxyAgent","fetchedModules","all","writeFileSync","checkCache","manifestPath","requestUpdate","manifest","moduleMap","numberOfModules","some","moduleName","newManifest","saveConfigToManifest","cache$1","newVersion","assign","RANDOM_PID","randomBytes","PUPPETEER_DIR","path","minimalArgs","template","fs","browser","newPage","p","setContent","addScriptTag","evaluate","setupHighcharts","err","$eval","element","errorMessage","_displayErrors","innerHTML","close","__basedir","setAsConfig","page","chart","triggerExport","puppeteerExport","injectedResources","clearInjected","dispose","scriptsToRemove","document","getElementsByTagName","stylesToRemove","linksToRemove","remove","exportBench","exportOptions","requestAnimationFrame","displayErrors","debugger","d","svgBench","isSVG","setPageBench","svgTemplate","strInj","setContentBench","resBench","js","content","isLocal","cssBench","css","cssImports","match","cssImportPath","addStyleTag","size","chartHeight","baseVal","chartWidth","parseFloat","Highcharts","charts","vpBench","viewportHeight","Math","ceil","viewportWidth","setViewport","deviceScaleFactor","zoomCallback","body","style","zoom","margin","x","y","getBoundingClientRect","trunc","getClipRegion","round","expBenchmark","outerHTML","createSVG","encoding","clip","race","screenshot","setTimeout","Error","createImage","pdf","createPDF","oldCharts","oldChart","destroy","shift","initDefaultOptions","items","poolOptions","findChartSize","exporting","precision","multiplier","pow","roundNumber","sourceHeight","sourceWidth","doExport","chartJson","endCallback","svg","customCodeOptions","allowCodeExecutionScoped","enabled","optionsName","postWork","then","result","catch","doStraightInject","requestId","exportAsString","stringToExport","chartJSON","startExport","settings","initExportSettings","readFile","getAllowCodeExecution","setAllowCodeExecution","setPoolOptions","puppeteerArgs","performedExports","exportAttempts","timeSpent","droppedExports","spentAverage","poolConfig","factory","create","id","uuid","s","getTime","browserNewPage","isClosed","workCount","random","validate","workerHandle","logLevel","init","allArgs","tryCount","open","launch","headless","userDataDir","e","createBrowser","killAll","code","exit","Pool","min","createRetryIntervalMillis","createTimeoutMillis","acquireTimeoutMillis","destroyTimeoutMillis","idleTimeoutMillis","reapIntervalMillis","propagateCreateError","eventId","resource","initialResources","acquire","promise","release","fail","getPoolInfo","workStart","exportTime","available","borrowed","pending","spareResourceCapacity","pool$1","packageVersion","npm_package_version","serverStartTime","reversedMime","png","jpeg","gif","requestsCounter","beforeRequest","afterRequest","doCallbacks","callbacks","uniqueId","callResponse","exportHandler","start","hrtime","bigint","measureTime","defaultOptions","headers","connection","remoteAddress","connectionAborted","socket","toLowerCase","b64","dataOptions","noDownload","ipRegEx","info","removeAllListeners","Buffer","from","header","attachment","params","filename","express","disable","cors","storage","multer","memoryStorage","upload","limits","fieldsSize","any","bodyParser","limit","urlencoded","extended","errorHandler","attachErrorHandlers","serverConfig","httpServer","createServer","listen","cert","fsPromises","posix","httpsServer","NaN","static","bootTime","uptime","floor","highchartsVersion","averageProcessingTime","failedExports","sucessRatio","healthRoute","post","exportRoutes","sendFile","uiRoute","ctoken","HIGHCHARTS_ADMIN_TOKEN","token","vswitchRoute","getExpress","getApp","middlewares","enableRateLimiting","index","startServer","killPool","initPool","configFile","loadConfigFile","parseInt","logDest","logFile","enableFileLogging"],"mappings":"snBAiBAA,EAAOC,SAIA,MAAMC,EAAgB,CAC3BC,UAAW,CACTC,KAAM,CACJC,MAAO,GACPC,KAAM,WACNC,YAAa,6CAGjBC,WAAY,CACVC,QAAS,CACPJ,MAAO,SACPK,QAAS,qBACTJ,KAAM,SACNC,YAAa,8BAEfI,OAAQ,CACNN,MAAO,+BACPK,QAAS,iBACTJ,KAAM,SACNC,YAAa,6CAEfK,YAAa,CACXF,QAAS,0BACTL,MAAO,CAAC,aAAc,kBAAmB,iBACzCC,KAAM,WACNC,YAAa,qCAEfM,QAAS,CACPH,QAAS,qBACTL,MAAO,CACL,QACA,MACA,QACA,YACA,cACA,uBACA,gBACA,uBACA,eACA,QACA,OACA,mBACA,eACA,cACA,UACA,UACA,WACA,UACA,cACA,YACA,sBACA,SACA,SACA,WACA,YACA,eACA,SACA,eACA,YACA,kBACA,SACA,cACA,mBACA,eACA,cACA,eACA,cACA,cACA,WACA,eACA,WACA,SACA,OACA,WACA,YACA,SACA,qBACA,aACA,WACA,WACA,WACA,WACA,eACA,UACA,kBACA,oBACA,cAEFC,KAAM,WACNC,YAAa,gCAEfO,WAAY,CACVJ,QAAS,wBACTL,MAAO,CAAC,kBACRC,KAAM,WACNC,YAAa,mCAEfQ,QAAS,CACPV,MAAO,CACL,yEAEFC,KAAM,WACNC,YACE,sEAGNS,OAAQ,CACNC,OAAQ,CACNZ,OAAO,EACPC,KAAM,SACNC,YACE,8FAEJW,MAAO,CACLb,OAAO,EACPC,KAAM,SACNC,YACE,iFAEJY,QAAS,CACPd,OAAO,EACPC,KAAM,SACNC,YAAa,oCAEfa,QAAS,CACPf,OAAO,EACPC,KAAM,SACNC,YACE,2FAEJD,KAAM,CACJI,QAAS,sBACTL,MAAO,MACPC,KAAM,SACNC,YACE,sEAEJc,OAAQ,CACNX,QAAS,wBACTL,MAAO,QACPC,KAAM,SACNC,YACE,6EAEJe,cAAe,CACbZ,QAAS,wBACTL,MAAO,IACPC,KAAM,SACNC,YACE,gFAEJgB,aAAc,CACZb,QAAS,uBACTL,MAAO,IACPC,KAAM,SACNC,YACE,+EAEJiB,aAAc,CACZd,QAAS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"}
=======
{"version":3,"file":"index.esm.js","sources":["../lib/schemas/config.js","../lib/logger.js","../lib/utils.js","../lib/server/rate_limit.js","../lib/fetch.js","../lib/cache.js","../lib/browser.js","../lib/export.js","../lib/benchmark.js","../templates/svg_export/svg_export.js","../lib/pool.js","../lib/server/routes/health.js","../lib/config.js","../lib/chart.js","../lib/server/routes/export.js","../lib/server/server.js","../lib/server/routes/ui.js","../lib/server/routes/change_hc_version.js","../lib/index.js"],"sourcesContent":["/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\n// Load .env into environment variables\r\nimport dotenv from 'dotenv';\r\n\r\ndotenv.config();\r\n\r\n// This is the configuration object with all options and their default values,\r\n// also from the .env file if one exists\r\nexport const defaultConfig = {\r\n  puppeteer: {\r\n    args: {\r\n      value: [],\r\n      type: 'string[]',\r\n      description: 'Array of arguments to send to puppeteer.'\r\n    }\r\n  },\r\n  highcharts: {\r\n    version: {\r\n      value: 'latest',\r\n      envLink: 'HIGHCHARTS_VERSION',\r\n      type: 'string',\r\n      description: 'Highcharts version to use.'\r\n    },\r\n    cdnURL: {\r\n      value: 'https://code.highcharts.com/',\r\n      envLink: 'HIGHCHARTS_CDN',\r\n      type: 'string',\r\n      description: 'The CDN URL of Highcharts scripts to use.'\r\n    },\r\n    coreScripts: {\r\n      envLink: 'HIGHCHARTS_CORE_SCRIPTS',\r\n      value: ['highcharts', 'highcharts-more', 'highcharts-3d'],\r\n      type: 'string[]',\r\n      description: 'Highcharts core scripts to fetch.'\r\n    },\r\n    modules: {\r\n      envLink: 'HIGHCHARTS_MODULES',\r\n      value: [\r\n        'stock',\r\n        'map',\r\n        'gantt',\r\n        'exporting',\r\n        'export-data',\r\n        'parallel-coordinates',\r\n        'accessibility',\r\n        'annotations-advanced',\r\n        'boost-canvas',\r\n        'boost',\r\n        'data',\r\n        'draggable-points',\r\n        'static-scale',\r\n        'broken-axis',\r\n        'heatmap',\r\n        'tilemap',\r\n        'timeline',\r\n        'treemap',\r\n        'item-series',\r\n        'drilldown',\r\n        'histogram-bellcurve',\r\n        'bullet',\r\n        'funnel',\r\n        'funnel3d',\r\n        'pyramid3d',\r\n        'networkgraph',\r\n        'pareto',\r\n        'pattern-fill',\r\n        'pictorial',\r\n        'price-indicator',\r\n        'sankey',\r\n        'arc-diagram',\r\n        'dependency-wheel',\r\n        'series-label',\r\n        'solid-gauge',\r\n        'sonification',\r\n        'stock-tools',\r\n        'streamgraph',\r\n        'sunburst',\r\n        'variable-pie',\r\n        'variwide',\r\n        'vector',\r\n        'venn',\r\n        'windbarb',\r\n        'wordcloud',\r\n        'xrange',\r\n        'no-data-to-display',\r\n        'drag-panes',\r\n        'debugger',\r\n        'dumbbell',\r\n        'lollipop',\r\n        'cylinder',\r\n        'organization',\r\n        'dotplot',\r\n        'marker-clusters',\r\n        'hollowcandlestick',\r\n        'heikinashi'\r\n      ],\r\n      type: 'string[]',\r\n      description: 'Highcharts modules to fetch.'\r\n    },\r\n    indicators: {\r\n      envLink: 'HIGHCHARTS_INDICATORS',\r\n      value: ['indicators-all'],\r\n      type: 'string[]',\r\n      description: 'Highcharts indicators to fetch.'\r\n    },\r\n    scripts: {\r\n      value: [\r\n        'https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js'\r\n      ],\r\n      type: 'string[]',\r\n      description:\r\n        'Additional direct scripts/optional dependencies (e.g. moment.js).'\r\n    }\r\n  },\r\n  export: {\r\n    infile: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'The input file name along with a type (json or svg). It can be a correct JSON or SVG file.'\r\n    },\r\n    instr: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'An input in a form of a stringified JSON or SVG file. Overrides the --infile.'\r\n    },\r\n    options: {\r\n      value: false,\r\n      type: 'string',\r\n      description: 'An alias for the --instr option.'\r\n    },\r\n    outfile: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'The output filename along with a type (jpeg, png, pdf or svg). Ignores the --type flag.'\r\n    },\r\n    type: {\r\n      envLink: 'EXPORT_DEFAULT_TYPE',\r\n      value: 'png',\r\n      type: 'string',\r\n      description:\r\n        'The format of the file to export to. Can be jpeg, png, pdf or svg.'\r\n    },\r\n    constr: {\r\n      envLink: 'EXPORT_DEFAULT_CONSTR',\r\n      value: 'chart',\r\n      type: 'string',\r\n      description:\r\n        'The constructor to use. Can be chart, stockChart, mapChart or ganttChart.'\r\n    },\r\n    defaultHeight: {\r\n      envLink: 'EXPORT_DEFAULT_HEIGHT',\r\n      value: 400,\r\n      type: 'number',\r\n      description:\r\n        'The default height of the exported chart. Used when not found any value set.'\r\n    },\r\n    defaultWidth: {\r\n      envLink: 'EXPORT_DEFAULT_WIDTH',\r\n      value: 600,\r\n      type: 'number',\r\n      description:\r\n        'The default width of the exported chart. Used when not found any value set.'\r\n    },\r\n    defaultScale: {\r\n      envLink: 'EXPORT_DEFAULT_SCALE',\r\n      value: 1,\r\n      type: 'number',\r\n      description:\r\n        'The default scale of the exported chart. Ranges between 1 and 5.'\r\n    },\r\n    height: {\r\n      type: 'number',\r\n      value: false,\r\n      description:\r\n        'The default height of the exported chart. Overrides the option in the chart settings.'\r\n    },\r\n    width: {\r\n      type: 'number',\r\n      value: false,\r\n      description:\r\n        'The width of the exported chart. Overrides the option in the chart settings.'\r\n    },\r\n    scale: {\r\n      value: false,\r\n      type: 'number',\r\n      description: 'The scale of the exported chart. Ranges between 1 and 5.'\r\n    },\r\n    globalOptions: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'A stringified JSON or a filename with options to be passed into the Highcharts.setOptions.'\r\n    },\r\n    themeOptions: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'A stringified JSON or a filename with theme options to be passed into the Highcharts.setOptions.'\r\n    },\r\n    batch: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'Starts a batch job. A string that contains input/output pairs: \"in=out;in=out;..\".'\r\n    }\r\n  },\r\n  customCode: {\r\n    allowCodeExecution: {\r\n      envLink: 'HIGHCHARTS_ALLOW_CODE_EXECUTION',\r\n      value: false,\r\n      type: 'boolean',\r\n      description:\r\n        'If set to true, allow for the execution of arbitrary code when exporting.'\r\n    },\r\n    allowFileResources: {\r\n      envLink: 'HIGHCHARTS_ALLOW_FILE_RESOURCES',\r\n      value: true,\r\n      type: 'boolean',\r\n      description:\r\n        'Allow injecting resources from the filesystem. Has no effect when running as a server.'\r\n    },\r\n    customCode: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'A function to be called before chart initialization. Can be a filename with the js extension.'\r\n    },\r\n    callback: {\r\n      value: false,\r\n      type: 'string',\r\n      description: 'A JavaScript file with a function to run on construction.'\r\n    },\r\n    resources: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'An additional resource in a form of stringified JSON. It can contain files, js and css sections.'\r\n    },\r\n    loadConfig: {\r\n      value: false,\r\n      type: 'string',\r\n      description: 'A file that contains a pre-defined config to use.'\r\n    },\r\n    createConfig: {\r\n      value: false,\r\n      type: 'string',\r\n      description:\r\n        'Allows to set options through a prompt and save in a provided config file.'\r\n    }\r\n  },\r\n  server: {\r\n    enable: {\r\n      envLink: 'HIGHCHARTS_SERVER_ENABLE',\r\n      value: false,\r\n      type: 'boolean',\r\n      cliName: 'enableServer',\r\n      description: 'If set to true, starts a server on 0.0.0.0.'\r\n    },\r\n    host: {\r\n      envLink: 'HIGHCHARTS_SERVER_HOST',\r\n      value: '0.0.0.0',\r\n      type: 'string',\r\n      description:\r\n        'The hostname of the server. Also starts a server listening on the supplied hostname.'\r\n    },\r\n    port: {\r\n      envLink: 'HIGHCHARTS_SERVER_PORT',\r\n      value: 7801,\r\n      type: 'number',\r\n      description: 'The port to use for the server. Defaults to 7801.'\r\n    },\r\n    ssl: {\r\n      enable: {\r\n        envLink: 'HIGHCHARTS_SERVER_SSL_ENABLE',\r\n        value: false,\r\n        type: 'boolean',\r\n        cliName: 'enableSsl',\r\n        description: 'Enables the SSL protocol.'\r\n      },\r\n      force: {\r\n        envLink: 'HIGHCHARTS_SERVER_SSL_FORCE',\r\n        value: false,\r\n        type: 'boolean',\r\n        cliName: 'sslForced',\r\n        description:\r\n          'If set to true, forces the server to only serve over HTTPS.'\r\n      },\r\n      port: {\r\n        envLink: 'HIGHCHARTS_SERVER_SSL_PORT',\r\n        value: 443,\r\n        type: 'number',\r\n        cliName: 'sslPort',\r\n        description: 'The port on which to run the SSL server.'\r\n      },\r\n      certPath: {\r\n        envLink: 'HIGHCHARTS_SSL_CERT_PATH',\r\n        value: '',\r\n        type: 'string',\r\n        description: 'The path to the SSL certificate/key.'\r\n      }\r\n    },\r\n    rateLimiting: {\r\n      enable: {\r\n        envLink: 'HIGHCHARTS_RATE_LIMIT_ENABLE',\r\n        value: false,\r\n        type: 'boolean',\r\n        cliName: 'enableRateLimiting',\r\n        description: 'Enables rate limiting.'\r\n      },\r\n      maxRequests: {\r\n        envLink: 'HIGHCHARTS_RATE_LIMIT_MAX',\r\n        value: 10,\r\n        type: 'number',\r\n        description: 'Max requests allowed in a one minute.'\r\n      },\r\n      window: {\r\n        envLink: 'HIGHCHARTS_RATE_LIMIT_WINDOW',\r\n        value: 1,\r\n        type: 'number',\r\n        description: 'The time window in minutes for rate limiting.'\r\n      },\r\n      delay: {\r\n        envLink: 'HIGHCHARTS_RATE_LIMIT_DELAY',\r\n        value: 0,\r\n        type: 'number',\r\n        description:\r\n          'The amount to delay each successive request before hitting the max.'\r\n      },\r\n      trustProxy: {\r\n        envLink: 'HIGHCHARTS_RATE_LIMIT_TRUST_PROXY',\r\n        value: false,\r\n        type: 'boolean',\r\n        description: 'Set this to true if behind a load balancer.'\r\n      },\r\n      skipKey: {\r\n        envLink: 'HIGHCHARTS_RATE_LIMIT_SKIP_KEY',\r\n        value: '',\r\n        type: 'number|string',\r\n        description:\r\n          'Allows bypassing the rate limiter and should be provided with skipToken argument.'\r\n      },\r\n      skipToken: {\r\n        envLink: 'HIGHCHARTS_RATE_LIMIT_SKIP_TOKEN',\r\n        value: '',\r\n        type: 'number|string',\r\n        description:\r\n          'Allows bypassing the rate limiter and should be provided with skipKey argument.'\r\n      }\r\n    }\r\n  },\r\n  pool: {\r\n    initialWorkers: {\r\n      envLink: 'HIGHCHARTS_POOL_MIN_WORKERS',\r\n      value: 4,\r\n      type: 'number',\r\n      description: 'The number of initial workers to spawn.'\r\n    },\r\n    maxWorkers: {\r\n      envLink: 'HIGHCHARTS_POOL_MAX_WORKERS',\r\n      value: 8,\r\n      type: 'number',\r\n      description: 'The number of max workers to spawn.'\r\n    },\r\n    workLimit: {\r\n      envLink: 'HIGHCHARTS_POOL_WORK_LIMIT',\r\n      value: 40,\r\n      type: 'number',\r\n      description:\r\n        'The pieces of work that can be performed before restarting process.'\r\n    },\r\n    queueSize: {\r\n      envLink: 'HIGHCHARTS_POOL_QUEUE_SIZE',\r\n      value: 5,\r\n      type: 'number',\r\n      description: 'The size of the request overflow queue.'\r\n    },\r\n    timeoutThreshold: {\r\n      envLink: 'HIGHCHARTS_POOL_TIMEOUT',\r\n      value: 5000,\r\n      type: 'number',\r\n      description: 'The number of milliseconds before timing out.'\r\n    },\r\n    acquireTimeout: {\r\n      envLink: 'HIGHCHARTS_POOL_ACQUIRE_TIMEOUT',\r\n      value: 5000,\r\n      type: 'number',\r\n      description:\r\n        'The number of milliseconds to wait for acquiring a resource.'\r\n    },\r\n    reaper: {\r\n      envLink: 'HIGHCHARTS_POOL_ENABLE_REAPER',\r\n      value: true,\r\n      type: 'boolean',\r\n      description:\r\n        'Whether or not to evict workers after a certain time period.'\r\n    },\r\n    benchmarking: {\r\n      envLink: 'HIGHCHARTS_POOL_BENCHMARKING',\r\n      value: false,\r\n      type: 'boolean',\r\n      description: 'Enable benchmarking.'\r\n    },\r\n    listenToProcessExits: {\r\n      envLink: 'HIGHCHARTS_POOL_LISTEN_TO_PROCESS_EXITS',\r\n      value: true,\r\n      type: 'boolean',\r\n      description:\r\n        'Set to false in order to skip attaching process.exit handlers.'\r\n    }\r\n  },\r\n  logging: {\r\n    level: {\r\n      envLink: 'HIGHCHARTS_LOG_LEVEL',\r\n      value: 4,\r\n      type: 'number',\r\n      cliName: 'logLevel',\r\n      description:\r\n        'The log level (0: silent, 1: error, 2: warning, 3: notice, 4: verbose).'\r\n    },\r\n    file: {\r\n      envLink: 'HIGHCHARTS_LOG_FILE',\r\n      value: 'highcharts-export-server.log',\r\n      type: 'string',\r\n      cliName: 'logFile',\r\n      description:\r\n        'A name of a log file. The --logDest also needs to be set to enable file logging.'\r\n    },\r\n    dest: {\r\n      envLink: 'HIGHCHARTS_LOG_DEST',\r\n      value: 'log/',\r\n      type: 'string',\r\n      cliName: 'logDest',\r\n      description: 'The path to store log files. Also enables file logging.'\r\n    }\r\n  },\r\n  ui: {\r\n    enable: {\r\n      envLink: 'HIGHCHARTS_UI_ENABLE',\r\n      value: false,\r\n      type: 'boolean',\r\n      cliName: 'enableUi',\r\n      description: 'Enables the UI for the export server.'\r\n    },\r\n    route: {\r\n      envLink: 'HIGHCHARTS_UI_ROUTE',\r\n      value: '/',\r\n      type: 'string',\r\n      cliName: 'uiRoute',\r\n      description: 'The route to attach the UI to.'\r\n    }\r\n  },\r\n  other: {\r\n    noLogo: {\r\n      envLink: 'HIGHCHARTS_NO_LOGO',\r\n      value: false,\r\n      type: 'boolean',\r\n      description:\r\n        'Skip printing the logo on a startup. Will be replaced by a simple text.'\r\n    }\r\n  },\r\n  payload: {}\r\n};\r\n\r\n// The config descriptions object for the prompts functionality. It contains\r\n// information like:\r\n// * Type of a prompt\r\n// * Name of an option\r\n// * Short description of a chosen option\r\n// * Initial value\r\nexport const promptsConfig = {\r\n  puppeteer: [\r\n    {\r\n      type: 'list',\r\n      name: 'args',\r\n      message: 'Puppeteer arguments',\r\n      initial: defaultConfig.puppeteer.args.value.join(','),\r\n      separator: ','\r\n    }\r\n  ],\r\n  highcharts: [\r\n    {\r\n      type: 'text',\r\n      name: 'version',\r\n      message: 'Highcharts version',\r\n      initial: defaultConfig.highcharts.version.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'cdnURL',\r\n      message: 'The url of CDN',\r\n      initial: defaultConfig.highcharts.cdnURL.value\r\n    },\r\n    {\r\n      type: 'multiselect',\r\n      name: 'modules',\r\n      message: 'Available modules',\r\n      instructions: 'Space: Select specific, A: Select all, Enter: Confirm.',\r\n      choices: defaultConfig.highcharts.modules.value\r\n    },\r\n    {\r\n      type: 'list',\r\n      name: 'scripts',\r\n      message: 'Custom scripts',\r\n      initial: defaultConfig.highcharts.scripts.value.join(','),\r\n      separator: ','\r\n    }\r\n  ],\r\n  export: [\r\n    {\r\n      type: 'select',\r\n      name: 'type',\r\n      message: 'The default type of a file to export to',\r\n      hint: `Default: ${defaultConfig.export.type.value}`,\r\n      initial: 0,\r\n      choices: ['png', 'jpeg', 'pdf', 'svg']\r\n    },\r\n    {\r\n      type: 'select',\r\n      name: 'constr',\r\n      message: 'The default constructor for Highcharts to use',\r\n      hint: `Default: ${defaultConfig.export.constr.value}`,\r\n      initial: 0,\r\n      choices: ['chart', 'stockChart', 'mapChart', 'ganttChart']\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'defaultHeight',\r\n      message: 'The default fallback height of the exported chart',\r\n      initial: defaultConfig.export.defaultHeight.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'defaultWidth',\r\n      message: 'The default fallback width of the exported chart',\r\n      initial: defaultConfig.export.defaultWidth.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'defaultScale',\r\n      message: 'The default fallback scale of the exported chart',\r\n      initial: defaultConfig.export.defaultScale.value,\r\n      min: 0.1,\r\n      max: 5\r\n    }\r\n  ],\r\n  customCode: [\r\n    {\r\n      type: 'toggle',\r\n      name: 'allowCodeExecution',\r\n      message: 'Allow to execute custom code',\r\n      initial: defaultConfig.customCode.allowCodeExecution.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'allowFileResources',\r\n      message: 'Allow file resources',\r\n      initial: defaultConfig.customCode.allowFileResources.value\r\n    }\r\n  ],\r\n  server: [\r\n    {\r\n      type: 'toggle',\r\n      name: 'enable',\r\n      message: 'Starts a server on 0.0.0.0',\r\n      initial: defaultConfig.server.enable.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'host',\r\n      message: 'A hostname of a server',\r\n      initial: defaultConfig.server.host.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'port',\r\n      message: 'A port of a server',\r\n      initial: defaultConfig.server.port.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'ssl.enable',\r\n      message: 'Enable SSL protocol',\r\n      initial: defaultConfig.server.ssl.enable.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'ssl.force',\r\n      message: 'Force to only serve over HTTPS',\r\n      initial: defaultConfig.server.ssl.force.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'ssl.port',\r\n      message: 'Port on which to run the SSL server',\r\n      initial: defaultConfig.server.ssl.port.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'ssl.certPath',\r\n      message: 'A path where to find the SSL certificate/key',\r\n      initial: defaultConfig.server.ssl.certPath.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'rateLimiting.enable',\r\n      message: 'Enable rate limiting',\r\n      initial: defaultConfig.server.rateLimiting.enable.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'rateLimiting.maxRequests',\r\n      message: 'Max requests allowed in a one minute',\r\n      initial: defaultConfig.server.rateLimiting.maxRequests.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'rateLimiting.window',\r\n      message: 'The time window in minutes for rate limiting',\r\n      initial: defaultConfig.server.rateLimiting.window.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'rateLimiting.delay',\r\n      message:\r\n        'The amount to delay each successive request before hitting the max',\r\n      initial: defaultConfig.server.rateLimiting.delay.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'rateLimiting.trustProxy',\r\n      message: 'Set this to true if behind a load balancer',\r\n      initial: defaultConfig.server.rateLimiting.trustProxy.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'rateLimiting.skipKey',\r\n      message:\r\n        'Allows bypassing the rate limiter and should be provided with skipToken argument',\r\n      initial: defaultConfig.server.rateLimiting.skipKey.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'rateLimiting.skipToken',\r\n      message:\r\n        'Allows bypassing the rate limiter and should be provided with skipKey argument',\r\n      initial: defaultConfig.server.rateLimiting.skipToken.value\r\n    }\r\n  ],\r\n  pool: [\r\n    {\r\n      type: 'number',\r\n      name: 'initialWorkers',\r\n      message: 'The number of initial workers to spawn',\r\n      initial: defaultConfig.pool.initialWorkers.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'maxWorkers',\r\n      message: 'The number of max workers to spawn',\r\n      initial: defaultConfig.pool.maxWorkers.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'workLimit',\r\n      message:\r\n        'The pieces of work that can be performed before restarting a puppeteer process',\r\n      initial: defaultConfig.pool.workLimit.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'queueSize',\r\n      message: 'The size of the request overflow queue',\r\n      initial: defaultConfig.pool.queueSize.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'timeoutThreshold',\r\n      message: 'The number of seconds before timing out',\r\n      initial: defaultConfig.pool.timeoutThreshold.value\r\n    },\r\n    {\r\n      type: 'number',\r\n      name: 'acquireTimeout',\r\n      message: 'The number of milliseconds to wait for acquiring a resource',\r\n      initial: defaultConfig.pool.acquireTimeout.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'reaper',\r\n      message: 'The reaper to remove hanging processes',\r\n      initial: defaultConfig.pool.reaper.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'benchmarking',\r\n      message: 'Set benchmarking',\r\n      initial: defaultConfig.pool.benchmarking.value\r\n    },\r\n    {\r\n      type: 'toggle',\r\n      name: 'listenToProcessExits',\r\n      message: 'Set to false in order to skip attaching process.exit handlers',\r\n      initial: defaultConfig.pool.listenToProcessExits.value\r\n    }\r\n  ],\r\n  logging: [\r\n    {\r\n      type: 'number',\r\n      name: 'level',\r\n      message:\r\n        'The log level (0: silent, 1: error, 2: warning, 3: notice, 4: verbose)',\r\n      initial: defaultConfig.logging.level.value,\r\n      round: 0,\r\n      min: 0,\r\n      max: 4\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'file',\r\n      message:\r\n        'A name of a log file. The --logDest also needs to be set to enable file logging',\r\n      initial: defaultConfig.logging.file.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'dest',\r\n      message: 'A path to log files. It enables file logging',\r\n      initial: defaultConfig.logging.dest.value\r\n    }\r\n  ],\r\n  ui: [\r\n    {\r\n      type: 'toggle',\r\n      name: 'enable',\r\n      message: 'Enable UI for the export server',\r\n      initial: defaultConfig.ui.enable.value\r\n    },\r\n    {\r\n      type: 'text',\r\n      name: 'route',\r\n      message: 'A route to attach the UI to',\r\n      initial: defaultConfig.ui.route.value\r\n    }\r\n  ],\r\n  other: [\r\n    {\r\n      type: 'toggle',\r\n      name: 'noLogo',\r\n      message:\r\n        'Skip printing the logo on a startup. Will be replaced by a simple text',\r\n      initial: defaultConfig.other.noLogo.value\r\n    }\r\n  ]\r\n};\r\n\r\n// Absolute props that, in case of merging recursively, need to be force merged\r\nexport const absoluteProps = [\r\n  'options',\r\n  'globalOptions',\r\n  'themeOptions',\r\n  'resources',\r\n  'payload'\r\n];\r\n\r\n// Argument nesting level of all export server options\r\nexport const nestedArgs = {};\r\n\r\n/**\r\n * Creates nested arguments chain for all options\r\n *\r\n * @param {object} obj - The object based on which the initial configuration be\r\n * made.\r\n * @param {string } propChain - Required for creating a string chain of\r\n * properties for nested arguments.\r\n */\r\nconst createNestedArgs = (obj, propChain = '') => {\r\n  Object.keys(obj).forEach((k) => {\r\n    if (!['puppeteer', 'highcharts'].includes(k)) {\r\n      const entry = obj[k];\r\n      if (typeof entry.value === 'undefined') {\r\n        // Go deeper in the nested arguments\r\n        createNestedArgs(entry, `${propChain}.${k}`);\r\n      } else {\r\n        // Create the chain of nested arguments\r\n        nestedArgs[entry.cliName || k] = `${propChain}.${k}`.substring(1);\r\n      }\r\n    }\r\n  });\r\n};\r\n\r\ncreateNestedArgs(defaultConfig);\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { appendFile, existsSync, mkdirSync } from 'fs';\r\n\r\nimport { defaultConfig } from './schemas/config.js';\r\n\r\n// The default logging config\r\nlet logging = {\r\n  // Flags for logging status\r\n  toConsole: true,\r\n  toFile: false,\r\n  pathCreated: false,\r\n  // Log levels\r\n  levelsDesc: [\r\n    {\r\n      title: 'error',\r\n      color: 'red'\r\n    },\r\n    {\r\n      title: 'warning',\r\n      color: 'yellow'\r\n    },\r\n    {\r\n      title: 'notice',\r\n      color: 'blue'\r\n    },\r\n    {\r\n      title: 'verbose',\r\n      color: 'gray'\r\n    }\r\n  ],\r\n  // Log listeners\r\n  listeners: []\r\n};\r\n\r\n// Gather init logging options\r\nfor (const [key, option] of Object.entries(defaultConfig.logging)) {\r\n  logging[key] = option.value;\r\n}\r\n\r\n/**\r\n * Logs a message. Accepts a variable amount of arguments. Arguments after\r\n * `level` will be passed directly to console.log, and/or will be joined\r\n * and appended to the log file.\r\n *\r\n * @param {any} args - An array of arguments where the first is the log level\r\n * and the rest are strings to build a message with.\r\n */\r\nexport const log = (...args) => {\r\n  const [newLevel, ...texts] = args;\r\n\r\n  // Current logging options\r\n  const { level, levelsDesc } = logging;\r\n\r\n  // Check if log level is within a correct range\r\n  if (newLevel === 0 || newLevel > level || level > levelsDesc.length) {\r\n    return;\r\n  }\r\n\r\n  // Get rid of the GMT text information\r\n  const newDate = new Date().toString().split('(')[0].trim();\r\n\r\n  // Create a message's prefix\r\n  const prefix = `${newDate} [${levelsDesc[newLevel - 1].title}] -`;\r\n\r\n  // Call available log listeners\r\n  logging.listeners.forEach((fn) => {\r\n    fn(prefix, texts.join(' '));\r\n  });\r\n\r\n  // Log to file\r\n  if (logging.toFile) {\r\n    if (!logging.pathCreated) {\r\n      // Create if does not exist\r\n      !existsSync(logging.dest) && mkdirSync(logging.dest);\r\n\r\n      // We now assume the path is available, e.g. it's the responsibility\r\n      // of the user to create the path with the correct access rights.\r\n      logging.pathCreated = true;\r\n    }\r\n\r\n    // Add the content to a file\r\n    appendFile(\r\n      `${logging.dest}${logging.file}`,\r\n      [prefix].concat(texts).join(' ') + '\\n',\r\n      (error) => {\r\n        if (error) {\r\n          console.log(`[logger] Unable to write to log file: ${error}`);\r\n          logging.toFile = false;\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  // Log to console\r\n  if (logging.toConsole) {\r\n    console.log.apply(\r\n      undefined,\r\n      [prefix.toString()[logging.levelsDesc[newLevel - 1].color]].concat(texts)\r\n    );\r\n  }\r\n};\r\n\r\n/**\r\n * Sets the file logging configuration.\r\n *\r\n * @param {string} logDest - A path to log to.\r\n * @param {string} logFile - The name of the log file.\r\n */\r\nexport const enableFileLogging = (logDest, logFile) => {\r\n  // Update logging options\r\n  logging = {\r\n    ...logging,\r\n    dest: logDest || logging.dest,\r\n    file: logFile || logging.file,\r\n    toFile: true\r\n  };\r\n\r\n  if (logging.dest.length === 0) {\r\n    return log(1, '[logger] File logging init: no path supplied.');\r\n  }\r\n\r\n  if (!logging.dest.endsWith('/')) {\r\n    logging.dest += '/';\r\n  }\r\n};\r\n\r\n/**\r\n * Adds a log listener.\r\n *\r\n * @param {function} fn - The function to call when getting a log event.\r\n */\r\nexport const listen = (fn) => {\r\n  logging.listeners.push(fn);\r\n};\r\n\r\n/**\r\n * Sets the current log level. Log levels are:\r\n * - 0 = no logging\r\n * - 1 = error\r\n * - 2 = warning\r\n * - 3 = notice\r\n * - 4 = verbose\r\n *\r\n * @param {number} newLevel - The new log level (0 - 4).\r\n */\r\nexport const setLogLevel = (newLevel) => {\r\n  if (newLevel >= 0 && newLevel <= logging.levelsDesc.length) {\r\n    logging.level = newLevel;\r\n  }\r\n};\r\n\r\n/**\r\n * Enables or disables logging to the stdout.\r\n *\r\n * @param {boolean} enabled - Whether log to console or not.\r\n */\r\nexport const toggleSTDOut = (enabled) => {\r\n  logging.toConsole = enabled;\r\n};\r\n\r\nexport default {\r\n  log,\r\n  enableFileLogging,\r\n  listen,\r\n  setLogLevel,\r\n  toggleSTDOut\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { readFileSync } from 'fs';\r\nimport { fileURLToPath } from 'url';\r\n\r\nimport { defaultConfig } from '../lib/schemas/config.js';\r\nimport { log } from './logger.js';\r\n\r\nconst MAX_BACKOFF_ATTEMPTS = 6;\r\n\r\nexport const __dirname = fileURLToPath(new URL('../.', import.meta.url));\r\n\r\n/**\r\n * Clears text from whitespaces with a regex rule.\r\n *\r\n * @param {string} rule - The rule for clearing a string, default to /\\s\\s+/g.\r\n * @return {string} - Cleared text.\r\n */\r\nexport const clearText = (text, rule = /\\s\\s+/g, replacer = ' ') =>\r\n  text.replaceAll(rule, replacer).trim();\r\n\r\n/**\r\n * Delays calling the function by time calculated based on the backoff\r\n * algorithm.\r\n *\r\n * @param {function} fn - A function to try to call with the backoff algorithm\r\n * on.\r\n * @param {number} attempt - The number of an attempt, where the first one is 0.\r\n */\r\nexport const expBackoff = async (fn, attempt = 0, ...args) => {\r\n  try {\r\n    // Try to call the function\r\n    return await fn(...args);\r\n  } catch (error) {\r\n    // Calculate delay in ms\r\n    const delayInMs = 2 ** attempt * 1000;\r\n\r\n    // If the attempt exceeds the maximum attempts of reapeat, throw an error\r\n    if (++attempt >= MAX_BACKOFF_ATTEMPTS) {\r\n      throw error;\r\n    }\r\n\r\n    // Wait given amount of time\r\n    await new Promise((response) => setTimeout(response, delayInMs));\r\n    log(\r\n      3,\r\n      `[pool] Waited ${delayInMs}ms until next call for the resource id: ${args[0]}.`\r\n    );\r\n\r\n    // Try again\r\n    return expBackoff(fn, attempt, ...args);\r\n  }\r\n};\r\n\r\n/**\r\n * Fixes to supported type format if MIME.\r\n *\r\n * @param {string} type - Type to be corrected.\r\n * @param {string} outfile - Name of the outfile.\r\n */\r\nexport const fixType = (type, outfile) => {\r\n  // MIME types\r\n  const mimeTypes = {\r\n    'image/png': 'png',\r\n    'image/jpeg': 'jpeg',\r\n    'application/pdf': 'pdf',\r\n    'image/svg+xml': 'svg'\r\n  };\r\n\r\n  // Formats\r\n  const formats = ['png', 'jpeg', 'pdf', 'svg'];\r\n\r\n  // Check if type and outfile's extensions are the same\r\n  if (outfile) {\r\n    const outType = outfile.split('.').pop();\r\n\r\n    // Check if extension has a correct type\r\n    if (formats.includes(outType) && type !== outType) {\r\n      type = outType;\r\n    }\r\n  }\r\n\r\n  // Return a correct type\r\n  return mimeTypes[type] || formats.find((t) => t === type) || 'png';\r\n};\r\n\r\n/**\r\n * Handles the provided resources.\r\n *\r\n * @param {string} resources - The stringified resources.\r\n * @param {string} allowFileResources - Decide if resources from file are\r\n * allowed.\r\n */\r\nexport const handleResources = (resources = false, allowFileResources) => {\r\n  const allowedProps = ['js', 'css', 'files'];\r\n\r\n  let handledResources = resources;\r\n  let correctResources = false;\r\n\r\n  // Try to load resources from a file\r\n  if (allowFileResources && resources.endsWith('.json')) {\r\n    try {\r\n      if (!resources) {\r\n        handledResources = isCorrectJSON(\r\n          readFileSync('resources.json', 'utf8')\r\n        );\r\n      } else if (resources && resources.endsWith('.json')) {\r\n        handledResources = isCorrectJSON(readFileSync(resources, 'utf8'));\r\n      } else {\r\n        handledResources = isCorrectJSON(resources);\r\n        if (handledResources === true) {\r\n          handledResources = isCorrectJSON(\r\n            readFileSync('resources.json', 'utf8')\r\n          );\r\n        }\r\n      }\r\n    } catch (notice) {\r\n      return log(3, `[cli] No resources found.`);\r\n    }\r\n  } else {\r\n    // Try to get JSON\r\n    handledResources = isCorrectJSON(resources);\r\n\r\n    // Get rid of the files section\r\n    if (!allowFileResources) {\r\n      delete handledResources.files;\r\n    }\r\n  }\r\n\r\n  // Filter from unnecessary properties\r\n  for (const propName in handledResources) {\r\n    if (!allowedProps.includes(propName)) {\r\n      delete handledResources[propName];\r\n    } else if (!correctResources) {\r\n      correctResources = true;\r\n    }\r\n  }\r\n\r\n  // Check if at least one of allowed properties is present\r\n  if (!correctResources) {\r\n    return log(3, `[cli] No resources found.`);\r\n  }\r\n\r\n  // Handle files section\r\n  if (handledResources.files) {\r\n    handledResources.files = handledResources.files.map((item) => item.trim());\r\n    if (!handledResources.files || handledResources.files.length <= 0) {\r\n      delete handledResources.files;\r\n    }\r\n  }\r\n\r\n  // Return resources\r\n  return handledResources;\r\n};\r\n\r\n/**\r\n * Checks if provided data is or can be a correct JSON.\r\n *\r\n * @param {any} data - Data to be checked.\r\n * @param {boolean} toString - If true, return stringified representation.\r\n */\r\nexport function isCorrectJSON(data, toString) {\r\n  try {\r\n    // Get the string representation if not already before parsing\r\n    const parsedData = JSON.parse(\r\n      typeof data !== 'string' ? JSON.stringify(data) : data\r\n    );\r\n\r\n    // Return a stringified representation of a JSON if required\r\n    if (typeof parsedData !== 'string' && toString) {\r\n      return JSON.stringify(parsedData);\r\n    }\r\n\r\n    // Return a JSON\r\n    return parsedData;\r\n  } catch (error) {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Checks if item is an object.\r\n *\r\n * @param {any} item - Item to be checked.\r\n */\r\nexport const isObject = (item) =>\r\n  typeof item === 'object' && !Array.isArray(item) && item !== null;\r\n\r\n/**\r\n * Checks if string contains private range urls.\r\n *\r\n * @export utils\r\n * @param item {string} item to be checked\r\n */\r\nexport const isPrivateRangeUrlFound = (item) => {\r\n  return [\r\n    'localhost',\r\n    '(10).(.*).(.*).(.*)',\r\n    '(127).(.*).(.*).(.*)',\r\n    '(172).(1[6-9]|2[0-9]|3[0-1]).(.*).(.*)',\r\n    '(192).(168).(.*).(.*)'\r\n  ].some((ipRegEx) =>\r\n    item.match(`xlink:href=\"(?:(http://|https://))?${ipRegEx}`)\r\n  );\r\n};\r\n\r\n/**\r\n * Creates and returns a deep copy of the given object.\r\n *\r\n * @param {object} object - Object to copy.\r\n * @return {object} - Deep copy of the object.\r\n */\r\nexport const deepCopy = (obj) => {\r\n  if (obj === null || typeof obj !== 'object') {\r\n    return obj;\r\n  }\r\n\r\n  const copy = Array.isArray(obj) ? [] : {};\r\n\r\n  for (const key in obj) {\r\n    if (Object.prototype.hasOwnProperty.call(obj, key)) {\r\n      copy[key] = deepCopy(obj[key]);\r\n    }\r\n  }\r\n\r\n  return copy;\r\n};\r\n\r\n/**\r\n * Stringifies object with options. Possible to preserve functions with\r\n * allowFunctions flag.\r\n *\r\n * @param {object} options - Options to stringify.\r\n * @param {boolean} allowFunctions - Flag for keeping functions.\r\n */\r\nexport const optionsStringify = (options, allowFunctions) => {\r\n  const replacerCallback = (name, value) => {\r\n    if (typeof value === 'string') {\r\n      value = value.trim();\r\n\r\n      // If allowFunctions is set to true, preserve functions\r\n      if (\r\n        (value.startsWith('function(') || value.startsWith('function (')) &&\r\n        value.endsWith('}')\r\n      ) {\r\n        value = allowFunctions\r\n          ? `EXP_FUN${(value + '').replaceAll(/\\n|\\t|\\r/g, ' ')}EXP_FUN`\r\n          : undefined;\r\n      }\r\n    }\r\n\r\n    return typeof value === 'function'\r\n      ? `EXP_FUN${(value + '').replaceAll(/\\n|\\t|\\r/g, ' ')}EXP_FUN`\r\n      : value;\r\n  };\r\n\r\n  // Stringify options and if required, replace special functions marks\r\n  return JSON.stringify(options, replacerCallback).replaceAll(\r\n    /\"EXP_FUN|EXP_FUN\"/g,\r\n    ''\r\n  );\r\n};\r\n\r\n/**\r\n * Prints the export server logo.\r\n *\r\n * @param {boolean} noLogo - Whether to display logo or text.\r\n */\r\nexport const printLogo = (noLogo) => {\r\n  // Get package version either from env or from package.json\r\n  const packageVersion =\r\n    process.env.npm_package_version ||\r\n    JSON.parse(readFileSync(new URL('../package.json', import.meta.url)))\r\n      .version;\r\n\r\n  // Print text only\r\n  if (noLogo) {\r\n    console.log(`Starting highcharts export server v${packageVersion}...`);\r\n    return;\r\n  }\r\n\r\n  // Print the logo\r\n  console.log(\r\n    readFileSync(__dirname + '/msg/startup.msg').toString().bold.yellow,\r\n    `v${packageVersion}`\r\n  );\r\n};\r\n\r\n/**\r\n * Prints the CLI usage. If required, it can list properties recursively\r\n */\r\nexport function printUsage() {\r\n  const pad = 48;\r\n  const readme = 'https://github.com/highcharts/node-export-server#readme';\r\n\r\n  // Display readme information\r\n  console.log(\r\n    'Usage of CLI arguments:'.bold,\r\n    '\\n------',\r\n    `\\nFor more detailed information visit readme at: ${readme.bold.yellow}.`\r\n  );\r\n\r\n  const cycleCategories = (categories) => {\r\n    for (const [name, option] of Object.entries(categories)) {\r\n      // If category has more levels, go further\r\n      if (!Object.prototype.hasOwnProperty.call(option, 'value')) {\r\n        cycleCategories(option);\r\n      } else {\r\n        let descName = `  --${option.cliName || name} ${\r\n          ('<' + option.type + '>').green\r\n        } `;\r\n        if (descName.length < pad) {\r\n          for (let i = descName.length; i < pad; i++) {\r\n            descName += '.';\r\n          }\r\n        }\r\n\r\n        // Display correctly aligned messages\r\n        console.log(\r\n          descName,\r\n          option.description,\r\n          `[Default: ${option.value.toString().bold}]`.blue\r\n        );\r\n      }\r\n    }\r\n  };\r\n\r\n  // Cycle through options of each categories and display the usage info\r\n  Object.keys(defaultConfig).forEach((category) => {\r\n    // Only puppeteer and highcharts categories cannot be configured through CLI\r\n    if (!['puppeteer', 'highcharts'].includes(category)) {\r\n      console.log(`\\n${category.toUpperCase()}`.red);\r\n      cycleCategories(defaultConfig[category]);\r\n    }\r\n  });\r\n  console.log('\\n');\r\n}\r\n\r\n/**\r\n * Rounds number to passed precision.\r\n *\r\n * @param {number} value - Number to round.\r\n * @param {number} precision - A precision of rounding.\r\n */\r\nexport const roundNumber = (value, precision = 1) => {\r\n  const multiplier = Math.pow(10, precision || 0);\r\n  return Math.round(+value * multiplier) / multiplier;\r\n};\r\n\r\n/**\r\n * Casts the item to boolean.\r\n *\r\n * @param {any} item - Item to be cast.\r\n */\r\nexport const toBoolean = (item) =>\r\n  ['false', 'undefined', 'null', 'NaN', '0', ''].includes(item)\r\n    ? false\r\n    : !!item;\r\n\r\n/**\r\n * If necessary, places a custom code inside a function.\r\n *\r\n * @param {any} customCode - The customCode.\r\n */\r\nexport const wrapAround = (customCode, allowFileResources) => {\r\n  if (customCode && typeof customCode === 'string') {\r\n    customCode = customCode.trim();\r\n\r\n    if (customCode.endsWith('.js')) {\r\n      return allowFileResources\r\n        ? wrapAround(readFileSync(customCode, 'utf8'))\r\n        : false;\r\n    } else if (\r\n      customCode.startsWith('function()') ||\r\n      customCode.startsWith('function ()') ||\r\n      customCode.startsWith('()=>') ||\r\n      customCode.startsWith('() =>')\r\n    ) {\r\n      return `(${customCode})()`;\r\n    }\r\n    return customCode.replace(/;$/, '');\r\n  }\r\n};\r\n\r\n/**\r\n * Utility to measure time.\r\n */\r\nexport const measureTime = () => {\r\n  const start = process.hrtime.bigint();\r\n  return () => Number(process.hrtime.bigint() - start) / 1000000;\r\n};\r\n\r\nexport default {\r\n  __dirname,\r\n  clearText,\r\n  expBackoff,\r\n  fixType,\r\n  handleResources,\r\n  isCorrectJSON,\r\n  isObject,\r\n  isPrivateRangeUrlFound,\r\n  optionsStringify,\r\n  printLogo,\r\n  printUsage,\r\n  roundNumber,\r\n  toBoolean,\r\n  wrapAround,\r\n  measureTime\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport rateLimit from 'express-rate-limit';\r\n\r\nimport { clearText } from '../utils.js';\r\nimport { log } from '../logger.js';\r\n\r\n/**\r\n * Enables rate limiting for a given app.\r\n *\r\n * @param {object} app - The express app.\r\n * @param {object} limitConfig - The options for the rate limiting.\r\n */\r\nexport default (app, limitConfig) => {\r\n  const msg =\r\n    'Too many requests, you have been rate limited. Please try again later.';\r\n\r\n  // Options for the rate limiter\r\n  const rateOptions = {\r\n    max: limitConfig.maxRequests || 30,\r\n    window: limitConfig.window || 1,\r\n    delay: limitConfig.delay || 0,\r\n    trustProxy: limitConfig.trustProxy || false,\r\n    skipKey: limitConfig.skipKey || false,\r\n    skipToken: limitConfig.skipToken || false\r\n  };\r\n\r\n  // Set if behind a proxy\r\n  if (rateOptions.trustProxy) {\r\n    app.enable('trust proxy');\r\n  }\r\n\r\n  // Create a limiter\r\n  const limiter = rateLimit({\r\n    windowMs: rateOptions.window * 60 * 1000,\r\n    // Limit each IP to 100 requests per windowMs\r\n    max: rateOptions.max,\r\n    // Disable delaying, full speed until the max limit is reached\r\n    delayMs: rateOptions.delay,\r\n    handler: (request, response) => {\r\n      response.format({\r\n        json: () => {\r\n          response.status(429).send({ message: msg });\r\n        },\r\n        default: () => {\r\n          response.status(429).send(msg);\r\n        }\r\n      });\r\n    },\r\n    skip: (request) => {\r\n      // Allow bypassing the limiter if a valid key/token has been sent\r\n      if (\r\n        rateOptions.skipKey !== false &&\r\n        rateOptions.skipToken !== false &&\r\n        request.query.key === rateOptions.skipKey &&\r\n        request.query.access_token === rateOptions.skipToken\r\n      ) {\r\n        log(4, '[rate-limiting] Skipping rate limiter.');\r\n        return true;\r\n      }\r\n      return false;\r\n    }\r\n  });\r\n\r\n  // Use a limiter as a middleware\r\n  app.use(limiter);\r\n\r\n  log(\r\n    3,\r\n    clearText(\r\n      `[rate-limiting] Enabled rate limiting: ${rateOptions.max} requests\r\n      per ${rateOptions.window} minute per IP, trusting proxy:\r\n      ${rateOptions.trustProxy}.`\r\n    )\r\n  );\r\n};\r\n","/**\r\n * This module exports two functions: fetch (for GET requests) and post (for POST requests).\r\n */\r\n\r\nimport http from 'http';\r\nimport https from 'https';\r\n\r\n/**\r\n * Determines the protocol of the given URL (either `http` or `https`).\r\n *\r\n * @function\r\n * @param {string} url - The URL whose protocol needs to be determined.\r\n * @returns {Object} Returns the `https` module if the URL starts with 'https',\r\n * otherwise returns the `http` module.\r\n * @private\r\n *\r\n * @example\r\n *\r\n * const protocol = getProtocol('https://example.com');\r\n * console.log(protocol); // Outputs the 'https' module\r\n */\r\nconst getProtocol = (url) => {\r\n  return url.startsWith('https') ? https : http;\r\n};\r\n\r\n/**\r\n * Sends a GET request to the specified URL with optional request options.\r\n *\r\n * @function\r\n * @async\r\n * @param {string} url - The URL to fetch.\r\n * @param {Object} [requestOptions={}] - Optional request options and headers.\r\n * @returns {Promise<Object>} Returns a promise that resolves with the response object.\r\n * The response object contains a `.text` property with the raw response data.\r\n * @throws {Error} Throws an error if the request fails or if no data is fetched from the URL.\r\n *\r\n * @example\r\n *\r\n * async function getData() {\r\n *   try {\r\n *     const response = await fetch('https://api.example.com/data');\r\n *     console.log(response.text);\r\n *   } catch (error) {\r\n *     console.error('Error fetching data:', error);\r\n *   }\r\n * }\r\n *\r\n * getData();\r\n */\r\nasync function fetch(url, requestOptions = {}) {\r\n  return new Promise((resolve, reject) => {\r\n    const protocol = getProtocol(url);\r\n\r\n    protocol\r\n      .get(url, requestOptions, (res) => {\r\n        let data = '';\r\n\r\n        // A chunk of data has been received.\r\n        res.on('data', (chunk) => {\r\n          data += chunk;\r\n        });\r\n\r\n        // The whole response has been received.\r\n        res.on('end', () => {\r\n          if (!data) {\r\n            reject('Nothing was fetched from the URL.');\r\n          }\r\n\r\n          res.text = data;\r\n          resolve(res);\r\n        });\r\n      })\r\n      .on('error', (error) => {\r\n        reject(error);\r\n      });\r\n  });\r\n}\r\n\r\n/**\r\n * Sends a POST request to the specified URL with the given body and request options.\r\n *\r\n * @function\r\n * @async\r\n * @param {string} url - The URL to which the request should be sent.\r\n * @param {Object} [body={}] - The data to be sent as the request body, in JSON format.\r\n * @param {Object} [requestOptions={}] - Optional request options and headers.\r\n * @returns {Promise<Object>} - Returns a promise that resolves with the parsed JSON response.\r\n * @throws {Error} Throws an error if the request fails or if the response cannot be parsed.\r\n *\r\n * @example\r\n *\r\n * async function sendData() {\r\n *   const dataToSend = {\r\n *     key1: 'value1',\r\n *     key2: 'value2',\r\n *   };\r\n *   try {\r\n *     const response = await post('https://api.example.com/data', dataToSend);\r\n *     console.log(response);\r\n *   } catch (error) {\r\n *     console.error('Error sending data:', error);\r\n *   }\r\n * }\r\n *\r\n * sendData();\r\n */\r\nasync function post(url, body = {}, requestOptions = {}) {\r\n  return new Promise((resolve, reject) => {\r\n    const protocol = getProtocol(url);\r\n    const data = JSON.stringify(body);\r\n\r\n    // Set default headers and merge with requestOptions\r\n    const options = Object.assign(\r\n      {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Content-Length': data.length\r\n        }\r\n      },\r\n      requestOptions\r\n    );\r\n\r\n    const req = protocol\r\n      .request(url, options, (res) => {\r\n        let responseData = '';\r\n\r\n        // A chunk of data has been received.\r\n        res.on('data', (chunk) => {\r\n          responseData += chunk;\r\n        });\r\n\r\n        // The whole response has been received.\r\n        res.on('end', () => {\r\n          try {\r\n            res.text = responseData;\r\n            resolve(res);\r\n          } catch (error) {\r\n            reject(error);\r\n          }\r\n        });\r\n      })\r\n      .on('error', (error) => {\r\n        reject(error);\r\n      });\r\n\r\n    // Write the request body and end the request.\r\n    req.write(data);\r\n    req.end();\r\n  });\r\n}\r\n\r\nexport default fetch;\r\nexport { fetch, post };\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\n// The cache manager manages the Highcharts library and its dependencies.\r\n// The cache itself is stored in .cache, and is checked by the config system\r\n// before starting the service\r\n\r\nimport { existsSync, mkdirSync, readFileSync, writeFileSync } from 'fs';\r\nimport { join } from 'path';\r\n\r\nimport dotenv from 'dotenv';\r\nimport HttpsProxyAgent from 'https-proxy-agent';\r\nimport { fetch } from './fetch.js';\r\n\r\nimport { log } from './logger.js';\r\nimport { __dirname } from '../lib/utils.js';\r\n\r\ndotenv.config();\r\n\r\nconst cachePath = join(__dirname, '.cache');\r\n\r\nconst cache = {\r\n  cdnURL: 'https://code.highcharts.com/',\r\n  activeManifest: {},\r\n  sources: '',\r\n  hcVersion: ''\r\n};\r\n\r\n// TODO: The config should be accesssible globally so we don't have to do this sort of thing..\r\nlet appliedConfig = false;\r\n\r\n/**\r\n * Extracts the Highcharts version from the cache\r\n */\r\nconst extractVersion = () =>\r\n  (cache.hcVersion = cache.sources\r\n    .substr(0, cache.sources.indexOf('*/'))\r\n    .replace('/*', '')\r\n    .replace('*/', '')\r\n    .replace(/\\n/g, '')\r\n    .trim());\r\n\r\n/**\r\n * Saves the Highcharts part of a config to a manifest file in the cache\r\n *\r\n * @param {object} config - Highcarts related configuration object.\r\n * @param {object} fetchedModules - An object that contains mapped names of\r\n * fetched Highcharts modules to use.\r\n */\r\nconst saveConfigToManifest = async (config, fetchedModules) => {\r\n  const newManifest = {\r\n    version: config.version,\r\n    modules: fetchedModules || {}\r\n  };\r\n\r\n  // Update cache object with the current modules\r\n  cache.activeManifest = newManifest;\r\n\r\n  log(4, '[cache] writing new manifest');\r\n\r\n  try {\r\n    writeFileSync(\r\n      join(cachePath, 'manifest.json'),\r\n      JSON.stringify(newManifest),\r\n      'utf8'\r\n    );\r\n  } catch (error) {\r\n    log(1, `[cache] Error writing cache manifest: ${error}.`);\r\n  }\r\n};\r\n\r\n/**\r\n * Fetches a single script.\r\n *\r\n * @param {string} script - A path to script to get.\r\n * @param {object} proxyAgent - The proxy agent to use for a request.\r\n */\r\nconst fetchScript = async (script, proxyAgent) => {\r\n  try {\r\n    // Get rid of the .js from the custom strings\r\n    if (script.endsWith('.js')) {\r\n      script = script.substring(0, script.length - 3);\r\n    }\r\n\r\n    log(4, `[cache] Fetching script - ${script}.js`);\r\n\r\n    // If exists, add proxy agent to request options\r\n    const requestOptions = proxyAgent\r\n      ? {\r\n          agent: proxyAgent,\r\n          timeout: +process.env['PROXY_SERVER_TIMEOUT'] || 5000\r\n        }\r\n      : {};\r\n\r\n    // Fetch the script\r\n    const response = await fetch(`${script}.js`, requestOptions);\r\n\r\n    // If OK, return its text representation\r\n    if (response.statusCode === 200) {\r\n      return response.text;\r\n    }\r\n\r\n    throw `${response.statusCode}`;\r\n  } catch (error) {\r\n    log(1, `[cache] Error fetching script ${script}.js: ${error}.`);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Updates the Highcharts cache.\r\n *\r\n * @param {object} config - Highcarts related configuration object.\r\n * @param {string} sourcePath - A path to the file where save updated sources.\r\n * @return {object} An object that contains mapped names of fetched Highcharts\r\n * modules to use.\r\n */\r\nconst updateCache = async (config, sourcePath) => {\r\n  const { coreScripts, modules, indicators, scripts: customScripts } = config;\r\n  const hcVersion =\r\n    config.version === 'latest' || !config.version ? '' : `${config.version}/`;\r\n\r\n  log(3, '[cache] Updating cache to Highcharts ', hcVersion);\r\n\r\n  // Gather all scripts to fetch\r\n  const allScripts = [\r\n    ...coreScripts.map((c) => `${hcVersion}${c}`),\r\n    ...modules.map((m) =>\r\n      m === 'map' ? `maps/${hcVersion}modules/${m}` : `${hcVersion}modules/${m}`\r\n    ),\r\n    ...indicators.map((i) => `stock/${hcVersion}indicators/${i}`)\r\n  ];\r\n\r\n  // Configure proxy if exists\r\n  let proxyAgent;\r\n  const proxyHost = process.env['PROXY_SERVER_HOST'];\r\n  const proxyPort = process.env['PROXY_SERVER_PORT'];\r\n\r\n  if (proxyHost && proxyPort) {\r\n    proxyAgent = new HttpsProxyAgent({\r\n      host: proxyHost,\r\n      port: +proxyPort\r\n    });\r\n  }\r\n\r\n  const fetchedModules = {};\r\n  try {\r\n    cache.sources = // TODO: convert to for loop\r\n      (\r\n        await Promise.all([\r\n          ...allScripts.map(async (script) => {\r\n            const text = await fetchScript(\r\n              `${config.cdnURL || cache.cdnURL}${script}`,\r\n              proxyAgent\r\n            );\r\n\r\n            // If fetched correctly, set it\r\n            if (typeof text === 'string') {\r\n              fetchedModules[\r\n                script.replace(\r\n                  /(.*)\\/|(.*)modules\\/|stock\\/(.*)indicators\\/|maps\\/(.*)modules\\//gi,\r\n                  ''\r\n                )\r\n              ] = 1;\r\n            }\r\n\r\n            return text;\r\n          }),\r\n          ...customScripts.map((script) => fetchScript(script, proxyAgent))\r\n        ])\r\n      ).join(';\\n');\r\n    extractVersion();\r\n\r\n    // Save the fetched modules into caches' source JSON\r\n    writeFileSync(sourcePath, cache.sources);\r\n    return fetchedModules;\r\n  } catch (error) {\r\n    log(1, '[cache] Unable to update local Highcharts cache.');\r\n  }\r\n};\r\n\r\nexport const updateVersion = async (newVersion) =>\r\n  appliedConfig\r\n    ? await checkCache(\r\n        Object.assign(appliedConfig, {\r\n          version: newVersion\r\n        })\r\n      )\r\n    : false;\r\n\r\n/**\r\n * Fetches any missing Highcharts and dependencies\r\n *\r\n * @param {object} config - Highcarts related configuration object.\r\n */\r\nexport const checkCache = async (config) => {\r\n  let fetchedModules;\r\n  // Prepare paths to manifest and sources from the .cache folder\r\n  const manifestPath = join(cachePath, 'manifest.json');\r\n  const sourcePath = join(cachePath, 'sources.js');\r\n\r\n  // TODO: deal with trying to switch to the running version\r\n  // const activeVersion = appliedConfig ? appliedConfig.version : false;\r\n\r\n  appliedConfig = config;\r\n\r\n  // Create the .cache destination if it doesn't exist already\r\n  !existsSync(cachePath) && mkdirSync(cachePath);\r\n\r\n  // Load the .cache manifest\r\n  if (existsSync(manifestPath)) {\r\n    let requestUpdate = false;\r\n\r\n    // Read the manifest JSON\r\n    const manifest = JSON.parse(readFileSync(manifestPath));\r\n\r\n    // Check if the modules is an array, if so, we rewrite it to a map to make\r\n    // it easier to resolve modules.\r\n    if (manifest.modules && Array.isArray(manifest.modules)) {\r\n      const moduleMap = {};\r\n      manifest.modules.forEach((m) => (moduleMap[m] = 1));\r\n      manifest.modules = moduleMap;\r\n    }\r\n\r\n    const { modules, coreScripts, indicators } = config;\r\n    const numberOfModules =\r\n      modules.length + coreScripts.length + indicators.length;\r\n\r\n    // Compare the loaded config with the contents in .cache.\r\n    // If there are changes, fetch requested modules and products,\r\n    // and bake them into a giant blob. Save the blob.\r\n    if (manifest.version !== config.version) {\r\n      log(3, '[cache] Highcharts version mismatch in cache, need to re-fetch.');\r\n      requestUpdate = true;\r\n    } else if (Object.keys(manifest.modules || {}).length !== numberOfModules) {\r\n      log(\r\n        3,\r\n        '[cache] Cache and requested modules does not match, need to re-fetch.'\r\n      );\r\n      requestUpdate = true;\r\n    } else {\r\n      // Check each module, if anything is missing refetch everything\r\n      requestUpdate = (config.modules || []).some((moduleName) => {\r\n        if (!manifest.modules[moduleName]) {\r\n          log(\r\n            3,\r\n            `[cache] The ${moduleName} missing in cache, need to re-fetch.`\r\n          );\r\n          return true;\r\n        }\r\n      });\r\n    }\r\n\r\n    if (requestUpdate) {\r\n      fetchedModules = await updateCache(config, sourcePath);\r\n    } else {\r\n      log(3, '[cache] Dependency cache is up to date, proceeding.');\r\n\r\n      // Load the sources\r\n      cache.sources = readFileSync(sourcePath, 'utf8');\r\n\r\n      // Get current modules map\r\n      fetchedModules = manifest.modules;\r\n      extractVersion();\r\n    }\r\n  } else {\r\n    // So we don't have one yet, which means we need to fetch everything\r\n    log(3, '[cache] Fetching and caching Highcharts dependencies.');\r\n    fetchedModules = await updateCache(config, sourcePath);\r\n  }\r\n\r\n  // Finally, save the new manifest, which is basically our current config\r\n  // in a slightly different format\r\n  await saveConfigToManifest(config, fetchedModules);\r\n};\r\n\r\nexport default {\r\n  checkCache,\r\n  updateVersion,\r\n  getCache: () => cache,\r\n  highcharts: () => cache.sources,\r\n  version: () => cache.hcVersion\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport puppeteer from 'puppeteer';\r\nimport fs from 'fs';\r\nimport * as url from 'url';\r\nimport { log } from './logger.js';\r\nimport path from 'node:path';\r\n\r\n// Workaround for https://bugs.chromium.org/p/chromium/issues/detail?id=1463328\r\n// Not ideal - leaves trash in the FS\r\nimport { randomBytes } from 'node:crypto';\r\nconst RANDOM_PID = randomBytes(64).toString('base64url');\r\nconst PUPPETEER_DIR = path.join('tmp', `puppeteer-${RANDOM_PID}`);\r\nconst DATA_DIR = path.join(PUPPETEER_DIR, 'profile');\r\n\r\n// The minimal args to speed up the browser\r\nconst minimalArgs = [\r\n  `--user-data-dir=${DATA_DIR}`,\r\n  '--autoplay-policy=user-gesture-required',\r\n  '--disable-background-networking',\r\n  '--disable-background-timer-throttling',\r\n  '--disable-backgrounding-occluded-windows',\r\n  '--disable-breakpad',\r\n  '--disable-client-side-phishing-detection',\r\n  '--disable-component-update',\r\n  '--disable-default-apps',\r\n  '--disable-dev-shm-usage',\r\n  '--disable-domain-reliability',\r\n  '--disable-extensions',\r\n  '--disable-features=AudioServiceOutOfProcess',\r\n  '--disable-hang-monitor',\r\n  '--disable-ipc-flooding-protection',\r\n  '--disable-notifications',\r\n  '--disable-offer-store-unmasked-wallet-cards',\r\n  '--disable-popup-blocking',\r\n  '--disable-print-preview',\r\n  '--disable-prompt-on-repost',\r\n  '--disable-renderer-backgrounding',\r\n  '--disable-session-crashed-bubble',\r\n  '--disable-setuid-sandbox',\r\n  '--disable-speech-api',\r\n  '--disable-sync',\r\n  '--hide-crash-restore-bubble',\r\n  '--hide-scrollbars',\r\n  '--ignore-gpu-blacklist',\r\n  '--metrics-recording-only',\r\n  '--mute-audio',\r\n  '--no-default-browser-check',\r\n  '--no-first-run',\r\n  '--no-pings',\r\n  '--no-sandbox',\r\n  '--no-zygote',\r\n  '--password-store=basic',\r\n  '--use-mock-keychain'\r\n];\r\n\r\nconst __dirname = url.fileURLToPath(new URL('.', import.meta.url));\r\n\r\nconst template = fs.readFileSync(\r\n  __dirname + '/../templates/template.html',\r\n  'utf8'\r\n);\r\n\r\nlet browser;\r\n\r\nexport const newPage = async () => {\r\n  if (!browser) return false;\r\n\r\n  const p = await browser.newPage();\r\n\r\n  await p.setContent(template);\r\n  await p.addScriptTag({ path: __dirname + '/../.cache/sources.js' });\r\n  // eslint-disable-next-line no-undef\r\n  await p.evaluate(() => window.setupHighcharts());\r\n\r\n  p.on('pageerror', async (err) => {\r\n    // TODO: Consider adding a switch here that turns on log(0) logging\r\n    // on page errors.\r\n    log(1, '[page error]', err);\r\n    await p.$eval(\r\n      '#container',\r\n      (element, errorMessage) => {\r\n        // eslint-disable-next-line no-undef\r\n        if (window._displayErrors) {\r\n          element.innerHTML = errorMessage;\r\n        }\r\n      },\r\n      `<h1>Chart input data error</h1>${err.toString()}`\r\n    );\r\n  });\r\n\r\n  return p;\r\n};\r\n\r\nexport const create = async (puppeteerArgs) => {\r\n  const allArgs = [...minimalArgs, ...(puppeteerArgs || [])];\r\n\r\n  // Create a browser\r\n  if (!browser) {\r\n    let tryCount = 0;\r\n\r\n    const open = async () => {\r\n      try {\r\n        log(\r\n          3,\r\n          '[browser] attempting to get a browser instance (try',\r\n          tryCount + ')'\r\n        );\r\n\r\n        browser = await puppeteer.launch({\r\n          headless: 'new',\r\n          args: allArgs,\r\n          userDataDir: './tmp/'\r\n        });\r\n      } catch (e) {\r\n        log(0, '[browser]', e);\r\n        if (++tryCount < 25) {\r\n          log(3, '[browser] failed:', e);\r\n          await new Promise((response) => setTimeout(response, 4000));\r\n          await open();\r\n        } else {\r\n          log(0, 'Max retries reached');\r\n        }\r\n      }\r\n    };\r\n\r\n    try {\r\n      await open();\r\n    } catch (e) {\r\n      log(0, '[browser] Unable to open browser');\r\n      return false;\r\n    }\r\n\r\n    if (!browser) {\r\n      log(0, '[browser] Unable to open browser');\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Return a browser promise\r\n  return browser;\r\n};\r\n\r\nexport const get = async () => {\r\n  if (!browser) {\r\n    throw 'No valid browser has been created';\r\n  }\r\n\r\n  return browser;\r\n};\r\n\r\nexport const close = async () => {\r\n  // Close the browser when connnected\r\n  if (browser.connected) {\r\n    await browser.close();\r\n  }\r\n};\r\n\r\nexport default {\r\n  get,\r\n  close,\r\n  newPage\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\n// TODO: remove this temp benchmark stuff. I had this idea of doing a general benchmarking\r\n// system, but it adds so much bloat in the code that it shouldn't be there.\r\n\r\nimport benchmark from './benchmark.js';\r\nimport cache from './cache.js';\r\nimport { log } from './logger.js';\r\nimport svgTemplate from './../templates/svg_export/svg_export.js';\r\n\r\nimport { readFileSync } from 'fs';\r\nimport path from 'path';\r\nimport * as url from 'url';\r\n\r\nconst __basedir = url.fileURLToPath(new URL('.', import.meta.url));\r\n\r\n// const jsonTemplate = require('./../templates/json_export/json_export.js');\r\n\r\n/**\r\n * Gets the clip region for the chart DOM node.\r\n *\r\n * @param {object} page - A page of a browser instance.\r\n * @return {object} - A clipped region.\r\n */\r\nconst getClipRegion = (page) =>\r\n  page.$eval('#chart-container', (element) => {\r\n    const { x, y, width, height } = element.getBoundingClientRect();\r\n    return {\r\n      x,\r\n      y,\r\n      width,\r\n      height: Math.trunc(height > 1 ? height : 500)\r\n    };\r\n  });\r\n\r\n/**\r\n * Rasterizes the page to an image (PNG or JPEG)\r\n *\r\n * @param {object} page - A page of a browser instance.\r\n * @param {string} type - The type of a result image.\r\n * @param {string} encoding - The type of encoding used.\r\n * @param {string} clip - The clip region.\r\n * @returns {string} - A string representation of a screenshot.\r\n */\r\nconst createImage = async (page, type, encoding, clip) =>\r\n  await Promise.race([\r\n    page.screenshot({\r\n      type,\r\n      encoding,\r\n      clip\r\n    }),\r\n    new Promise((resolve, reject) =>\r\n      setTimeout(() => reject(new Error('Rasterization timeout')), 1500)\r\n    )\r\n  ]);\r\n\r\n/**\r\n * Turns page into a PDF.\r\n *\r\n * @param {object} page - A page of a browser instance.\r\n * @param {number} height - The height of a chart.\r\n * @param {number} width - The width of a chart.\r\n * @param {string} encoding - The type of encoding used.\r\n * @return {object} - A buffer with PDF representation.\r\n */\r\nconst createPDF = async (page, height, width, encoding) =>\r\n  await page.pdf({\r\n    // This will remove an extra empty page in PDF exports\r\n    height: height + 1,\r\n    width,\r\n    encoding\r\n  });\r\n\r\n/**\r\n * Exports as a SVG.\r\n *\r\n * @param {object} page - A page of a browser instance.\r\n * @return {object} - The outerHTML element with the SVG representation.\r\n */\r\nconst createSVG = async (page) =>\r\n  await page.$eval(\r\n    '#container svg:first-of-type',\r\n    (element) => element.outerHTML\r\n  );\r\n\r\n/** Load config into a page and render a chart */\r\nconst setAsConfig = async (page, chart, options) =>\r\n  await page.evaluate(\r\n    // eslint-disable-next-line no-undef\r\n    (chart, options) => window.triggerExport(chart, options),\r\n    chart,\r\n    options\r\n  );\r\n\r\n/** Load SVG into a page */\r\n// const setAsSVG = async (page, svgStr) => true;\r\n\r\n/**\r\n * Does an export for a given browser.\r\n *\r\n * @param {object} browser - A browser instance.\r\n * @param {object} chart - Chart's options.\r\n * @param {object} options - All options object.\r\n * @return {object} - The data returned from one of the methods for exporting\r\n * a specific type of an image.\r\n */\r\nexport default async (page, chart, options) => {\r\n  /**\r\n   * Keeps track of all resources added on the page with addXXXTag. etc\r\n   * It's VITAL that all added resources ends up here so we can clear things\r\n   * out when doing a new export in the same page!\r\n   */\r\n  const injectedResources = [];\r\n\r\n  /** Clear out all state set on the page with addScriptTag/addStyleTag. */\r\n  const clearInjected = async (page) => {\r\n    for (const res of injectedResources) {\r\n      await res.dispose();\r\n    }\r\n\r\n    // Reset all CSS and script tags\r\n    await page.evaluate(() => {\r\n      // eslint-disable-next-line no-undef\r\n      const [, ...scriptsToRemove] = document.getElementsByTagName('script');\r\n      // eslint-disable-next-line no-undef\r\n      const [, ...stylesToRemove] = document.getElementsByTagName('style');\r\n      // eslint-disable-next-line no-undef\r\n      const [...linksToRemove] = document.getElementsByTagName('link');\r\n\r\n      // Remove tags\r\n      for (const element of [\r\n        ...scriptsToRemove,\r\n        ...stylesToRemove,\r\n        ...linksToRemove\r\n      ]) {\r\n        element.remove();\r\n      }\r\n    });\r\n  };\r\n\r\n  try {\r\n    const exportBench = benchmark('Puppeteer');\r\n\r\n    log(4, '[export] Determining export path.');\r\n\r\n    const exportOptions = options.export;\r\n\r\n    // Force a rAF\r\n    // See https://github.com/puppeteer/puppeteer/issues/7507\r\n    // eslint-disable-next-line no-undef\r\n    await page.evaluate(() => requestAnimationFrame(() => {}));\r\n\r\n    // Decide whether display error or debbuger wrapper around it\r\n    const displayErrors =\r\n      exportOptions?.options?.chart?.displayErrors &&\r\n      cache.getCache().activeManifest.modules.debugger;\r\n\r\n    // eslint-disable-next-line no-undef\r\n    await page.evaluate((d) => (window._displayErrors = d), displayErrors);\r\n\r\n    const svgBench = benchmark('SVG handling');\r\n\r\n    let isSVG;\r\n\r\n    if (\r\n      chart.indexOf &&\r\n      (chart.indexOf('<svg') >= 0 || chart.indexOf('<?xml') >= 0)\r\n    ) {\r\n      // SVG INPUT HANDLING\r\n\r\n      log(4, '[export] Treating as SVG.');\r\n\r\n      // If input is also svg, just return it\r\n      if (exportOptions.type === 'svg') {\r\n        return chart;\r\n      }\r\n\r\n      isSVG = true;\r\n      const setPageBench = benchmark('Setting content');\r\n      await page.setContent(svgTemplate(chart));\r\n      setPageBench();\r\n    } else {\r\n      // JSON Config handling\r\n\r\n      log(4, '[export] Treating as config.');\r\n\r\n      // Need to perform straight inject\r\n      if (exportOptions.strInj) {\r\n        // Injection based configuration export\r\n        const setPageBench = benchmark('Setting page content (inject)');\r\n\r\n        await setAsConfig(\r\n          page,\r\n          {\r\n            chart: {\r\n              height: exportOptions.height,\r\n              width: exportOptions.width\r\n            }\r\n          },\r\n          options\r\n        );\r\n\r\n        setPageBench();\r\n      } else {\r\n        // Basic configuration export\r\n\r\n        chart.chart.height = exportOptions.height;\r\n        chart.chart.width = exportOptions.width;\r\n\r\n        const setContentBench = benchmark('Setting page content (config)');\r\n        await setAsConfig(page, chart, options);\r\n        setContentBench();\r\n      }\r\n    }\r\n\r\n    svgBench();\r\n    const resBench = benchmark('Applying resources');\r\n\r\n    // Use resources\r\n    const resources = options.customCode.resources;\r\n    if (resources) {\r\n      // Load custom JS code\r\n      if (resources.js) {\r\n        injectedResources.push(\r\n          await page.addScriptTag({\r\n            content: resources.js\r\n          })\r\n        );\r\n      }\r\n\r\n      // Load scripts from all custom files\r\n      if (resources.files) {\r\n        for (const file of resources.files) {\r\n          try {\r\n            const isLocal = !file.startsWith('http') ? true : false;\r\n\r\n            // Add each custom script from resources' files\r\n            injectedResources.push(\r\n              await page.addScriptTag(\r\n                isLocal\r\n                  ? {\r\n                      content: readFileSync(file, 'utf8')\r\n                    }\r\n                  : {\r\n                      url: file\r\n                    }\r\n              )\r\n            );\r\n          } catch (notice) {\r\n            log(4, '[export] JS file not found.');\r\n          }\r\n        }\r\n      }\r\n\r\n      const cssBench = benchmark('Loading css');\r\n\r\n      // Load CSS\r\n      if (resources.css) {\r\n        let cssImports = resources.css.match(/@import\\s*([^;]*);/g);\r\n        if (cssImports) {\r\n          // Handle css section\r\n          for (let cssImportPath of cssImports) {\r\n            if (cssImportPath) {\r\n              cssImportPath = cssImportPath\r\n                .replace('url(', '')\r\n                .replace('@import', '')\r\n                .replace(/\"/g, '')\r\n                .replace(/'/g, '')\r\n                .replace(/;/, '')\r\n                .replace(/\\)/g, '')\r\n                .trim();\r\n\r\n              // Add each custom css from resources\r\n              if (cssImportPath.startsWith('http')) {\r\n                injectedResources.push(\r\n                  await page.addStyleTag({\r\n                    url: cssImportPath\r\n                  })\r\n                );\r\n              } else if (options.customCode.allowFileResources) {\r\n                injectedResources.push(\r\n                  await page.addStyleTag({\r\n                    path: path.join(__basedir, cssImportPath)\r\n                  })\r\n                );\r\n              }\r\n            }\r\n          }\r\n        }\r\n\r\n        // The rest of the CSS section will be content by now\r\n        injectedResources.push(\r\n          await page.addStyleTag({\r\n            content: resources.css.replace(/@import\\s*([^;]*);/g, '') || ' '\r\n          })\r\n        );\r\n      }\r\n\r\n      cssBench();\r\n    }\r\n\r\n    resBench();\r\n\r\n    // Get the real chart size\r\n    const size = isSVG\r\n      ? await page.$eval(\r\n          '#chart-container svg:first-of-type',\r\n          async (element, scale) => {\r\n            return {\r\n              chartHeight: element.height.baseVal.value * scale,\r\n              chartWidth: element.width.baseVal.value * scale\r\n            };\r\n          },\r\n          parseFloat(exportOptions.scale)\r\n        )\r\n      : await page.evaluate(async () => {\r\n          // eslint-disable-next-line no-undef\r\n          const { chartHeight, chartWidth } = window.Highcharts.charts[0];\r\n          return {\r\n            chartHeight,\r\n            chartWidth\r\n          };\r\n        });\r\n\r\n    const vpBench = benchmark('Setting viewport');\r\n\r\n    // Set final height and width for viewport\r\n    const viewportHeight = Math.ceil(size?.chartHeight || exportOptions.height);\r\n    const viewportWidth = Math.ceil(size?.chartWidth || exportOptions.width);\r\n\r\n    // Set the viewport for the first time\r\n    // NOTE: the call to setViewport is expensive - can we get away with only\r\n    // calling it once, e.g. moving this one into the isSVG condition below?\r\n    await page.setViewport({\r\n      height: viewportHeight,\r\n      width: viewportWidth,\r\n      deviceScaleFactor: isSVG ? 1 : parseFloat(exportOptions.scale)\r\n    });\r\n\r\n    // Prepare a zoom callback for the next evaluate call\r\n    const zoomCallback = isSVG\r\n      ? // In case of SVG the zoom must be set directly for body\r\n        (scale) => {\r\n          // Set the zoom as scale\r\n          // eslint-disable-next-line no-undef\r\n          document.body.style.zoom = scale;\r\n\r\n          // Set the margin to 0px\r\n          // eslint-disable-next-line no-undef\r\n          document.body.style.margin = '0px';\r\n        }\r\n      : // No need for such scale manipulation in case of other types of exports\r\n        () => {\r\n          // Reset the zoom for other exports than to SVGs\r\n          // eslint-disable-next-line no-undef\r\n          document.body.style.zoom = 1;\r\n        };\r\n\r\n    // Set the zoom accordingly\r\n    await page.evaluate(zoomCallback, parseFloat(exportOptions.scale));\r\n\r\n    // Get the clip region for the page\r\n    const { height, width, x, y } = await getClipRegion(page);\r\n\r\n    if (!isSVG) {\r\n      // Set the final viewport now that we have the real height\r\n      await page.setViewport({\r\n        width: Math.round(width),\r\n        height: Math.round(height),\r\n        deviceScaleFactor: parseFloat(exportOptions.scale)\r\n      });\r\n    }\r\n\r\n    vpBench();\r\n\r\n    let data;\r\n\r\n    const expBenchmark = benchmark('Rasterizing chart');\r\n\r\n    // RASTERIZATION\r\n    if (exportOptions.type === 'svg') {\r\n      // SVG\r\n      data = await createSVG(page);\r\n    } else if (exportOptions.type === 'png' || exportOptions.type === 'jpeg') {\r\n      // PNG or JPEG\r\n      data = await createImage(page, exportOptions.type, 'base64', {\r\n        width: viewportWidth,\r\n        height: viewportHeight,\r\n        x,\r\n        y\r\n      });\r\n    } else if (exportOptions.type === 'pdf') {\r\n      // PDF\r\n      data = await createPDF(page, viewportHeight, viewportWidth, 'base64');\r\n    } else {\r\n      throw `Unsupported output format ${exportOptions.type}`;\r\n    }\r\n\r\n    // Destroy old charts after the export is done\r\n    await page.evaluate(() => {\r\n      // eslint-disable-next-line no-undef\r\n      const oldCharts = Highcharts.charts;\r\n\r\n      // Check in any already existing charts\r\n      if (oldCharts.length) {\r\n        // Destroy old charts\r\n        for (const oldChart of oldCharts) {\r\n          oldChart && oldChart.destroy();\r\n          // eslint-disable-next-line no-undef\r\n          Highcharts.charts.shift();\r\n        }\r\n      }\r\n    });\r\n\r\n    expBenchmark();\r\n    exportBench();\r\n\r\n    await clearInjected(page);\r\n\r\n    return data;\r\n  } catch (error) {\r\n    await clearInjected(page);\r\n    log(1, `[export] Error encountered during export: ${error}`);\r\n\r\n    return error;\r\n  }\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2022, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { log } from './logger.js';\r\nconst timers = {};\r\n\r\n// TODO: Read from config\r\nlet enabled = false;\r\n\r\nexport default (id) => {\r\n  if (!enabled) {\r\n    return () => {};\r\n  }\r\n\r\n  timers[id] = new Date();\r\n  return () => {\r\n    log(\r\n      3,\r\n      `[benchmark] - ${id}: ${new Date().getTime() - timers[id].getTime()}ms`\r\n    );\r\n  };\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport cssTemplate from './css.js';\r\n\r\nexport default (chart) => `\r\n<!DOCTYPE html>\r\n<html lang='en-US'>\r\n  <head>\r\n    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\r\n    <title>Highcarts Export</title>\r\n  </head>\r\n  <style>\r\n    ${cssTemplate()}\r\n  </style>\r\n  <body>\r\n    <div id=\"chart-container\">\r\n      ${chart}\r\n    </div>\r\n  </body>\r\n</html>\r\n\r\n`;\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { v4 as uuid } from 'uuid';\r\nimport { Pool } from 'tarn';\r\nimport {\r\n  close,\r\n  newPage as browserNewPage,\r\n  create as createBrowser\r\n} from './browser.js';\r\nimport { log } from './logger.js';\r\n\r\nimport puppeteerExport from './export.js';\r\n\r\nlet performedExports = 0;\r\nlet exportAttempts = 0;\r\nlet timeSpent = 0;\r\nlet droppedExports = 0;\r\nlet spentAverage = 0;\r\nlet poolConfig = {};\r\n\r\n// The pool instance\r\nlet pool = false;\r\n\r\n// Custom puppeteer arguments\r\nlet puppeteerArgs;\r\n\r\nconst factory = {\r\n  /**\r\n   * Creates a new worker.\r\n   *\r\n   * @return {object} - An object with the id of a resource, the work count and\r\n   * a reference to the browser page.\r\n   */\r\n  create: async () => {\r\n    const id = uuid();\r\n    let page = false;\r\n\r\n    const s = new Date().getTime();\r\n\r\n    try {\r\n      page = await browserNewPage();\r\n\r\n      if (!page || page.isClosed()) {\r\n        throw 'invalid page';\r\n      }\r\n\r\n      log(\r\n        3,\r\n        `[pool] Successfully created a worker ${id} - took ${\r\n          new Date().getTime() - s\r\n        } ms.`\r\n      );\r\n    } catch (error) {\r\n      log(\r\n        1,\r\n        `[pool] Error creating a new page in pool entry creation! ${error}`\r\n      );\r\n\r\n      throw 'Error creating page';\r\n    }\r\n\r\n    return {\r\n      id,\r\n      page,\r\n      // Try to distribute the initial work count\r\n      workCount: Math.round(Math.random() * (poolConfig.workLimit / 2))\r\n    };\r\n  },\r\n\r\n  /**\r\n   * Validates a worker.\r\n   *\r\n   * @param {object} workerHandle - A browser's instance.\r\n   *\r\n   * @return {boolean} - Bool that indicates if a resource is valid or not.\r\n   */\r\n  validate: (workerHandle) => {\r\n    if (\r\n      poolConfig.workLimit &&\r\n      ++workerHandle.workCount > poolConfig.workLimit\r\n    ) {\r\n      log(\r\n        3,\r\n        `[pool] Worker failed validation:`,\r\n        `exceeded work limit (limit is ${poolConfig.workLimit})`\r\n      );\r\n      return false;\r\n    }\r\n    return true;\r\n  },\r\n\r\n  /**\r\n   * Destroys a worker.\r\n   *\r\n   * @param {object} workerHandle - A browser's instance.\r\n   */\r\n  destroy: (workerHandle) => {\r\n    log(3, `[pool] Destroying pool entry ${workerHandle.id}.`);\r\n\r\n    if (workerHandle.page) {\r\n      // We don't really need to wait around for this.\r\n      workerHandle.page.close();\r\n    }\r\n  },\r\n\r\n  // Logger function\r\n  log: (message, logLevel) => console.log(`${logLevel}: ${message}`)\r\n};\r\n\r\n/**\r\n * Inits the pool of resources.\r\n *\r\n * @param {object} config - Pool configuration along with custom puppeteer\r\n * arguments for the puppeteer.launch function.\r\n */\r\nexport const init = async (config) => {\r\n  // The newest puppeteer arguments for the browser creation\r\n  puppeteerArgs = config.puppeteerArgs;\r\n\r\n  // Wait until we've sucessfully created a browser instance.\r\n  try {\r\n    await createBrowser(puppeteerArgs);\r\n  } catch (e) {\r\n    log(0, '[pool|browser]', e);\r\n  }\r\n\r\n  // For the module scope usage\r\n  poolConfig = config && config.pool ? { ...config.pool } : {};\r\n\r\n  log(\r\n    3,\r\n    '[pool] Initializing pool:',\r\n    `min ${poolConfig.initialWorkers}, max ${poolConfig.maxWorkers}.`\r\n  );\r\n\r\n  if (pool) {\r\n    return log(\r\n      4,\r\n      '[pool] Already initialized, please kill it before creating a new one.'\r\n    );\r\n  }\r\n\r\n  // Attach process' exit listeners\r\n  if (poolConfig.listenToProcessExits) {\r\n    attachProcessExitListeners();\r\n  }\r\n\r\n  try {\r\n    // Create a pool along with a minimal number of resources\r\n    pool = new Pool({\r\n      // Get the create/validate/destroy/log functions\r\n      ...factory,\r\n      min: poolConfig.initialWorkers,\r\n      max: poolConfig.maxWorkers,\r\n      createRetryIntervalMillis: 200,\r\n      createTimeoutMillis: poolConfig.acquireTimeout,\r\n      acquireTimeoutMillis: poolConfig.acquireTimeout,\r\n      destroyTimeoutMillis: poolConfig.acquireTimeout,\r\n      idleTimeoutMillis: poolConfig.timeoutThreshold,\r\n      reapIntervalMillis: 1000, // poolConfig.reaper ? 120000 : 0, for now\r\n      propagateCreateError: false\r\n    });\r\n\r\n    // Set events\r\n    pool.on('createFail', (eventId, err) => {\r\n      log(\r\n        1,\r\n        `[pool] Error when creating worker of an event id ${eventId}:`,\r\n        err\r\n      );\r\n    });\r\n\r\n    pool.on('acquireFail', (eventId, err) => {\r\n      log(\r\n        1,\r\n        `[pool] Error when acquiring worker of an event id ${eventId}:`,\r\n        err\r\n      );\r\n    });\r\n\r\n    pool.on('destroyFail', (eventId, resource, err) => {\r\n      log(\r\n        1,\r\n        `[pool] Error when destroying worker of an id ${resource.id}, event id ${eventId}:`,\r\n        err\r\n      );\r\n    });\r\n\r\n    pool.on('release', (resource) => {\r\n      log(4, `[pool] Releasing a worker of an id ${resource.id}`);\r\n    });\r\n\r\n    pool.on('destroySuccess', (eventId, resource) => {\r\n      log(4, `[pool] Destroyed a worker of an id ${resource.id}`);\r\n    });\r\n\r\n    const initialResources = [];\r\n    // Create an initial number of resources\r\n    for (let i = 0; i < poolConfig.initialWorkers; i++) {\r\n      initialResources.push(await pool.acquire().promise);\r\n    }\r\n\r\n    // Release the initial number of resources back to the pool\r\n    initialResources.forEach((resource) => {\r\n      pool.release(resource);\r\n    });\r\n\r\n    log(\r\n      3,\r\n      `[pool] The pool is ready with ${poolConfig.initialWorkers} initial resources waiting.`\r\n    );\r\n  } catch (error) {\r\n    log(1, `[pool] Couldn't create the worker pool ${error}`);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Attaches process' exit listeners.\r\n */\r\nexport function attachProcessExitListeners() {\r\n  log(4, '[pool] Attaching exit listeners to the process.');\r\n\r\n  // Kill all pool resources on exit\r\n  process.on('exit', async () => {\r\n    await killPool();\r\n  });\r\n\r\n  // Handler for the SIGINT\r\n  process.on('SIGINT', (name, code) => {\r\n    log(4, `The ${name} event with code: ${code}.`);\r\n    process.exit(1);\r\n  });\r\n\r\n  // Handler for the SIGTERM\r\n  process.on('SIGTERM', (name, code) => {\r\n    log(4, `The ${name} event with code: ${code}.`);\r\n    process.exit(1);\r\n  });\r\n\r\n  // Handler for the uncaughtException\r\n  process.on('uncaughtException', async (error, name) => {\r\n    log(4, `The ${name} error, message: ${error.message}.`);\r\n  });\r\n}\r\n\r\n/**\r\n * Kills the pool and flush the browser instance.\r\n */\r\nexport async function killPool() {\r\n  log(3, '[pool] Killing all workers.');\r\n\r\n  // Return true when the pool is already destroyed\r\n  if (pool.destroyed) {\r\n    // Close the browser instance if still connected\r\n    await close();\r\n    return true;\r\n  }\r\n\r\n  // If still alive, destroy the pool of pages before closing a browser\r\n  await pool.destroy();\r\n\r\n  // Close the browser instance\r\n  await close();\r\n  return true;\r\n}\r\n\r\n/**\r\n * Posts work to the pool.\r\n *\r\n * @param {object} chart - Chart's options.\r\n * @param {object} options - All options object.\r\n */\r\nexport const postWork = async (chart, options) => {\r\n  let workerHandle;\r\n\r\n  // Handle fail conditions\r\n  const fail = (msg) => {\r\n    ++droppedExports;\r\n\r\n    if (workerHandle) {\r\n      pool.release(workerHandle);\r\n    }\r\n\r\n    throw 'In pool.postWork: ' + msg;\r\n  };\r\n\r\n  log(4, '[pool] Work received, starting to process.');\r\n\r\n  if (poolConfig.benchmarking) {\r\n    getPoolInfo();\r\n  }\r\n\r\n  ++exportAttempts;\r\n\r\n  if (!pool) {\r\n    log(1, '[pool] Work received, but pool has not been started.');\r\n    return fail('Pool is not inited but work was posted to it!');\r\n  }\r\n\r\n  // Acquire the worker along with the id of resource and work count\r\n  try {\r\n    log(4, '[pool] Acquiring worker');\r\n    workerHandle = await pool.acquire().promise;\r\n  } catch (error) {\r\n    return fail(`[pool] Error when acquiring available entry: ${error}`);\r\n  }\r\n\r\n  log(4, '[pool] Acquired worker handle');\r\n\r\n  if (!workerHandle.page) {\r\n    return fail('Resolved worker page is invalid: pool setup is wonky');\r\n  }\r\n\r\n  try {\r\n    // Save the start time\r\n    let workStart = new Date().getTime();\r\n\r\n    log(4, `[pool] Starting work on pool entry ${workerHandle.id}.`);\r\n\r\n    // Perform an export on a puppeteer level\r\n    const result = await puppeteerExport(workerHandle.page, chart, options);\r\n\r\n    // Check if it's an error\r\n    if (result instanceof Error) {\r\n      // TODO: If the export failed because puppeteer timed out, we need to force kill the worker so we get a new page. That needs to be handled better than this hack.\r\n      if (result.message === 'Rasterization timeout') {\r\n        workerHandle.page.close();\r\n        workerHandle.page = await browserNewPage();\r\n      }\r\n\r\n      return fail(result);\r\n    }\r\n\r\n    // Release the resource back to the pool\r\n    pool.release(workerHandle);\r\n\r\n    // Used for statistics in averageTime and processedWorkCount, which\r\n    // in turn is used by the /health route.\r\n    const workEnd = new Date().getTime();\r\n    const exportTime = workEnd - workStart;\r\n    timeSpent += exportTime;\r\n    spentAverage = timeSpent / ++performedExports;\r\n\r\n    log(4, `[pool] Work completed in ${exportTime} ms.`);\r\n\r\n    // Otherwise return the result\r\n    return {\r\n      data: result,\r\n      options\r\n    };\r\n  } catch (error) {\r\n    fail(`Error trying to perform puppeteer export: ${error}.`);\r\n  }\r\n};\r\n\r\n/**\r\n * Gets the pool.\r\n */\r\nexport function getPool() {\r\n  return pool;\r\n}\r\n\r\nexport const getPoolInfoJSON = () => ({\r\n  min: pool.min,\r\n  max: pool.max,\r\n  size: pool.size,\r\n  available: pool.available,\r\n  borrowed: pool.borrowed,\r\n  pending: pool.pending,\r\n  spareResourceCapacity: pool.spareResourceCapacity\r\n});\r\n\r\n/**\r\n * Gets the pool's information.\r\n */\r\nexport function getPoolInfo() {\r\n  const {\r\n    min,\r\n    max,\r\n    size,\r\n    available,\r\n    borrowed,\r\n    pending,\r\n    spareResourceCapacity\r\n  } = pool;\r\n\r\n  log(4, `[pool] The minimum number of resources allowed by pool: ${min}.`);\r\n  log(4, `[pool] The maximum number of resources allowed by pool: ${max}.`);\r\n  log(\r\n    4,\r\n    `[pool] The number of all resources in pool (free or in use): ${size}.`\r\n  );\r\n  log(\r\n    4,\r\n    `[pool] The number of resources that are currently available: ${available}.`\r\n  );\r\n  log(\r\n    4,\r\n    `[pool] The number of resources that are currently acquired: ${borrowed}.`\r\n  );\r\n  log(\r\n    4,\r\n    `[pool] The number of callers waiting to acquire a resource: ${pending}.`\r\n  );\r\n  log(\r\n    4,\r\n    `[pool] The number of how many more resources can the pool manage/create: ${spareResourceCapacity}.`\r\n  );\r\n}\r\n\r\nexport default {\r\n  init,\r\n  killPool,\r\n  postWork,\r\n  getPool,\r\n  getPoolInfo,\r\n  getPoolInfoJSON,\r\n  workAttempts: () => exportAttempts,\r\n  droppedWork: () => droppedExports,\r\n  averageTime: () => spentAverage,\r\n  processedWorkCount: () => performedExports\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport cache from '../../cache.js';\r\nimport pool from '../../pool.js';\r\n\r\nconst packageVersion = process.env.npm_package_version;\r\nconst serverStartTime = new Date();\r\n\r\n/**\r\n * Adds the /health route which outputs basic stats for the server\r\n */\r\nexport default (app) =>\r\n  !app\r\n    ? false\r\n    : app.get('/health', (request, response) => {\r\n        response.send({\r\n          status: 'OK',\r\n          bootTime: serverStartTime,\r\n          uptime:\r\n            Math.floor(\r\n              (new Date().getTime() - serverStartTime.getTime()) / 1000 / 60\r\n            ) + ' minutes',\r\n          version: packageVersion,\r\n          highchartsVersion: cache.version(),\r\n          averageProcessingTime: pool.averageTime(),\r\n          performedExports: pool.processedWorkCount(),\r\n          failedExports: pool.droppedWork(),\r\n          exportAttempts: pool.workAttempts(),\r\n          sucessRatio: (pool.processedWorkCount() / pool.workAttempts()) * 100,\r\n          // eslint-disable-next-line import/no-named-as-default-member\r\n          pool: pool.getPoolInfoJSON()\r\n        });\r\n      });\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { existsSync, readFileSync, promises as fsPromises } from 'fs';\r\n\r\nimport prompts from 'prompts';\r\n\r\nimport { log } from './logger.js';\r\nimport { deepCopy, isObject, printUsage, toBoolean } from './utils.js';\r\nimport {\r\n  absoluteProps,\r\n  defaultConfig,\r\n  nestedArgs,\r\n  promptsConfig\r\n} from './schemas/config.js';\r\n\r\nlet generalOptions = {};\r\n\r\n/**\r\n * Getter for the general options.\r\n *\r\n * @return {object} - General options object.\r\n */\r\nexport const getOptions = () => generalOptions;\r\n\r\n/**\r\n * Initializes and sets the general options for the server instace.\r\n *\r\n * @param {object} userOptions - Additional user options (e.g. from the node\r\n * module usage).\r\n * @param {string[]} args - CLI arguments.\r\n * @return {object} - General options object.\r\n */\r\nexport const setOptions = (userOptions, args) => {\r\n  // Only for the CLI usage\r\n  if (args?.length) {\r\n    // Get the additional options from the custom JSON file\r\n    generalOptions = loadConfigFile(args);\r\n  }\r\n\r\n  // Update the default config with a correct option values\r\n  updateDefaultConfig(defaultConfig, generalOptions);\r\n\r\n  // Set values for server's options and returns them\r\n  generalOptions = initOptions(defaultConfig);\r\n\r\n  // Apply user options if there are any\r\n  if (userOptions) {\r\n    // Merge user options\r\n    generalOptions = mergeConfigOptions(\r\n      generalOptions,\r\n      userOptions,\r\n      absoluteProps\r\n    );\r\n  }\r\n\r\n  // Only for the CLI usage\r\n  if (args?.length) {\r\n    // Pair provided arguments\r\n    generalOptions = pairArgumentValue(generalOptions, args, defaultConfig);\r\n  }\r\n\r\n  // Return final general options\r\n  return generalOptions;\r\n};\r\n\r\n/**\r\n * Displays a prompt for the manual configuration.\r\n *\r\n * @param {string} configFileName - The name of a configuration file.\r\n */\r\nexport const manualConfig = async (configFileName) => {\r\n  // Prepare a config object\r\n  let configFile = {};\r\n\r\n  // Check if provided config file exists\r\n  if (existsSync(configFileName)) {\r\n    configFile = JSON.parse(readFileSync(configFileName, 'utf8'));\r\n  }\r\n\r\n  // Question about a configuration category\r\n  const onSubmit = async (p, categories) => {\r\n    let questionsCounter = 0;\r\n    let allQuestions = [];\r\n\r\n    // Create a corresponding property in the manualConfig object\r\n    for (const section of categories) {\r\n      // Mark each option with a section\r\n      promptsConfig[section] = promptsConfig[section].map((option) => ({\r\n        ...option,\r\n        section\r\n      }));\r\n\r\n      // Collect the questions\r\n      allQuestions = [...allQuestions, ...promptsConfig[section]];\r\n    }\r\n\r\n    await prompts(allQuestions, {\r\n      onSubmit: async (prompt, answer) => {\r\n        // Get the default modules\r\n        if (prompt.name === 'modules') {\r\n          answer = answer.length\r\n            ? answer.map((module) => prompt.choices[module])\r\n            : prompt.choices;\r\n\r\n          configFile[prompt.section][prompt.name] = answer;\r\n        } else {\r\n          configFile[prompt.section] = recursiveProps(\r\n            Object.assign({}, configFile[prompt.section] || {}),\r\n            prompt.name.split('.'),\r\n            answer\r\n          );\r\n        }\r\n\r\n        if (++questionsCounter === allQuestions.length) {\r\n          try {\r\n            await fsPromises.writeFile(\r\n              configFileName,\r\n              JSON.stringify(configFile, null, 2),\r\n              'utf8'\r\n            );\r\n          } catch (error) {\r\n            log(1, `[config] Error while creating config.json: ${error}`);\r\n          }\r\n          return true;\r\n        }\r\n      }\r\n    });\r\n\r\n    return true;\r\n  };\r\n\r\n  // Find the categories\r\n  const choices = Object.keys(promptsConfig).map((choice) => ({\r\n    title: `${choice} options`,\r\n    value: choice\r\n  }));\r\n\r\n  // Category prompt\r\n  return prompts(\r\n    {\r\n      type: 'multiselect',\r\n      name: 'category',\r\n      message: 'Which category do you want to configure?',\r\n      hint: 'Space: Select specific, A: Select all, Enter: Confirm.',\r\n      instructions: '',\r\n      choices\r\n    },\r\n    { onSubmit }\r\n  );\r\n};\r\n\r\n/**\r\n * Maps the old options to the new config structure.\r\n *\r\n * @param {object} oldOptions - Options to be mapped.\r\n */\r\nexport const mapToNewConfig = (oldOptions) => {\r\n  const newOptions = {};\r\n  // Cycle through old-structured options\r\n  for (const [key, value] of Object.entries(oldOptions)) {\r\n    const propertiesChain = nestedArgs[key] ? nestedArgs[key].split('.') : [];\r\n\r\n    // Populate object in correct properties levels\r\n    propertiesChain.reduce(\r\n      (obj, prop, index) =>\r\n        (obj[prop] =\r\n          propertiesChain.length - 1 === index ? value : obj[prop] || {}),\r\n      newOptions\r\n    );\r\n  }\r\n  return newOptions;\r\n};\r\n\r\n/**\r\n * Merges the new options to the options object. It omits undefined values.\r\n *\r\n * @param {object} options - Old options.\r\n * @param {object} newOptions - New options.\r\n * @param {string[]} absoluteProps - Array of object names that should be force\r\n * merged.\r\n */\r\nexport const mergeConfigOptions = (options, newOptions, absoluteProps = []) => {\r\n  const mergedOptions = deepCopy(options);\r\n\r\n  for (const [key, value] of Object.entries(newOptions)) {\r\n    mergedOptions[key] =\r\n      isObject(value) &&\r\n      !absoluteProps.includes(key) &&\r\n      mergedOptions[key] !== undefined\r\n        ? mergeConfigOptions(mergedOptions[key], value, absoluteProps)\r\n        : value !== undefined\r\n        ? value\r\n        : mergedOptions[key];\r\n  }\r\n\r\n  return mergedOptions;\r\n};\r\n\r\n/**\r\n * Initializes options for the `startExport` method by merging user options\r\n * with the general options.\r\n *\r\n * @param {any} exportOptions - User options for exporting.\r\n * @param {any} generalOptions - General options are used for the export server.\r\n * @return {object} - User options merged with default options.\r\n */\r\nexport const initExportSettings = (exportOptions, generalOptions = {}) => {\r\n  let options = {};\r\n\r\n  if (exportOptions.svg) {\r\n    options = deepCopy(generalOptions);\r\n    options.export.type = exportOptions.type || exportOptions.export.type;\r\n    options.export.scale = exportOptions.scale || exportOptions.export.scale;\r\n    options.export.outfile =\r\n      exportOptions.outfile || exportOptions.export.outfile;\r\n    options.payload = {\r\n      svg: exportOptions.svg\r\n    };\r\n  } else {\r\n    options = mergeConfigOptions(\r\n      generalOptions,\r\n      exportOptions,\r\n      // Omit going down recursively with the belows\r\n      absoluteProps\r\n    );\r\n  }\r\n\r\n  options.export.outfile =\r\n    options.export?.outfile || `chart.${options.export?.type || 'png'}`;\r\n  return options;\r\n};\r\n\r\n/**\r\n * Loads the configuration from a custom JSON file.\r\n *\r\n * @param {string[]} args - CLI arguments.\r\n * @return {object} - Options object from the JSON file.\r\n */\r\nfunction loadConfigFile(args) {\r\n  // Check if the --loadConfig option was used\r\n  const configIndex = args.findIndex(\r\n    (arg) => arg.replace(/-/g, '') === 'loadConfig'\r\n  );\r\n\r\n  // Check if the --loadConfig has a value\r\n  if (configIndex > -1 && args[configIndex + 1]) {\r\n    const fileName = args[configIndex + 1];\r\n    try {\r\n      // Check if an additional config file is a correct JSON file\r\n      if (fileName && fileName.endsWith('.json')) {\r\n        // Load an optional custom JSON config file\r\n        return JSON.parse(readFileSync(fileName));\r\n      }\r\n    } catch (error) {\r\n      log(1, `[config] Unable to load config from the ${fileName}: ${error}`);\r\n    }\r\n  }\r\n\r\n  // No additional options to return\r\n  return {};\r\n}\r\n\r\n/**\r\n * Setting correct values of the options from the default config.\r\n *\r\n * @param {object} configObj - The config object based on which the initial\r\n * configuration be made.\r\n * @param {object} customObj - The custom object which can contain additional\r\n * option values to set.\r\n * @param {string} propChain - Required for creating a string chain of\r\n * properties for nested arguments.\r\n */\r\nfunction updateDefaultConfig(configObj, customObj = {}, propChain = '') {\r\n  Object.keys(configObj).forEach((key) => {\r\n    if (!['puppeteer', 'highcharts'].includes(key)) {\r\n      const entry = configObj[key];\r\n      const customValue = customObj && customObj[key];\r\n      let numEnvVal;\r\n\r\n      if (typeof entry.value === 'undefined') {\r\n        updateDefaultConfig(entry, customValue, `${propChain}.${key}`);\r\n      } else {\r\n        // If a value from a custom JSON exists, it take precedence\r\n        if (customValue !== undefined) {\r\n          entry.value = customValue;\r\n        }\r\n\r\n        // If a value from an env variable exists, it take precedence\r\n        if (entry.envLink) {\r\n          // Load the env var\r\n          if (entry.type === 'boolean') {\r\n            entry.value = toBoolean(\r\n              [process.env[entry.envLink], entry.value].find(\r\n                (el) => el || el === 'false'\r\n              )\r\n            );\r\n          } else if (entry.type === 'number') {\r\n            numEnvVal = +process.env[entry.envLink];\r\n            entry.value = numEnvVal >= 0 ? numEnvVal : entry.value;\r\n          } else if (\r\n            entry.type.indexOf(']') >= 0 &&\r\n            process.env[entry.envLink]\r\n          ) {\r\n            entry.value = process.env[entry.envLink].split(',');\r\n          } else {\r\n            entry.value = process.env[entry.envLink] || entry.value;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Inits options recursively.\r\n *\r\n * @param {any} items - Items to update options from.\r\n * @return {object} - Updated options object.\r\n */\r\nfunction initOptions(items) {\r\n  let options = {};\r\n  for (const [name, item] of Object.entries(items)) {\r\n    options[name] = Object.prototype.hasOwnProperty.call(item, 'value')\r\n      ? item.value\r\n      : initOptions(item);\r\n  }\r\n  return options;\r\n}\r\n\r\n/**\r\n * Pairs argument with a corresponding value.\r\n *\r\n * @param {object} options - All server options.\r\n * @param {string[]} args - Array of arguments from a user.\r\n * @param {object} defaultConfig - The default config object.\r\n */\r\nfunction pairArgumentValue(options, args, defaultConfig) {\r\n  for (let i = 0; i < args.length; i++) {\r\n    let option = args[i].replace(/-/g, '');\r\n\r\n    // Find the right place for property's value\r\n    const propertiesChain = nestedArgs[option]\r\n      ? nestedArgs[option].split('.')\r\n      : [];\r\n\r\n    propertiesChain.reduce((obj, prop, index) => {\r\n      if (propertiesChain.length - 1 === index) {\r\n        // Finds an option and set a corresponding value\r\n        if (typeof obj[prop] !== 'undefined') {\r\n          if (args[++i]) {\r\n            obj[prop] = args[i] || obj[prop];\r\n          } else {\r\n            console.log(`Missing argument value for ${option}!`.red, '\\n');\r\n            options = printUsage(defaultConfig);\r\n          }\r\n        }\r\n      }\r\n      return obj[prop];\r\n    }, options);\r\n  }\r\n\r\n  return options;\r\n}\r\n\r\n/**\r\n * Recursively sets a property in a correct indentation level based on the\r\n * array of nested properties names.\r\n *\r\n * @param {object} objectToUpdate - Object where a property must be set on a\r\n * correct level.\r\n * @param  {string[]}nestedNames - Array of nasted names that indicates\r\n * indentation level.\r\n * @param {any} value - A value to assign to the property.\r\n * @return {object} - Updated options object.\r\n */\r\nfunction recursiveProps(objectToUpdate, nestedNames, value) {\r\n  while (nestedNames.length > 1) {\r\n    const propName = nestedNames.shift();\r\n\r\n    // Create a property in object if it doesn't exist\r\n    if (!Object.prototype.hasOwnProperty.call(objectToUpdate, propName)) {\r\n      objectToUpdate[propName] = {};\r\n    }\r\n\r\n    // Call function again if there still names to go\r\n    objectToUpdate[propName] = recursiveProps(\r\n      Object.assign({}, objectToUpdate[propName]),\r\n      nestedNames,\r\n      value\r\n    );\r\n\r\n    return objectToUpdate;\r\n  }\r\n\r\n  // Assign the final value\r\n  objectToUpdate[nestedNames[0]] = value;\r\n  return objectToUpdate;\r\n}\r\n\r\nexport default {\r\n  getOptions,\r\n  setOptions,\r\n  manualConfig,\r\n  mapToNewConfig,\r\n  mergeConfigOptions,\r\n  initExportSettings\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { readFile, readFileSync, writeFileSync } from 'fs';\r\n\r\nimport { log } from './logger.js';\r\nimport { killPool, postWork } from './pool.js';\r\nimport {\r\n  clearText,\r\n  fixType,\r\n  handleResources,\r\n  isCorrectJSON,\r\n  optionsStringify,\r\n  roundNumber,\r\n  toBoolean,\r\n  wrapAround\r\n} from './utils.js';\r\nimport { initExportSettings, getOptions } from './config.js';\r\n\r\nlet allowCodeExecution = false;\r\n\r\nexport const startExport = async (settings, endCallback) => {\r\n  // Starting exporting process message\r\n  log(4, '[chart] Starting exporting process.');\r\n\r\n  // Initialize options\r\n  const options = initExportSettings(settings, getOptions());\r\n\r\n  // Get the export options\r\n  const exportOptions = options.export;\r\n\r\n  // If SVG is an input (argument can be sent only by the request)\r\n  if (options.payload?.svg && options.payload.svg !== '') {\r\n    return exportAsString(options.payload.svg.trim(), options, endCallback);\r\n  }\r\n\r\n  // Export using options from the file\r\n  if (exportOptions.infile && exportOptions.infile.length) {\r\n    log(4, '[chart] Attempting to export from an input file.');\r\n\r\n    // Try to read the file\r\n    return readFile(exportOptions.infile, 'utf8', (error, infile) => {\r\n      if (error) {\r\n        return log(1, `[chart] Error loading input file: ${error}.`);\r\n      }\r\n\r\n      // Get the string representation\r\n      options.export.instr = infile;\r\n      return exportAsString(options.export.instr.trim(), options, endCallback);\r\n    });\r\n  }\r\n\r\n  // Export with options from the raw representation\r\n  if (\r\n    (exportOptions.instr && exportOptions.instr !== '') ||\r\n    (exportOptions.options && exportOptions.options !== '')\r\n  ) {\r\n    log(4, '[chart] Attempting to export from a raw input.');\r\n\r\n    // Perform a direct inject when forced\r\n    if (toBoolean(options.customCode?.allowCodeExecution)) {\r\n      return doStraightInject(options, endCallback);\r\n    }\r\n\r\n    // Either try to parse to JSON first or do the direct export\r\n    return typeof exportOptions.instr === 'string'\r\n      ? exportAsString(exportOptions.instr.trim(), options, endCallback)\r\n      : doExport(\r\n          options,\r\n          exportOptions.instr || exportOptions.options,\r\n          endCallback\r\n        );\r\n  }\r\n\r\n  // No input specified, pass an error message to the callback\r\n  log(\r\n    1,\r\n    clearText(\r\n      `[chart] No input specified.\r\n      ${JSON.stringify(exportOptions, undefined, '  ')}.`\r\n    )\r\n  );\r\n\r\n  return (\r\n    endCallback &&\r\n    endCallback(false, {\r\n      error: true,\r\n      message: 'No input specified.'\r\n    })\r\n  );\r\n};\r\n\r\nexport const batchExport = (options) => {\r\n  const batchFunctions = [];\r\n\r\n  // Split and pair the --batch arguments\r\n  for (let pair of options.export.batch.split(';')) {\r\n    pair = pair.split('=');\r\n    if (pair.length === 2) {\r\n      batchFunctions.push(\r\n        new Promise((resolve, reject) => {\r\n          startExport(\r\n            {\r\n              ...options,\r\n              export: {\r\n                ...options.export,\r\n                infile: pair[0],\r\n                outfile: pair[1]\r\n              }\r\n            },\r\n            (info, error) => {\r\n              // Throw an error\r\n              if (error) {\r\n                return reject(error);\r\n              }\r\n\r\n              // Save the base64 from a buffer to a correct image file\r\n              writeFileSync(\r\n                info.options.export.outfile,\r\n                Buffer.from(info.data, 'base64')\r\n              );\r\n\r\n              resolve();\r\n            }\r\n          );\r\n        })\r\n      );\r\n    }\r\n  }\r\n\r\n  // Kill the pool after all exports are done\r\n  Promise.all(batchFunctions)\r\n    .then(() => {\r\n      killPool();\r\n    })\r\n    .catch((error) => {\r\n      log(1, `[chart] Error encountered during batch export: ${error}`);\r\n      killPool();\r\n    });\r\n};\r\n\r\nexport const singleExport = (options) => {\r\n  // Use instr or its alias, options\r\n  options.export.instr = options.export.instr || options.export.options;\r\n\r\n  // Perform an export\r\n  startExport(options, (info, error) => {\r\n    // Exit process when error\r\n    if (error) {\r\n      log(1, `[cli] ${error.message}`);\r\n      process.exit(1);\r\n    }\r\n\r\n    const { outfile, type } = info.options.export;\r\n\r\n    // Save the base64 from a buffer to a correct image file\r\n    writeFileSync(\r\n      outfile || `chart.${type}`,\r\n      type !== 'svg' ? Buffer.from(info.data, 'base64') : info.data\r\n    );\r\n\r\n    // Kill the pool\r\n    killPool();\r\n  });\r\n};\r\n\r\n/**\r\n * Function for choosing chart size and scale based on options prioritization.\r\n *\r\n * @param {object} options - All options object.\r\n * @return {object} - An object with updated size and scale for a chart.\r\n */\r\nexport const findChartSize = (options) => {\r\n  const { chart, exporting } =\r\n    options.export?.options || isCorrectJSON(options.export?.instr);\r\n\r\n  // See if globalOptions holds chart or exporting size\r\n  const globalOptions = isCorrectJSON(options.export?.globalOptions);\r\n\r\n  // Secure scale value\r\n  let scale = roundNumber(\r\n    options.export?.scale ||\r\n      exporting?.scale ||\r\n      globalOptions?.exporting?.scale ||\r\n      options.export?.defaultScale ||\r\n      1\r\n  );\r\n\r\n  if (scale > 5) {\r\n    scale = 5;\r\n  } else if (scale < 0.1) {\r\n    scale = 1;\r\n  }\r\n\r\n  // Find chart size and scale\r\n  return {\r\n    height:\r\n      options.export?.height ||\r\n      exporting?.sourceHeight ||\r\n      chart?.height ||\r\n      globalOptions?.exporting?.sourceHeight ||\r\n      globalOptions?.chart?.height ||\r\n      options.export?.defaultHeight ||\r\n      400,\r\n    width:\r\n      options.export?.width ||\r\n      exporting?.sourceWidth ||\r\n      chart?.width ||\r\n      globalOptions?.exporting?.sourceWidth ||\r\n      globalOptions?.chart?.width ||\r\n      options.export?.defaultWidth ||\r\n      600,\r\n    scale\r\n  };\r\n};\r\n\r\n/**\r\n * Function for final options preparation before export.\r\n *\r\n * @param {object} options - All options object.\r\n * @param {object} chartJson - Chart JSON.\r\n * @param {function} endCallback - The end callback.\r\n * @param {string} svg - The SVG representation.\r\n */\r\nconst doExport = (options, chartJson, endCallback, svg) => {\r\n  let { export: exportOptions, customCode: customCodeOptions } = options;\r\n\r\n  const allowCodeExecutionScoped =\r\n    typeof customCodeOptions.allowCodeExecution === 'boolean'\r\n      ? customCodeOptions.allowCodeExecution\r\n      : allowCodeExecution;\r\n\r\n  if (!customCodeOptions) {\r\n    customCodeOptions = options.customCode = {};\r\n  } else if (typeof options.customCode.resources === 'string') {\r\n    // Process resources\r\n    options.customCode.resources = handleResources(\r\n      options.customCode.resources,\r\n      toBoolean(options.customCode.allowFileResources)\r\n    );\r\n  } else if (!options.customCode.resources) {\r\n    try {\r\n      const resources = readFileSync('resources.json', 'utf8');\r\n      options.customCode.resources = handleResources(\r\n        resources,\r\n        toBoolean(options.customCode.allowFileResources)\r\n      );\r\n    } catch (err) {\r\n      log(3, `[chart] The default resources.json file not found.`);\r\n    }\r\n  }\r\n\r\n  // If the allowCodeExecution flag isn't set, we should refuse the usage\r\n  // of callback, resources, and custom code. Additionally, the worker will\r\n  // refuse to run arbitrary JavaScript. Prioritized should be the scoped\r\n  // option, then we should take a look at the overall pool option.\r\n  if (!allowCodeExecutionScoped && customCodeOptions) {\r\n    if (\r\n      customCodeOptions.callback ||\r\n      customCodeOptions.resources ||\r\n      customCodeOptions.customCode\r\n    ) {\r\n      // Send back a friendly message saying that the exporter does not support\r\n      // these settings.\r\n      return (\r\n        endCallback &&\r\n        endCallback(false, {\r\n          error: true,\r\n          message: clearText(\r\n            `The callback, resources and customCode have been disabled for this\r\n            server.`\r\n          )\r\n        })\r\n      );\r\n    }\r\n\r\n    // Reset all additional custom code\r\n    customCodeOptions.callback = false;\r\n    customCodeOptions.resources = false;\r\n    customCodeOptions.customCode = false;\r\n  }\r\n\r\n  // Clean properties to keep it lean and mean\r\n  if (chartJson) {\r\n    chartJson.chart = chartJson.chart || {};\r\n    chartJson.exporting = chartJson.exporting || {};\r\n    chartJson.exporting.enabled = false;\r\n  }\r\n\r\n  exportOptions.constr = exportOptions.constr || 'chart';\r\n  exportOptions.type = fixType(exportOptions.type, exportOptions.outfile);\r\n  if (exportOptions.type === 'svg') {\r\n    exportOptions.width = false;\r\n  }\r\n\r\n  // Prepare global and theme options\r\n  ['globalOptions', 'themeOptions'].forEach((optionsName) => {\r\n    try {\r\n      if (exportOptions && exportOptions[optionsName]) {\r\n        if (\r\n          typeof exportOptions[optionsName] === 'string' &&\r\n          exportOptions[optionsName].endsWith('.json')\r\n        ) {\r\n          exportOptions[optionsName] = isCorrectJSON(\r\n            readFileSync(exportOptions[optionsName], 'utf8'),\r\n            true\r\n          );\r\n        } else {\r\n          exportOptions[optionsName] = isCorrectJSON(\r\n            exportOptions[optionsName],\r\n            true\r\n          );\r\n        }\r\n      }\r\n    } catch (error) {\r\n      exportOptions[optionsName] = {};\r\n      log(1, `[chart] The ${optionsName} not found.`);\r\n    }\r\n  });\r\n\r\n  // Prepare customCode\r\n  if (customCodeOptions.allowCodeExecution) {\r\n    customCodeOptions.customCode = wrapAround(\r\n      customCodeOptions.customCode,\r\n      customCodeOptions.allowFileResources\r\n    );\r\n  }\r\n\r\n  // Get the callback\r\n  if (\r\n    customCodeOptions &&\r\n    customCodeOptions.callback &&\r\n    customCodeOptions.callback?.indexOf('{') < 0\r\n  ) {\r\n    // The allowFileResources is always set to false for HTTP requests to avoid\r\n    // injecting arbitrary files from the fs\r\n    if (customCodeOptions.allowFileResources) {\r\n      try {\r\n        customCodeOptions.callback = readFileSync(\r\n          customCodeOptions.callback,\r\n          'utf8'\r\n        );\r\n      } catch (error) {\r\n        log(2, `[chart] Error loading callback: ${error}.`);\r\n        customCodeOptions.callback = false;\r\n      }\r\n    } else {\r\n      customCodeOptions.callback = false;\r\n    }\r\n  }\r\n\r\n  // Size search\r\n  options.export = {\r\n    ...options.export,\r\n    ...findChartSize(options)\r\n  };\r\n\r\n  // Post the work to the pool\r\n  postWork(exportOptions.strInj || chartJson || svg, options)\r\n    .then((result) => endCallback(result))\r\n    .catch((error) => {\r\n      log(0, '[chart] When posting work:', error);\r\n      return endCallback(false, error);\r\n    });\r\n};\r\n\r\n/**\r\n * Function for straight injecting the code.\r\n * Dangerous and must be used deliberately by someone who sets up a server\r\n * (see  --allowCodeExecution).\r\n *\r\n * @param {object} options - All options object.\r\n * @param {function} endCallback - The function to call when exporting is done.\r\n */\r\nconst doStraightInject = (options, endCallback) => {\r\n  try {\r\n    let strInj;\r\n    let instr = options.export.instr || options.export.options;\r\n\r\n    if (typeof instr !== 'string') {\r\n      // Try to stringify options\r\n      strInj = instr = optionsStringify(\r\n        instr,\r\n        options.customCode?.allowCodeExecution\r\n      );\r\n    }\r\n    strInj = instr.replaceAll(/\\t|\\n|\\r/g, '').trim();\r\n\r\n    // Get rid of the ;\r\n    if (strInj[strInj.length - 1] === ';') {\r\n      strInj = strInj.substring(0, strInj.length - 1);\r\n    }\r\n\r\n    // Save as stright inject string\r\n    options.export.strInj = strInj;\r\n    return doExport(options, false, endCallback);\r\n  } catch (error) {\r\n    const message = clearText(\r\n      `Malformed input detected for ${options.export?.requestId || '?'}:\r\n      Please make sure that your JSON/JavaScript options\r\n      are sent using the \"options\" attribute, and that if you're using\r\n      SVG, it is unescaped.`\r\n    );\r\n\r\n    log(1, message);\r\n    return (\r\n      endCallback &&\r\n      endCallback(\r\n        false,\r\n        JSON.stringify({\r\n          error: true,\r\n          message\r\n        })\r\n      )\r\n    );\r\n  }\r\n};\r\n\r\n/**\r\n * Prepares an input before exporting.\r\n *\r\n * @param {string} stringToExport - String representation of SVG/export options.\r\n * @param {object} options - All options object.\r\n * @param {function} endCallback - The function to call when exporting is done.\r\n */\r\nconst exportAsString = (stringToExport, options, endCallback) => {\r\n  const { allowCodeExecution } = options.customCode;\r\n\r\n  // Check if it is SVG\r\n  if (\r\n    stringToExport.indexOf('<svg') >= 0 ||\r\n    stringToExport.indexOf('<?xml') >= 0\r\n  ) {\r\n    log(4, '[chart] Parsing input as SVG.');\r\n    return doExport(options, false, endCallback, stringToExport);\r\n  }\r\n\r\n  try {\r\n    // Try to parse to JSON and call the doExport function\r\n    const chartJSON = JSON.parse(stringToExport.replaceAll(/\\t|\\n|\\r/g, ' '));\r\n\r\n    // If a correct JSON, do the export\r\n    return doExport(options, chartJSON, endCallback);\r\n  } catch (error) {\r\n    // Not a valid JSON\r\n    if (toBoolean(allowCodeExecution)) {\r\n      return doStraightInject(options, endCallback);\r\n    } else {\r\n      // Do not allow straight injection without the allowCodeExecution flag\r\n      return (\r\n        endCallback &&\r\n        endCallback(false, {\r\n          error: true,\r\n          message: clearText(\r\n            `Only JSON configurations and SVG is allowed for this server. If\r\n            this is your server, JavaScript exporting can be enabled by starting\r\n            the server with the --allowCodeExecution flag.`\r\n          )\r\n        })\r\n      );\r\n    }\r\n  }\r\n};\r\n\r\nexport const getAllowCodeExecution = () => allowCodeExecution;\r\n\r\nexport const setAllowCodeExecution = (value) => {\r\n  allowCodeExecution = toBoolean(value);\r\n};\r\n\r\n/**\r\n * Starts an exporting process\r\n *\r\n * @param {object} settings - Settings for export.\r\n * @param {function} endCallback - The function to call when exporting is done.\r\n */\r\nexport default {\r\n  batchExport,\r\n  singleExport,\r\n  getAllowCodeExecution,\r\n  setAllowCodeExecution,\r\n  startExport,\r\n  findChartSize\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { v4 as uuid } from 'uuid';\r\n\r\nimport { getAllowCodeExecution, startExport } from '../../chart.js';\r\nimport { getOptions, mergeConfigOptions } from '../../config.js';\r\nimport { log } from '../../logger.js';\r\nimport {\r\n  clearText,\r\n  fixType,\r\n  isCorrectJSON,\r\n  isPrivateRangeUrlFound,\r\n  optionsStringify,\r\n  measureTime\r\n} from '../../utils.js';\r\n\r\n// Reversed MIME types\r\nconst reversedMime = {\r\n  png: 'image/png',\r\n  jpeg: 'image/jpeg',\r\n  gif: 'image/gif',\r\n  pdf: 'application/pdf',\r\n  svg: 'image/svg+xml'\r\n};\r\n\r\n// The requests counter\r\nlet requestsCounter = 0;\r\n\r\nconst benchmark = false;\r\n\r\n// The array of callbacks to call before a request\r\nconst beforeRequest = [];\r\n\r\n// The array of callbacks to call after a request\r\nconst afterRequest = [];\r\n\r\n/**\r\n * Calls callbacks.\r\n *\r\n * @param {Array} callbacks - An array of callbacks.\r\n * @param {object} request - The request.\r\n * @param {object} response - The response.\r\n * @param {object} data - The data to send to callbacks.\r\n * @return {object} - The result from a callback.\r\n */\r\nconst doCallbacks = (callbacks, request, response, data) => {\r\n  let result = true;\r\n  const { id, uniqueId, type, body } = data;\r\n\r\n  callbacks.some((callback) => {\r\n    if (callback) {\r\n      let callResponse = callback(request, response, id, uniqueId, type, body);\r\n\r\n      if (callResponse !== undefined && callResponse !== true) {\r\n        result = callResponse;\r\n      }\r\n\r\n      return true;\r\n    }\r\n  });\r\n\r\n  return result;\r\n};\r\n\r\n/**\r\n * Handles an export.\r\n *\r\n * @param {object} request - The request.\r\n * @param {object} response - The response.\r\n */\r\nconst exportHandler = (request, response) => {\r\n  // Start counting time\r\n  const stopCounter = measureTime();\r\n\r\n  // Get the current server's general options\r\n  const defaultOptions = getOptions();\r\n\r\n  // Init default options\r\n  if (benchmark) {\r\n    console.log('Init default options:', stopCounter(), 'ms.');\r\n  }\r\n\r\n  const body = request.body;\r\n  const id = ++requestsCounter;\r\n  const uniqueId = uuid().replace(/-/g, '');\r\n  let type = fixType(body.type);\r\n\r\n  // Fix type\r\n  if (benchmark) {\r\n    console.log('Fix type:', stopCounter(), 'ms.');\r\n  }\r\n\r\n  // Throw 'Bad Request' if there's no body\r\n  if (!body) {\r\n    return response.status(400).send(\r\n      clearText(\r\n        `Body is required. Sending a body? Make sure your Content-type header\r\n        is correct. Accepted is application/json and multipart/form-data.`\r\n      )\r\n    );\r\n  }\r\n\r\n  // All of the below can be used\r\n  let instr = isCorrectJSON(body.infile || body.options || body.data);\r\n\r\n  // Is correct JSON\r\n  if (benchmark) {\r\n    console.log('Is correct JSON:', stopCounter(), 'ms.');\r\n  }\r\n\r\n  // Throw 'Bad Request' if there's no JSON or SVG to export\r\n  if (!instr && !body.svg) {\r\n    log(\r\n      2,\r\n      clearText(\r\n        `Request ${uniqueId} from ${\r\n          request.headers['x-forwarded-for'] || request.connection.remoteAddress\r\n        } was incorrect. Check your payload.`\r\n      )\r\n    );\r\n\r\n    return response.status(400).send(\r\n      clearText(\r\n        `No correct chart data found. Please make sure you are using\r\n        application/json or multipart/form-data headers, and that the chart\r\n        data is in the 'infile', 'options' or 'data' attribute if sending\r\n        JSON or in the 'svg' if sending SVG.`\r\n      )\r\n    );\r\n  }\r\n\r\n  let callResponse = false;\r\n\r\n  // Call the before request functions\r\n  callResponse = doCallbacks(beforeRequest, request, response, {\r\n    id,\r\n    uniqueId,\r\n    type,\r\n    body\r\n  });\r\n\r\n  // Do callbacks\r\n  if (benchmark) {\r\n    console.log('Do callbacks:', stopCounter(), 'ms.');\r\n  }\r\n\r\n  // Block the request if one of a callbacks failed\r\n  if (callResponse !== true) {\r\n    return response.send(callResponse);\r\n  }\r\n\r\n  let connectionAborted = false;\r\n\r\n  // In case the connection is closed, force to abort further actions\r\n  request.socket.on('close', () => {\r\n    connectionAborted = true;\r\n  });\r\n\r\n  log(4, `[export] Got an incoming HTTP request ${uniqueId}.`);\r\n\r\n  body.constr = (typeof body.constr === 'string' && body.constr) || 'chart';\r\n\r\n  // Gather and organize options from the payload\r\n  const requestOptions = {\r\n    export: {\r\n      instr,\r\n      type,\r\n      constr: body.constr[0].toLowerCase() + body.constr.substr(1),\r\n      height: body.height,\r\n      width: body.width,\r\n      scale: body.scale || defaultOptions.export.scale,\r\n      globalOptions: isCorrectJSON(body.globalOptions, true),\r\n      themeOptions: isCorrectJSON(body.themeOptions, true)\r\n    },\r\n    customCode: {\r\n      allowCodeExecution: getAllowCodeExecution(),\r\n      allowFileResources: false,\r\n      resources: isCorrectJSON(body.resources, true),\r\n      callback: body.callback,\r\n      customCode: body.customCode\r\n    }\r\n  };\r\n\r\n  // Organize options\r\n  if (benchmark) {\r\n    console.log('Organize options:', stopCounter(), 'ms.');\r\n  }\r\n\r\n  if (instr) {\r\n    // Stringify JSON with options\r\n    requestOptions.export.instr = optionsStringify(\r\n      instr,\r\n      requestOptions.customCode.allowCodeExecution\r\n    );\r\n\r\n    // Stringify JSON with options\r\n    if (benchmark) {\r\n      console.log('Stringify JSON with options:', stopCounter(), 'ms.');\r\n    }\r\n  }\r\n\r\n  // Merge the request options into default ones\r\n  const options = mergeConfigOptions(defaultOptions, requestOptions);\r\n\r\n  // Merge config options\r\n  if (benchmark) {\r\n    console.log('Merge config options:', stopCounter(), 'ms.');\r\n  }\r\n\r\n  // Save the JSON if exists\r\n  options.export.options = instr;\r\n\r\n  // Lastly, add the server specific arguments into options as payload\r\n  options.payload = {\r\n    svg: body.svg || false,\r\n    b64: body.b64 || false,\r\n    dataOptions: isCorrectJSON(body.dataOptions, true),\r\n    noDownload: body.noDownload || false,\r\n    requestId: uniqueId\r\n  };\r\n\r\n  // Setting payload\r\n  if (benchmark) {\r\n    console.log('Setting payload:', stopCounter(), 'ms.');\r\n  }\r\n\r\n  // Test xlink:href elements from payload's SVG\r\n  if (body.svg && isPrivateRangeUrlFound(options.payload.svg)) {\r\n    return response\r\n      .status(400)\r\n      .send(\r\n        'SVG potentially contain at least one forbidden URL in xlink:href element.'\r\n      );\r\n  }\r\n\r\n  // Check URL range\r\n  if (benchmark) {\r\n    console.log('Check URL range:', stopCounter(), 'ms.');\r\n  }\r\n\r\n  // Start the export process\r\n  startExport(options, (info, error) => {\r\n    // Remove the close event from the socket\r\n    request.socket.removeAllListeners('close');\r\n\r\n    // After Puppeteer exporting\r\n    if (benchmark) {\r\n      console.log('After Puppeteer exporting:', stopCounter(), 'ms.', '\\n');\r\n    }\r\n\r\n    // If the connection was closed, do nothing\r\n    if (connectionAborted) {\r\n      return log(\r\n        3,\r\n        clearText(\r\n          `[export] The client closed the connection before the chart was done\r\n          processing.`\r\n        )\r\n      );\r\n    }\r\n\r\n    // If error, return it\r\n    if (error) {\r\n      log(\r\n        1,\r\n        clearText(\r\n          `[export] Work: ${uniqueId} could not be completed, sending:\r\n          ${error}`\r\n        )\r\n      );\r\n      return response.status(400).send(error.message);\r\n    }\r\n\r\n    // If data is missing, return the error\r\n    if (!info || !info.data) {\r\n      log(\r\n        1,\r\n        clearText(\r\n          `[export] Unexpected return from chart generation, please check your\r\n          data Request: ${uniqueId} is ${info.data}.`\r\n        )\r\n      );\r\n      return response\r\n        .status(400)\r\n        .send(\r\n          'Unexpected return from chart generation, please check your data.'\r\n        );\r\n    }\r\n\r\n    // Get the type from options\r\n    type = info.options.export.type;\r\n\r\n    // The after request callbacks\r\n    doCallbacks(afterRequest, request, response, { id, body: info.data });\r\n\r\n    if (info.data) {\r\n      // If only base64 is required, return it\r\n      if (body.b64) {\r\n        // Check if it is already base64 or a raw SVG\r\n        if (type === 'pdf') {\r\n          return response.send(\r\n            Buffer.from(info.data, 'utf8').toString('base64')\r\n          );\r\n        }\r\n        return response.send(info.data);\r\n      }\r\n\r\n      // Set correct content type\r\n      response.header('Content-Type', reversedMime[type] || 'image/png');\r\n\r\n      // Decide whether to download or not chart file\r\n      if (!body.noDownload) {\r\n        response.attachment(\r\n          `${request.params.filename || 'chart'}.${type || 'png'}`\r\n        );\r\n      }\r\n\r\n      // If SVG, return plain content\r\n      return type === 'svg'\r\n        ? response.send(info.data)\r\n        : response.send(Buffer.from(info.data, 'base64'));\r\n    }\r\n  });\r\n};\r\n\r\nexport default (app) => {\r\n  app.post('/', exportHandler);\r\n  app.post('/:filename', exportHandler);\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { promises as fsPromises } from 'fs';\r\nimport { posix } from 'path';\r\n\r\nimport bodyParser from 'body-parser';\r\nimport cors from 'cors';\r\nimport express from 'express';\r\nimport multer from 'multer';\r\nimport http from 'http';\r\nimport https from 'https';\r\n\r\nimport { log } from '../logger.js';\r\nimport rateLimit from './rate_limit.js';\r\nimport { __dirname } from '../utils.js';\r\n\r\nimport healthRoute from './routes/health.js';\r\nimport exportRoutes from './routes/export.js';\r\nimport vswitchRoute from './routes/change_hc_version.js';\r\nimport uiRoute from './routes/ui.js';\r\n\r\n// Create express app\r\nconst app = express();\r\n\r\n// Disable the X-Powered-By header\r\napp.disable('x-powered-by');\r\n\r\n// Enable CORS support\r\napp.use(cors());\r\n\r\n// Enable parsing of form data (files) with Multer package\r\nconst storage = multer.memoryStorage();\r\nconst upload = multer({\r\n  storage,\r\n  limits: {\r\n    fieldsSize: '50MB'\r\n  }\r\n});\r\n\r\napp.use(upload.any());\r\n\r\n// Enable body parser\r\napp.use(bodyParser.json({ limit: '50mb' }));\r\napp.use(bodyParser.urlencoded({ extended: true, limit: '50mb' }));\r\napp.use(bodyParser.urlencoded({ extended: false, limit: '50mb' }));\r\n\r\n/**\r\n * Error handler function.\r\n *\r\n * @param {object} error - An error object.\r\n * @return {string} - An error message.\r\n */\r\nconst errorHandler = (error) => log(1, `[server] Socket error: ${error}`);\r\n\r\n/**\r\n * Attaches error handlers for a server.\r\n *\r\n * @param {object} server - The http/https server.\r\n */\r\nconst attachErrorHandlers = (server) => {\r\n  server.on('clientError', errorHandler);\r\n  server.on('error', errorHandler);\r\n  server.on('connection', (socket) =>\r\n    socket.on('error', (error) => errorHandler(error, socket))\r\n  );\r\n};\r\n\r\nexport const startServer = async (serverConfig) => {\r\n  // Stop if not enabled\r\n  if (!serverConfig.enable) {\r\n    return false;\r\n  }\r\n\r\n  // // Get the pool\r\n  // const pool = getPool();\r\n\r\n  // // Try to create browser instance before starting the server\r\n  // const resource = await pool.acquire();\r\n\r\n  // // If not found, throw an error\r\n  // if (!resource.browser) {\r\n  //   log(1, `[server] Could not acquire browser instance.`);\r\n  //   process.exit(1);\r\n  // }\r\n\r\n  // // Release the resource\r\n  // pool.release(resource);\r\n\r\n  // Listen HTTP server\r\n  if (!serverConfig.ssl.enable && !serverConfig.ssl.force) {\r\n    // Main server instance (HTTP)\r\n    const httpServer = http.createServer(app);\r\n    // Attach error handlers and listen to the server\r\n    attachErrorHandlers(httpServer);\r\n    // Listen\r\n    httpServer.listen(serverConfig.port, serverConfig.host);\r\n\r\n    log(\r\n      3,\r\n      `[server] Started HTTP server on ${serverConfig.host}:${serverConfig.port}.`\r\n    );\r\n  }\r\n\r\n  // Listen HTTPS server\r\n  if (serverConfig.ssl.enable) {\r\n    // Set up an SSL server also\r\n    let key, cert;\r\n\r\n    try {\r\n      // Get the SSL key\r\n      key = await fsPromises.readFile(\r\n        posix.join(serverConfig.ssl.certPath, 'server.key'),\r\n        'utf8'\r\n      );\r\n\r\n      // Get the SSL certificate\r\n      cert = await fsPromises.readFile(\r\n        posix.join(serverConfig.ssl.certPath, 'server.crt'),\r\n        'utf8'\r\n      );\r\n    } catch (error) {\r\n      log(\r\n        1,\r\n        `[server] Unable to load key/certificate from ${serverConfig.ssl.certPath}.`\r\n      );\r\n    }\r\n\r\n    if (key && cert) {\r\n      // Main server instance (HTTPS)\r\n      const httpsServer = https.createServer(app);\r\n      // Attach error handlers and listen to the server\r\n      attachErrorHandlers(httpsServer);\r\n      // Listen\r\n      httpsServer.listen(serverConfig.ssl.port, serverConfig.host);\r\n\r\n      log(\r\n        3,\r\n        `[server] Started HTTPS server on ${serverConfig.host}:${serverConfig.ssl.port}.`\r\n      );\r\n    }\r\n  }\r\n\r\n  // Enable the rate limiter if config says so\r\n  if (\r\n    serverConfig.rateLimiting &&\r\n    serverConfig.rateLimiting.enable &&\r\n    ![0, NaN].includes(serverConfig.rateLimiting.maxRequests)\r\n  ) {\r\n    rateLimit(app, serverConfig.rateLimiting);\r\n  }\r\n\r\n  // Set up static folder's route\r\n  app.use(express.static(posix.join(__dirname, 'public')));\r\n\r\n  // Set up routes\r\n  healthRoute(app);\r\n  exportRoutes(app);\r\n  uiRoute(app);\r\n  vswitchRoute(app);\r\n};\r\n\r\n/**\r\n * Returns the express instance.\r\n */\r\nexport const getExpress = () => {\r\n  return express;\r\n};\r\n\r\n/**\r\n * Returns the app instance.\r\n */\r\nexport const getApp = () => {\r\n  return app;\r\n};\r\n\r\n/**\r\n * Adds a middleware to the server.\r\n *\r\n * @param {object} path - An endpoint path to add middlewares to.\r\n * @param {Array} middlewares - An unlimited number of middlewares to use\r\n * against the specific endpoint.\r\n */\r\nexport const use = (path, ...middlewares) => {\r\n  app.use(path, ...middlewares);\r\n};\r\n\r\n/**\r\n * Adds a get route to the server.\r\n *\r\n * @param {object} path - An endpoint path to add middlewares to.\r\n * @param {Array} middlewares - An unlimited number of middlewares to use\r\n * against the specific endpoint for GET method.\r\n */\r\nexport const get = (path, ...middlewares) => {\r\n  app.get(path, ...middlewares);\r\n};\r\n\r\n/**\r\n * Adds a post route to the server.\r\n *\r\n * @param {object} path - An endpoint path to add middlewares to.\r\n * @param {Array} middlewares - An unlimited number of middlewares to use\r\n * against the specific endpoint for POST method.\r\n */\r\nexport const post = (path, ...middlewares) => {\r\n  app.post(path, ...middlewares);\r\n};\r\n\r\n/**\r\n * Forcefully enables rate limiting.\r\n *\r\n * @param {object} limitConfig - The options object for the rate limiter\r\n * configuration.\r\n */\r\nexport const enableRateLimiting = (limitConfig) => {\r\n  return rateLimit(app, limitConfig);\r\n};\r\n\r\nexport default {\r\n  startServer,\r\n  getExpress,\r\n  getApp,\r\n  use,\r\n  get,\r\n  post,\r\n  enableRateLimiting\r\n};\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport { join } from 'path';\r\n\r\nimport { __dirname } from '../../utils.js';\r\n/**\r\n * Adds the / route for a UI when enabled for the export server\r\n */\r\nexport default (app) =>\r\n  !app\r\n    ? false\r\n    : app.get('/', (request, response) => {\r\n        response.sendFile(join(__dirname, 'public', 'index.html'));\r\n      });\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\nimport cache from '../../cache.js';\r\n\r\n/**\r\n * Adds a route that can be used to change the HC version on the server\r\n * TODO: Add auth token and connect to API\r\n */\r\nexport default (app) =>\r\n  !app\r\n    ? false\r\n    : app.post('/change_hc_version/:newVersion', async (request, response) => {\r\n        const ctoken = process.env.HIGHCHARTS_ADMIN_TOKEN;\r\n\r\n        if (!ctoken || !ctoken.length) {\r\n          return response.send({\r\n            error: true,\r\n            message:\r\n              'Server not configured to do run-time version changes: HIGHCHARTS_ADMIN_TOKEN not set'\r\n          });\r\n        }\r\n\r\n        const token = request.get('hc-auth');\r\n\r\n        if (!token || token !== ctoken) {\r\n          return response.send({\r\n            error: true,\r\n            message: 'Invalid or missing token: set token in the hc-auth header'\r\n          });\r\n        }\r\n\r\n        const newVersion = request.params.newVersion;\r\n\r\n        if (newVersion) {\r\n          try {\r\n            // eslint-disable-next-line import/no-named-as-default-member\r\n            await cache.updateVersion(newVersion);\r\n          } catch (e) {\r\n            response.send({\r\n              error: true,\r\n              message: e\r\n            });\r\n          }\r\n\r\n          response.send({\r\n            version: cache.version()\r\n          });\r\n        } else {\r\n          response.send({\r\n            error: true,\r\n            message: 'No new version supplied'\r\n          });\r\n        }\r\n      });\r\n","/*******************************************************************************\r\n\r\nHighcharts Export Server\r\n\r\nCopyright (c) 2016-2023, Highsoft\r\n\r\nLicenced under the MIT licence.\r\n\r\nAdditionally a valid Highcharts license is required for use.\r\n\r\nSee LICENSE file in root for details.\r\n\r\n*******************************************************************************/\r\n\r\n// Add the main directory in the global object\r\nimport 'colors';\r\n\r\nimport server, { startServer } from './server/server.js';\r\nimport {\r\n  setAllowCodeExecution,\r\n  batchExport,\r\n  singleExport,\r\n  startExport\r\n} from './chart.js';\r\nimport { mapToNewConfig, setOptions } from './config.js';\r\nimport { log, setLogLevel, enableFileLogging } from './logger.js';\r\nimport { killPool, init } from './pool.js';\r\nimport { checkCache } from './cache.js';\r\n\r\nexport default {\r\n  log,\r\n  mapToNewConfig,\r\n  setOptions,\r\n  singleExport,\r\n  startExport,\r\n  batchExport,\r\n  server,\r\n  startServer,\r\n  killPool,\r\n  initPool: async (options = {}) => {\r\n    // Set the allowCodeExecution per export module scope\r\n    setAllowCodeExecution(\r\n      options.customCode && options.customCode.allowCodeExecution\r\n    );\r\n\r\n    // Set the log level\r\n    setLogLevel(options.logging && parseInt(options.logging.level));\r\n\r\n    // Set the log file path and name\r\n    if (options.logging && options.logging.dest) {\r\n      enableFileLogging(\r\n        options.logging.dest,\r\n        options.logging.file || 'highcharts-export-server.log'\r\n      );\r\n    }\r\n\r\n    // Check if cache needs to be updated\r\n    await checkCache(options.highcharts || { version: 'latest' });\r\n\r\n    // Init the pool\r\n    await init({\r\n      pool: options.pool || {\r\n        initialWorkers: 1,\r\n        maxWorkers: 1\r\n      },\r\n      puppeteerArgs: options.puppeteer?.args || []\r\n    });\r\n\r\n    // Return updated options\r\n    return options;\r\n  }\r\n};\r\n"],"names":["dotenv","config","defaultConfig","puppeteer","args","value","type","description","highcharts","version","envLink","cdnURL","coreScripts","modules","indicators","scripts","export","infile","instr","options","outfile","constr","defaultHeight","defaultWidth","defaultScale","height","width","scale","globalOptions","themeOptions","batch","customCode","allowCodeExecution","allowFileResources","callback","resources","loadConfig","createConfig","server","enable","cliName","host","port","ssl","force","certPath","rateLimiting","maxRequests","window","delay","trustProxy","skipKey","skipToken","pool","initialWorkers","maxWorkers","workLimit","queueSize","timeoutThreshold","acquireTimeout","reaper","benchmarking","listenToProcessExits","logging","level","file","dest","ui","route","other","noLogo","payload","join","absoluteProps","nestedArgs","createNestedArgs","obj","propChain","Object","keys","forEach","k","includes","entry","substring","toConsole","toFile","pathCreated","levelsDesc","title","color","listeners","key","option","entries","log","newLevel","texts","length","prefix","Date","toString","split","trim","fn","existsSync","mkdirSync","appendFile","concat","error","console","apply","undefined","__dirname","fileURLToPath","URL","url","clearText","text","rule","replacer","replaceAll","fixType","formats","outType","pop","find","t","handleResources","allowedProps","handledResources","correctResources","endsWith","isCorrectJSON","readFileSync","notice","files","propName","map","item","data","parsedData","JSON","parse","stringify","deepCopy","copy","Array","isArray","prototype","hasOwnProperty","call","optionsStringify","allowFunctions","name","startsWith","printUsage","bold","yellow","cycleCategories","categories","descName","green","i","blue","category","toUpperCase","red","toBoolean","wrapAround","replace","rateLimit","app","limitConfig","msg","rateOptions","max","limiter","windowMs","delayMs","handler","request","response","format","json","status","send","message","default","skip","query","access_token","use","async","fetch","requestOptions","Promise","resolve","reject","protocol","https","http","getProtocol","get","res","on","chunk","cachePath","cache","activeManifest","sources","hcVersion","appliedConfig","extractVersion","substr","indexOf","fetchScript","script","proxyAgent","agent","timeout","process","env","statusCode","updateCache","sourcePath","customScripts","allScripts","c","m","proxyHost","proxyPort","HttpsProxyAgent","fetchedModules","all","writeFileSync","checkCache","manifestPath","requestUpdate","manifest","moduleMap","numberOfModules","some","moduleName","newManifest","saveConfigToManifest","cache$1","newVersion","assign","RANDOM_PID","randomBytes","PUPPETEER_DIR","path","minimalArgs","template","fs","browser","newPage","p","setContent","addScriptTag","evaluate","setupHighcharts","err","$eval","element","errorMessage","_displayErrors","innerHTML","close","connected","__basedir","setAsConfig","page","chart","triggerExport","puppeteerExport","injectedResources","clearInjected","dispose","scriptsToRemove","document","getElementsByTagName","stylesToRemove","linksToRemove","remove","exportBench","exportOptions","requestAnimationFrame","displayErrors","debugger","d","svgBench","isSVG","setPageBench","svgTemplate","strInj","setContentBench","resBench","js","push","content","isLocal","cssBench","css","cssImports","match","cssImportPath","addStyleTag","size","chartHeight","baseVal","chartWidth","parseFloat","Highcharts","charts","vpBench","viewportHeight","Math","ceil","viewportWidth","setViewport","deviceScaleFactor","zoomCallback","body","style","zoom","margin","x","y","getBoundingClientRect","trunc","getClipRegion","round","expBenchmark","outerHTML","createSVG","encoding","clip","race","screenshot","setTimeout","Error","createImage","pdf","createPDF","oldCharts","oldChart","destroy","shift","puppeteerArgs","performedExports","exportAttempts","timeSpent","droppedExports","spentAverage","poolConfig","factory","create","id","uuid","s","getTime","browserNewPage","isClosed","workCount","random","validate","workerHandle","logLevel","init","allArgs","tryCount","open","launch","headless","userDataDir","e","createBrowser","killPool","code","exit","Pool","min","createRetryIntervalMillis","createTimeoutMillis","acquireTimeoutMillis","destroyTimeoutMillis","idleTimeoutMillis","reapIntervalMillis","propagateCreateError","eventId","resource","initialResources","acquire","promise","release","destroyed","postWork","fail","getPoolInfo","workStart","result","exportTime","available","borrowed","pending","spareResourceCapacity","pool$1","packageVersion","npm_package_version","serverStartTime","generalOptions","getOptions","mergeConfigOptions","newOptions","mergedOptions","updateDefaultConfig","configObj","customObj","customValue","numEnvVal","el","initOptions","items","startExport","settings","endCallback","svg","initExportSettings","exportAsString","readFile","doStraightInject","doExport","findChartSize","exporting","precision","multiplier","pow","roundNumber","sourceHeight","sourceWidth","chartJson","customCodeOptions","allowCodeExecutionScoped","enabled","optionsName","then","catch","requestId","stringToExport","chartJSON","reversedMime","png","jpeg","gif","requestsCounter","beforeRequest","afterRequest","doCallbacks","callbacks","uniqueId","callResponse","exportHandler","start","hrtime","bigint","measureTime","defaultOptions","headers","connection","remoteAddress","connectionAborted","socket","toLowerCase","b64","dataOptions","noDownload","ipRegEx","info","removeAllListeners","Buffer","from","header","attachment","params","filename","express","disable","cors","storage","multer","memoryStorage","upload","limits","fieldsSize","any","bodyParser","limit","urlencoded","extended","errorHandler","attachErrorHandlers","startServer","serverConfig","httpServer","createServer","listen","cert","fsPromises","posix","httpsServer","NaN","static","bootTime","uptime","floor","highchartsVersion","averageProcessingTime","failedExports","sucessRatio","healthRoute","post","exportRoutes","sendFile","uiRoute","ctoken","HIGHCHARTS_ADMIN_TOKEN","token","vswitchRoute","getExpress","getApp","middlewares","enableRateLimiting","index","mapToNewConfig","oldOptions","propertiesChain","reduce","prop","setOptions","userOptions","configIndex","findIndex","arg","fileName","loadConfigFile","pairArgumentValue","singleExport","batchExport","batchFunctions","pair","initPool","parseInt","logDest","logFile","enableFileLogging"],"mappings":"snBAiBAA,EAAOC,SAIA,MAAMC,EAAgB,CAC3BC,UAAW,CACTC,KAAM,CACJC,MAAO,GACPC,KAAM,WACNC,YAAa,6CAGjBC,WAAY,CACVC,QAAS,CACPJ,MAAO,SACPK,QAAS,qBACTJ,KAAM,SACNC,YAAa,8BAEfI,OAAQ,CACNN,MAAO,+BACPK,QAAS,iBACTJ,KAAM,SACNC,YAAa,6CAEfK,YAAa,CACXF,QAAS,0BACTL,MAAO,CAAC,aAAc,kBAAmB,iBACzCC,KAAM,WACNC,YAAa,qCAEfM,QAAS,CACPH,QAAS,qBACTL,MAAO,CACL,QACA,MACA,QACA,YACA,cACA,uBACA,gBACA,uBACA,eACA,QACA,OACA,mBACA,eACA,cACA,UACA,UACA,WACA,UACA,cACA,YACA,sBACA,SACA,SACA,WACA,YACA,eACA,SACA,eACA,YACA,kBACA,SACA,cACA,mBACA,eACA,cACA,eACA,cACA,cACA,WACA,eACA,WACA,SACA,OACA,WACA,YACA,SACA,qBACA,aACA,WACA,WACA,WACA,WACA,eACA,UACA,kBACA,oBACA,cAEFC,KAAM,WACNC,YAAa,gCAEfO,WAAY,CACVJ,QAAS,wBACTL,MAAO,CAAC,kBACRC,KAAM,WACNC,YAAa,mCAEfQ,QAAS,CACPV,MAAO,CACL,yEAEFC,KAAM,WACNC,YACE,sEAGNS,OAAQ,CACNC,OAAQ,CACNZ,OAAO,EACPC,KAAM,SACNC,YACE,8FAEJW,MAAO,CACLb,OAAO,EACPC,KAAM,SACNC,YACE,iFAEJY,QAAS,CACPd,OAAO,EACPC,KAAM,SACNC,YAAa,oCAEfa,QAAS,CACPf,OAAO,EACPC,KAAM,SACNC,YACE,2FAEJD,KAAM,CACJI,QAAS,sBACTL,MAAO,MACPC,KAAM,SACNC,YACE,sEAEJc,OAAQ,CACNX,QAAS,wBACTL,MAAO,QACPC,KAAM,SACNC,YACE,6EAEJe,cAAe,CACbZ,QAAS,wBACTL,MAAO,IACPC,KAAM,SACNC,YACE,gFAEJgB,aAAc,CACZb,QAAS,uBACTL,MAAO,IACPC,KAAM,SACNC,YACE,+EAEJiB,aAAc,CACZd,QAAS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"}
>>>>>>> enhancement/puppeteer
